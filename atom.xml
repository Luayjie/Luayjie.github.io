<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>风筝上的猫</title>
  
  
  <link href="https://lukme.top/atom.xml" rel="self"/>
  
  <link href="https://lukme.top/"/>
  <updated>2024-12-05T04:38:23.646Z</updated>
  <id>https://lukme.top/</id>
  
  <author>
    <name>Luay🥝</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>11-Prometheus数据远端存储</title>
    <link href="https://lukme.top/posts/ee6702b0.html"/>
    <id>https://lukme.top/posts/ee6702b0.html</id>
    <published>2024-11-25T03:23:03.000Z</published>
    <updated>2024-12-05T04:38:23.646Z</updated>
    
    <content type="html"><![CDATA[<h2 id="VicoriaMetrics概述">VicoriaMetrics概述</h2><p>VictoriaMetrics是一个快速、经济高效且可扩展的监控解决方案和时间序列数据库。</p><p>官网地址:<br><a href="https://victoriametrics.com/">https://victoriametrics.com/</a></p><p>官方文档:<br><a href="https://docs.victoriametrics.com/">https://docs.victoriametrics.com/</a></p><p>GitHub地址:<br><a href="https://github.com/VictoriaMetrics/VictoriaMetrics">https://github.com/VictoriaMetrics/VictoriaMetrics</a></p><p>部署文档:<br><a href="https://docs.victoriametrics.com/quick-start/">https://docs.victoriametrics.com/quick-start/</a></p><h2 id="部署victoriametrics">部署victoriametrics</h2><p><strong>1. 下载victoriametrics</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@elk02 ~]# wget https://github.com/VictoriaMetrics/VictoriaMetrics/releases/download/v1.93.16/victoria-metrics-linux-amd64-v1.93.16.tar.gz</span><br></pre></td></tr></table></figure><p>**2. 解压软件包 **</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@elk02 ~]# tar xf victoria-metrics-linux-amd64-v1.93.16.tar.gz  -C /usr/local/bin/</span><br></pre></td></tr></table></figure><p><strong>3 编写启动脚本</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@elk02 ~]# <span class="built_in">cat</span> &gt; /etc/systemd/system/victoria-metrics.service &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">[Unit]</span></span><br><span class="line"><span class="string">Description=Linux VictoriaMetrics Server</span></span><br><span class="line"><span class="string">Documentation=https://docs.victoriametrics.com/</span></span><br><span class="line"><span class="string">After=network.target</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">ExecStart=/usr/local/bin/victoria-metrics-prod  \</span></span><br><span class="line"><span class="string">   -httpListenAddr=0.0.0.0:8428 \</span></span><br><span class="line"><span class="string">   -storageDataPath=/data/victoria-metrics \</span></span><br><span class="line"><span class="string">   -retentionPeriod=3</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Install]</span></span><br><span class="line"><span class="string">WantedBy=multi-user.target</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">[root@elk02 ~]# systemctl daemon-reload</span><br><span class="line">[root@elk02 ~]# systemctl <span class="built_in">enable</span> --now victoria-metrics.service</span><br><span class="line">[root@elk02 ~]# systemctl status victoria-metrics</span><br></pre></td></tr></table></figure><p><strong>4 检查端口是否存活</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@elk02 ~]# ss -ntl | grep 8428</span><br><span class="line">LISTEN 0      4096              0.0.0.0:8428       0.0.0.0:*        </span><br></pre></td></tr></table></figure><p><strong>5 查看webUI</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://10.0.0.212:8428/</span><br><span class="line">`此时点到WebUI时候搜索`<span class="string">&#x27;node_cpu_seconds_total&#x27;</span>  是没有任何数据的</span><br></pre></td></tr></table></figure><p><img src="https://cos.lukme.top/Pic/image-20241128130653976.png" alt="image-20241128130653976"></p><h2 id="prometheus配置远端存储">prometheus配置远端存储</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@elk02:1 ~]# vim /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml </span><br><span class="line">···</span><br><span class="line"><span class="comment"># 在顶级字段中配置VictoriaMetrics地址</span></span><br><span class="line">remote_write:</span><br><span class="line">  - url: http://10.0.0.212:8428/api/v1/write</span><br><span class="line">  </span><br><span class="line"><span class="comment">#因为之前配置的prometheus的启动脚本指定了数据存储目录，所以这里为了避免冲突，不使用systemd方式启动</span></span><br><span class="line"></span><br><span class="line">1.停止prometheus</span><br><span class="line">systemctl stop prometheus-server.service </span><br><span class="line"></span><br><span class="line">2.进入prometheus安装目录</span><br><span class="line">[root@elk02:2 ~]# <span class="built_in">cd</span> /softwares/prometheus-2.53.2.linux-amd64/</span><br><span class="line"></span><br><span class="line">3.启动prometheus，指定修改过的配置文件（如果配置没有错误，就会去连接http://10.0.0.212:8428）</span><br><span class="line">./prometheus --config.file=<span class="string">&quot;prometheus.yml&quot;</span>  </span><br><span class="line"></span><br><span class="line">4.查看WebUI</span><br><span class="line">http://10.0.0.212:8428/</span><br><span class="line">`此时点到WebUI时候搜索`<span class="string">&#x27;node_cpu_seconds_total&#x27;</span> 发现数据过来了</span><br></pre></td></tr></table></figure><p><img src="https://cos.lukme.top/Pic/image-20241128133415223.png" alt="image-20241128133415223"></p><blockquote><p>温馨提示：</p><p>​    如果此时没有数据接入，就不要进行下面步骤了，不然就一直是错的，出数据就行</p></blockquote><p><strong>4.配置grafana的数据源及URL</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">选择数据源还是prometheus，名字区分下，地址更换下就行了</span><br></pre></td></tr></table></figure><p><img src="https://cos.lukme.top/Pic/image-20241128134037207.png" alt="image-20241128134037207"></p><h2 id="部署参考连接">部署参考连接</h2><p>单点部署参考链接:<br><a href="https://docs.victoriametrics.com/quick-start/#starting-vm-single-from-a-binary">https://docs.victoriametrics.com/quick-start/#starting-vm-single-from-a-binary</a></p><p>集群部署参考链接:<br><a href="https://docs.victoriametrics.com/quick-start/#starting-vm-cluster-from-binaries">https://docs.victoriametrics.com/quick-start/#starting-vm-cluster-from-binaries</a><br><a href="https://docs.victoriametrics.com/cluster-victoriametrics/#architecture-overview">https://docs.victoriametrics.com/cluster-victoriametrics/#architecture-overview</a></p><p>部署集群时软件包要下载对应的集群cluster版本:<br>wget <a href="https://github.com/VictoriaMetrics/VictoriaMetrics/releases/download/v1.93.16/victoria-metrics-linux-amd64-v1.93.16-cluster.tar.gz">https://github.com/VictoriaMetrics/VictoriaMetrics/releases/download/v1.93.16/victoria-metrics-linux-amd64-v1.93.16-cluster.tar.gz</a></p><p>软件包会提供3个程序，该程序对应了集群的3个组件<br>vmstorage:<br>存储原始数据，并返回给定标签过滤器在给定时间范围内的查询数据<br>vminsert:<br>接受摄入的数据，并根据对度量名称及其所有标签的一致散列在vmstorage节点之间传播<br>vmselect:<br>通过从所有配置的vmstorage节点获取所需数据来执行传入查询</p><p><strong>集群部署VictoriaMetrics架构</strong></p><p><img src="https://cos.lukme.top/Pic/VictoriaMetrics-cluster.png" alt="VictoriaMetrics集群架构图解"></p>]]></content>
    
    
    <summary type="html">了解使用 VicoriaMetrics</summary>
    
    
    
    <category term="监控" scheme="https://lukme.top/categories/%E7%9B%91%E6%8E%A7/"/>
    
    <category term="Prometheus" scheme="https://lukme.top/categories/%E7%9B%91%E6%8E%A7/Prometheus/"/>
    
    
    <category term="Prometheus" scheme="https://lukme.top/tags/Prometheus/"/>
    
  </entry>
  
  <entry>
    <title>10-Prometheus的联邦模式</title>
    <link href="https://lukme.top/posts/d10c7e6f.html"/>
    <id>https://lukme.top/posts/d10c7e6f.html</id>
    <published>2024-11-24T03:23:03.000Z</published>
    <updated>2024-12-05T04:17:45.740Z</updated>
    
    <content type="html"><![CDATA[<h2 id="联邦模式配置">联邦模式配置</h2><p><strong>1.prometheus联邦模式架构概述</strong><br>默认情况下，prometheus采集的数据会存储到本地，这意味者prometheus在这种工作模式下，可能会存在单机存储的瓶颈。为了解决prometheus对于数据的采集压力，我们可以采用联邦模式来部署prometheus。</p><blockquote><p>这里 91,92,93 节点分别对应本篇的 211,212,213 节点</p></blockquote><p><img src="https://cos.lukme.top/Pic/prometheus-federate.jpg" alt="联邦模式Prometheus server"></p><p><strong>2.部署Prometheus的集群环境</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">1. 212,213节点部署Prometheus</span><br><span class="line">  略，步骤见01-Prometheus介绍及部署</span><br><span class="line"></span><br><span class="line">`212节点`</span><br><span class="line">2. 212节点配置Prometheus</span><br><span class="line">[root@elk02:1 ~]# vim /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml </span><br><span class="line">···</span><br><span class="line">  - job_name: <span class="string">&#x27;file-sd-discovery-212&#x27;</span></span><br><span class="line">    file_sd_configs:</span><br><span class="line">      - files:</span><br><span class="line">        - /softwares/prometheus-2.53.2.linux-amd64/file-sd.yaml</span><br><span class="line"></span><br><span class="line">3. 编写Prometheus的基于文件服务的发现</span><br><span class="line">[root@elk02:0 ~]# <span class="built_in">cat</span> &gt; /softwares/prometheus-2.53.2.linux-amd64/file-sd.yaml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">- targets:</span></span><br><span class="line"><span class="string">  - 10.0.0.211:9100</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    &quot;tag&quot;: &quot;elk01&quot;</span></span><br><span class="line"><span class="string">    &quot;apps&quot;: &quot;yaml&quot;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">4. 检查Prometheus语法</span><br><span class="line">[root@elk02:0 ~]# /softwares/prometheus-2.53.2.linux-amd64/promtool check config /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml </span><br><span class="line"></span><br><span class="line">5.Prometheus热加载</span><br><span class="line">[root@elk02:0 ~]# curl -X POST http://10.0.0.212:9090/-/reload</span><br><span class="line"></span><br><span class="line">6.访问Prometheus的WebUI</span><br><span class="line">http://10.0.0.212:9090/targets?search=</span><br><span class="line"></span><br><span class="line">`213节点`</span><br><span class="line">1. 213 节点配置Prometheus</span><br><span class="line">[root@elk03:1 ~]# vim /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml </span><br><span class="line">···</span><br><span class="line">  - job_name: <span class="string">&#x27;file-sd-discovery-212&#x27;</span></span><br><span class="line">    file_sd_configs:</span><br><span class="line">      - files:</span><br><span class="line">        - /softwares/prometheus-2.53.2.linux-amd64/file-sd.yaml</span><br><span class="line"></span><br><span class="line">2.编写Prometheus的基于文件服务的发现</span><br><span class="line">[root@elk03:0 ~]# <span class="built_in">cat</span> &gt; /softwares/prometheus-2.53.2.linux-amd64/file-sd.yaml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">- targets:</span></span><br><span class="line"><span class="string">  - 10.0.0.212:9100</span></span><br><span class="line"><span class="string">  - 10.0.0.213:9100</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    &quot;tag&quot;: &quot;elk02/03&quot;</span></span><br><span class="line"><span class="string">    &quot;apps&quot;: &quot;yaml&quot;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">3. 检查Prometheus语法</span><br><span class="line">[root@elk03:0 ~]# /softwares/prometheus-2.53.2.linux-amd64/promtool check config /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml </span><br><span class="line"></span><br><span class="line">4.Prometheus热加载</span><br><span class="line">[root@elk03:0 ~]# curl -X POST http://10.0.0.213:9090/-/reload</span><br><span class="line"></span><br><span class="line">5.访问Prometheus的WebUI</span><br><span class="line">http://10.0.0.213:9090/targets?search=</span><br></pre></td></tr></table></figure><p><strong>3.修改211节点配置</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">1.修改Prometheus配置文件</span><br><span class="line">[root@elk01:0 ~]# vim /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml </span><br><span class="line">···</span><br><span class="line">  - job_name: <span class="string">&quot;prometheus-federate-212&quot;</span></span><br><span class="line">    metrics_path: <span class="string">&quot;/federate&quot;</span></span><br><span class="line">    honor_labels: <span class="literal">true</span></span><br><span class="line">    params:</span><br><span class="line">       <span class="string">&quot;match[]&quot;</span>:</span><br><span class="line">       - <span class="string">&#x27;&#123;job=&quot;promethues&quot;&#125;&#x27;</span></span><br><span class="line">       - <span class="string">&#x27;&#123;__name__=~&quot;job:.*&quot;&#125;&#x27;</span></span><br><span class="line">       - <span class="string">&#x27;&#123;__name__=~&quot;node.*&quot;&#125;&#x27;</span></span><br><span class="line">    static_configs:</span><br><span class="line">    - targets:</span><br><span class="line">        - <span class="string">&quot;10.0.0.212:9090&quot;</span></span><br><span class="line"></span><br><span class="line">  - job_name: <span class="string">&quot;prometheus-federate-213&quot;</span></span><br><span class="line">    metrics_path: <span class="string">&quot;/federate&quot;</span></span><br><span class="line">    honor_labels: <span class="literal">true</span></span><br><span class="line">    params:</span><br><span class="line">       <span class="string">&quot;match[]&quot;</span>:</span><br><span class="line">       - <span class="string">&#x27;&#123;job=&quot;promethues&quot;&#125;&#x27;</span></span><br><span class="line">       - <span class="string">&#x27;&#123;__name__=~&quot;job:.*&quot;&#125;&#x27;</span></span><br><span class="line">       - <span class="string">&#x27;&#123;__name__=~&quot;node.*&quot;&#125;&#x27;</span></span><br><span class="line">    static_configs:</span><br><span class="line">    - targets:</span><br><span class="line">        - <span class="string">&quot;10.0.0.213:9090&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2.检查Prometheus语法</span><br><span class="line">3.Prometheus热加载</span><br></pre></td></tr></table></figure><p><strong>4.验证</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">213上可查询的语法（可自行访问212或者213的Prometheus的WebUI界面找到promQL语法查询放在211节点上验证）</span><br><span class="line">node_cpu_seconds_total&#123;apps=<span class="string">&quot;yaml&quot;</span>, cpu=<span class="string">&quot;0&quot;</span>, job=<span class="string">&quot;file-sd-discovery-213&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">在211上查询是否有结果</span><br></pre></td></tr></table></figure><p><img src="https://cos.lukme.top/Pic/image-20241128112719771.png" alt="image-20241128112719771"></p>]]></content>
    
    
    <summary type="html">使用Prometheus联邦模式缓解数据采集压力</summary>
    
    
    
    <category term="监控" scheme="https://lukme.top/categories/%E7%9B%91%E6%8E%A7/"/>
    
    <category term="Prometheus" scheme="https://lukme.top/categories/%E7%9B%91%E6%8E%A7/Prometheus/"/>
    
    
    <category term="Prometheus" scheme="https://lukme.top/tags/Prometheus/"/>
    
  </entry>
  
  <entry>
    <title>09-Prometheus的服务发现</title>
    <link href="https://lukme.top/posts/86e5bc5f.html"/>
    <id>https://lukme.top/posts/86e5bc5f.html</id>
    <published>2024-11-23T03:23:03.000Z</published>
    <updated>2024-12-05T04:17:45.739Z</updated>
    
    <content type="html"><![CDATA[<h2 id="服务发现的常见类别说明">服务发现的常见类别说明</h2><pre><code>- 静态配置： static_configs每次修改配置后，都需要重新加载配置或者重启服务。- 动态配置每次修改后，无需重新加载配置或者重启服务。常见的动态配置:&lt;file_sd_config&gt;基于文件的服务发现。https://prometheus.io/docs/prometheus/2.53/configuration/configuration/#file_sd_config&lt;consul_sd_config&gt;基于consul的服务发现。https://prometheus.io/docs/prometheus/2.53/configuration/configuration/#consul_sd_config&lt;kubernetes_sd_config&gt;基于K8S实现的服务发现https://prometheus.io/docs/prometheus/2.53/configuration/configuration/#kubernetes_sd_config&lt;dns_sd_config&gt;:基于DNS实现服务发现。https://prometheus.io/docs/prometheus/2.53/configuration/configuration/#dns_sd_config&lt;docker_sd_config&gt;：基于docker engine的服务发现https://prometheus.io/docs/prometheus/2.53/configuration/configuration/#docker_sd_config&lt;http_sd_config&gt;：基于http的服务发现。https://prometheus.io/docs/prometheus/2.53/configuration/configuration/#http_sd_config</code></pre><h2 id="基于文件的服务发现">基于文件的服务发现</h2><p><strong>1.修改Prometheus的配置文件</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@elk01:5 ~]# vim /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml </span><br><span class="line">...</span><br><span class="line">  - job_name: <span class="string">&quot;linux-file-sd-config&quot;</span></span><br><span class="line">    file_sd_configs:</span><br><span class="line">     - files:</span><br><span class="line">        -  /softwares/prometheus-2.53.2.linux-amd64/test.yaml</span><br><span class="line">        -  /softwares/prometheus-2.53.2.linux-amd64/test.json</span><br><span class="line"></span><br><span class="line"><span class="comment">#检查Prometheus语法是否有误</span></span><br><span class="line">[root@elk01:0 ~]# /softwares/prometheus-2.53.2.linux-amd64/promtool check config /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml </span><br><span class="line"></span><br><span class="line"><span class="comment">#Prometheus热加载</span></span><br><span class="line">[root@elk01:0 ~]# curl -X POST http://10.0.0.211:9090/-/reload</span><br><span class="line"></span><br><span class="line">此时访问Prometheus的webui，发现没有显示新的服务</span><br><span class="line">http://10.0.0.211:9090/targets</span><br></pre></td></tr></table></figure><p><strong>2.编辑服务发现文件</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">`yaml格式：`</span><br><span class="line">[root@elk01:5 ~]# vim /softwares/prometheus-2.53.2.linux-amd64/test.yaml</span><br><span class="line">- targets:</span><br><span class="line">    - 10.0.0.213:9100</span><br><span class="line">    - 10.0.0.211:9100</span><br><span class="line">    - 10.0.0.212:3000</span><br><span class="line">    </span><br><span class="line">`json格式`</span><br><span class="line">[root@elk01:5 ~]# vim /softwares/prometheus-2.53.2.linux-amd64/test.json</span><br><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;targets&quot;</span>: [ <span class="string">&quot;10.0.0.211:9100&quot;</span>,<span class="string">&quot;10.0.0.212:9100&quot;</span> ]</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p><strong>3.测试验证</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">文件保存后直接访问webUI，即可发现就可以显示了，不需要热加载Prometheus</span><br><span class="line">http://10.0.0.211:9090/targets</span><br></pre></td></tr></table></figure><p><img src="https://cos.lukme.top/Pic/image-20241127135024922.png" alt="image-20241127135024922"></p><h2 id="基于文件发现和基于consul对比">基于文件发现和基于consul对比</h2><p>基于文件的服务发现是在Prometheus本地基于某个文件读取要监控的节点;</p><p>基于consul服务发现是需要单独部署一套consul集群，Prometheus-server去对应的consul集群获取需要监控的节点。</p><h2 id="部署基于console的服务发现">部署基于console的服务发现</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">1 下载consul</span><br><span class="line">wget https://releases.hashicorp.com/consul/1.19.2/consul_1.19.2_linux_amd64.zip</span><br><span class="line"></span><br><span class="line">2 解压consul</span><br><span class="line">unzip consul_1.19.2_linux_amd64.zip -d /usr/local/bin/</span><br><span class="line"></span><br><span class="line">3 运行consul 集群</span><br><span class="line">服务端211:</span><br><span class="line">consul agent -server -bootstrap -<span class="built_in">bind</span>=10.0.0.211 -data-dir=/data/consul -client=10.0.0.211 -ui</span><br><span class="line"></span><br><span class="line">客户端212:</span><br><span class="line">consul agent  -<span class="built_in">bind</span>=10.0.0.212 -data-dir=/data/consul -client=10.0.0.212 -ui -retry-join=10.0.0.211</span><br><span class="line"></span><br><span class="line">客户端213:</span><br><span class="line">consul agent -server -<span class="built_in">bind</span>=10.0.0.213 -data-dir=/data/consul -client=10.0.0.213 -ui -retry-join=10.0.0.211</span><br><span class="line"></span><br><span class="line">4 查看各节点的监听端口</span><br><span class="line">ss -ntl | grep 8500</span><br><span class="line"></span><br><span class="line">5 访问console服务的WebUI</span><br><span class="line">http://10.0.0.213:8500/ui/dc1/nodes</span><br></pre></td></tr></table></figure><p><img src="https://cos.lukme.top/Pic/image-20241127144212517.png" alt="image-20241127144212517"></p><h2 id="基于consul的服务发现应用">基于consul的服务发现应用</h2><p><strong>1 修改prometheus的配置文件并重新加载配置</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@elk01:1 ~]# vim /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml </span><br><span class="line">  ...</span><br><span class="line">  - job_name: <span class="string">&quot;Linux-consul-seriver-discovery&quot;</span></span><br><span class="line">    <span class="comment"># 配置基于consul的服务发现</span></span><br><span class="line">    consul_sd_configs:</span><br><span class="line">        <span class="comment"># 指定consul的服务器地址，若不指定，则默认值为&quot;localhost:8500&quot;.</span></span><br><span class="line">      - server: 10.0.0.213:8500</span><br><span class="line">      - server: 10.0.0.212:8500</span><br><span class="line">      - server: 10.0.0.211:8500</span><br><span class="line">    relabel_configs:</span><br><span class="line">        <span class="comment"># 匹配consul的源标签字段，表示服务名称</span></span><br><span class="line">      - source_labels: [__meta_consul_service]</span><br><span class="line">        <span class="comment"># 指定源标签的正则表达式，若不定义，默认值为&quot;(.*)&quot;</span></span><br><span class="line">        regex: consul</span><br><span class="line">        <span class="comment"># 执行动作为删除，默认值为&quot;replace&quot;,有效值有多种</span></span><br><span class="line">        <span class="comment">#   https://prometheus.io/docs/prometheus/latest/configuration/configuration/#relabel_action</span></span><br><span class="line">        action: drop</span><br><span class="line">        </span><br><span class="line"><span class="comment">#检查Prometheus语法是否有误</span></span><br><span class="line">[root@elk01:0 ~]# /softwares/prometheus-2.53.2.linux-amd64/promtool check config /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml </span><br><span class="line"></span><br><span class="line"><span class="comment">#Prometheus热加载</span></span><br><span class="line">[root@elk01:0 ~]# curl -X POST http://10.0.0.211:9090/-/reload</span><br></pre></td></tr></table></figure><p><strong>2.被监控节点注册到console集群</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@elk01 ~]# curl -X PUT -d <span class="string">&#x27;&#123;&quot;id&quot;:&quot;elk211&quot;,&quot;name&quot;:&quot;elk01&quot;,&quot;address&quot;:&quot;10.0.0.211&quot;,&quot;port&quot;:9100,&quot;tags&quot;:[&quot;node-exporter&quot;],&quot;checks&quot;: [&#123;&quot;http&quot;:&quot;http://10.0.0.211:9100&quot;,&quot;interval&quot;:&quot;5m&quot;&#125;]&#125;&#x27;</span> http://10.0.0.213:8500/v1/agent/service/register</span><br><span class="line"></span><br><span class="line">[root@elk02 ~]# curl -X PUT -d <span class="string">&#x27;&#123;&quot;id&quot;:&quot;elk212&quot;,&quot;name&quot;:&quot;elk212&quot;,&quot;address&quot;:&quot;10.0.0.212&quot;,&quot;port&quot;:9100,&quot;tags&quot;:[&quot;node-exporter&quot;],&quot;checks&quot;: [&#123;&quot;http&quot;:&quot;http://10.0.0.212:9100&quot;,&quot;interval&quot;:&quot;5m&quot;&#125;]&#125;&#x27;</span> http://10.0.0.213:8500/v1/agent/service/register</span><br><span class="line"></span><br><span class="line">[root@elk03 ~]# curl -X PUT -d <span class="string">&#x27;&#123;&quot;id&quot;:&quot;elk213&quot;,&quot;name&quot;:&quot;elk213&quot;,&quot;address&quot;:&quot;10.0.0.213&quot;,&quot;port&quot;:9100,&quot;tags&quot;:[&quot;node-exporter&quot;],&quot;checks&quot;: [&#123;&quot;http&quot;:&quot;http://10.0.0.213:9100&quot;,&quot;interval&quot;:&quot;5m&quot;&#125;]&#125;&#x27;</span> http://10.0.0.213:8500/v1/agent/service/register</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">`详解`</span><br><span class="line"><span class="string">&quot;id&quot;</span>:<span class="string">&quot;elk211&quot;</span>,<span class="string">&quot;name&quot;</span>:<span class="string">&quot;elk01&quot;</span>,<span class="string">&quot;address&quot;</span>:<span class="string">&quot;10.0.0.211&quot;</span>,<span class="string">&quot;port&quot;</span>:9100 监控211节点，地址和端口</span><br><span class="line">checks<span class="string">&quot;: [&#123;&quot;</span>http<span class="string">&quot;:&quot;</span>http://10.0.0.211:9100<span class="string">&quot;,&quot;</span>interval<span class="string">&quot;:&quot;</span>5m<span class="string">&quot;&#125;]&#125;&#x27;  检查节点，和间隔时间</span></span><br><span class="line"><span class="string">http://10.0.0.213:8500/v1/agent/service/register                注册到console集群（写211,212,213都可以）</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure><p><strong>3.检查consul的WebUI</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://10.0.0.212:8500/ui/dc1/services</span><br></pre></td></tr></table></figure><p><img src="https://cos.lukme.top/Pic/image-20241127153448968.png" alt="image-20241127153448968"></p><p><strong>4 检查Prometheus的WebUI</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://10.0.0.211:9090/targets?search=</span><br></pre></td></tr></table></figure><p><img src="https://cos.lukme.top/Pic/image-20241127153520806.png" alt="image-20241127153520806"></p><p><strong>5.注销节点</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -X PUT http://10.0.0.213:8500/v1/agent/service/deregister/elk213</span><br><span class="line"></span><br><span class="line">elk213  `这里写的是<span class="built_in">id</span>，而不是name`</span><br></pre></td></tr></table></figure><p>注意，也可以使用POSTMAN直接进行如下操作，需要使用PUT方法。<br>PUT <a href="http://10.0.0.213:8500/v1/agent/service/deregister/elk213">http://10.0.0.213:8500/v1/agent/service/deregister/elk213</a></p><h2 id="Prometheus监控console集群">Prometheus监控console集群</h2><p>Prometheus监控consul集群</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">1.下载consul exporter</span><br><span class="line">[root@elk02:5 ~]# wget https://github.com/prometheus/consul_exporter/releases/download/v0.12.1/consul_exporter-0.12.1.linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line">2.解压软件包 </span><br><span class="line">[root@elk02:5 ~]# tar xf consul_exporter-0.12.1.linux-amd64.tar.gz  -C /usr/local/bin/ consul_exporter-0.12.1.linux-amd64/consul_exporter --strip-components=1</span><br><span class="line"></span><br><span class="line">3.启动console exporter </span><br><span class="line">[root@elk02:5 ~]# consul_exporter --consul.server=<span class="string">&quot;http://10.0.0.213:8500&quot;</span> --web.telemetry-path=<span class="string">&quot;/metrics&quot;</span> --web.listen-address=:9107 </span><br><span class="line"></span><br><span class="line">4.访问consul exporter的WebUI</span><br><span class="line">http://10.0.0.212:9107/metrics</span><br><span class="line"></span><br><span class="line">5.向consul注册(或者修改Prometheus配置文件，静态发现需要热加载Prometheus)</span><br><span class="line">[root@elk02:5 ~]# curl -X PUT -d <span class="string">&#x27;&#123;&quot;id&quot;:&quot;elk212-consul&quot;,&quot;name&quot;:&quot;consul-cluster&quot;,&quot;address&quot;:&quot;10.0.0.212&quot;,&quot;port&quot;:9107,&quot;tags&quot;:[&quot;node-exporter&quot;],&quot;checks&quot;: [&#123;&quot;http&quot;:&quot;http://10.0.0.212:9107&quot;,&quot;interval&quot;:&quot;5m&quot;&#125;]&#125;&#x27;</span> http://10.0.0.213:8500/v1/agent/service/register</span><br><span class="line"></span><br><span class="line">6.访问consul的WebUI</span><br><span class="line">http://10.0.0.212:8500/ui/dc1/services/consul-cluster/instances</span><br><span class="line"></span><br><span class="line">7.访问prometheus的WebUI</span><br><span class="line">http://10.0.0.211:9090/targets</span><br><span class="line"></span><br><span class="line">8.grafana导入模板ID </span><br><span class="line">12049</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">Prometheus的服务发现，让你不再需要热加载或者重启Prometheus</summary>
    
    
    
    <category term="监控" scheme="https://lukme.top/categories/%E7%9B%91%E6%8E%A7/"/>
    
    <category term="Prometheus" scheme="https://lukme.top/categories/%E7%9B%91%E6%8E%A7/Prometheus/"/>
    
    
    <category term="Prometheus" scheme="https://lukme.top/tags/Prometheus/"/>
    
  </entry>
  
  <entry>
    <title>08-部署pushgetway和altermanager</title>
    <link href="https://lukme.top/posts/2cdee406.html"/>
    <id>https://lukme.top/posts/2cdee406.html</id>
    <published>2024-11-22T03:23:03.000Z</published>
    <updated>2024-12-05T04:36:34.220Z</updated>
    
    <content type="html"><![CDATA[<h2 id="部署pushgatway">部署pushgatway</h2><p>Prometheus自定义监控组件pushgateway<br>1.下载pushgateway</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@elk02:0 ~]# wget https://github.com/prometheus/pushgateway/releases/download/v1.9.0/pushgateway-1.9.0.linux-amd64.tar.gz</span><br></pre></td></tr></table></figure><p>2.解压软件包</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@elk02:0 ~]# tar xf pushgateway-1.9.0.linux-amd64.tar.gz -C /softwares/</span><br></pre></td></tr></table></figure><p>3.运行pushgateway组件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@elk02:0 ~]# <span class="built_in">cd</span> /softwares/pushgateway-1.9.0.linux-amd64/</span><br><span class="line">[root@elk02:0 ~]# ./pushgateway --web.listen-address=:9091 --web.telemetry-path=<span class="string">&quot;/metrics&quot;</span> </span><br></pre></td></tr></table></figure><p>4.访问pushgetway组件的WebUI</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://10.0.0.212:9091</span><br></pre></td></tr></table></figure><p>5.推送测试数据到pushgateway组件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@elk211 ~]# <span class="built_in">echo</span> <span class="string">&quot;student_online 75&quot;</span> | curl --data-binary @-  http://10.0.0.212:9091/metrics/job/student/instance/10.0.0.211</span><br></pre></td></tr></table></figure><p>6.再次访问pushgetway组件的WebUI</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://10.0.0.92:9091/#</span><br></pre></td></tr></table></figure><p><img src="https://cos.lukme.top/Pic/image-20241124112052347.png" alt="image-20241124112052347"></p><p>7.修改Prometheus的配置文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@elk02 ~]# vim /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml </span><br><span class="line">...</span><br><span class="line">    - job_name: <span class="string">&quot;pushgateway&quot;</span></span><br><span class="line">      <span class="comment"># 用于解决标签的冲突问题，有效值为: true和false，默认值为false</span></span><br><span class="line">      <span class="comment"># 当设置为true时，将保留抓取的标签以忽略服务器自身的标签。说白了会覆盖原有标签。</span></span><br><span class="line">      <span class="comment"># 当设置为false时，则不会覆盖原有标签，而是在标点前加了一个&quot;exported_&quot;前缀。</span></span><br><span class="line">      honor_labels: <span class="literal">true</span></span><br><span class="line">      static_configs:</span><br><span class="line">        - targets: </span><br><span class="line">          - <span class="string">&quot;10.0.0.212:9091&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#检查Prometheus语法是否有误</span></span><br><span class="line">[root@elk01:0 ~]# /softwares/prometheus-2.53.2.linux-amd64/promtool check config /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml </span><br><span class="line"></span><br><span class="line"><span class="comment">#Prometheus热加载</span></span><br><span class="line">[root@elk01:0 ~]# curl -X POST http://10.0.0.211:9090/-/reload</span><br><span class="line"></span><br><span class="line"><span class="comment">#浏览器访问</span></span><br><span class="line">http://10.0.0.211:9090/targets?search=</span><br></pre></td></tr></table></figure><h2 id="Alertmanager环境部署">Alertmanager环境部署</h2><p><strong>1.altermanager概述</strong><br>用于prometheus server的告警功能的组件，目前支持多种告警媒介，包括但不限于邮件告警，钉钉告警，企业微信告警等。</p><p><strong>2.部署alermanager组件</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">1.下载软件包</span><br><span class="line">[root@elk02:1 ~]# wget https://github.com/prometheus/alertmanager/releases/download/v0.27.0/alertmanager-0.27.0.linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line">2. 解压软件包</span><br><span class="line">[root@elk02:1 ~]# tar xf alertmanager-0.27.0.linux-amd64.tar.gz  -C /softwares/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3.修改alermanager的配置文件</span><br><span class="line">[root@elk02:1 ~]# vim /softwares/alertmanager-0.27.0.linux-amd64/alertmanager.yml </span><br><span class="line">global:</span><br><span class="line">  resolve_timeout: 5m</span><br><span class="line">  smtp_from: <span class="string">&#x27;1968554226@qq.com&#x27;</span></span><br><span class="line">  smtp_smarthost: <span class="string">&#x27;smtp.qq.com:465&#x27;</span></span><br><span class="line">  smtp_auth_username: <span class="string">&#x27;1968554226@qq.com&#x27;</span></span><br><span class="line">  smtp_auth_password: <span class="string">&#x27;xwghtaasufprewcb&#x27;</span></span><br><span class="line">  smtp_require_tls: <span class="literal">false</span></span><br><span class="line">  smtp_hello: <span class="string">&#x27;qq.com&#x27;</span></span><br><span class="line">route:</span><br><span class="line">  group_by: [<span class="string">&#x27;alertname&#x27;</span>]</span><br><span class="line">  group_wait: 5s</span><br><span class="line">  group_interval: 5s</span><br><span class="line">  repeat_interval: 30s</span><br><span class="line">  receiver: <span class="string">&#x27;email&#x27;</span></span><br><span class="line">receivers:</span><br><span class="line">- name: <span class="string">&#x27;email&#x27;</span></span><br><span class="line">  email_configs:</span><br><span class="line">  - to: <span class="string">&#x27;3078155561@qq.com&#x27;</span></span><br><span class="line">    send_resolved: <span class="literal">true</span></span><br><span class="line">inhibit_rules:</span><br><span class="line">  - source_match:</span><br><span class="line">      severity: <span class="string">&#x27;critical&#x27;</span></span><br><span class="line">    target_match:</span><br><span class="line">      severity: <span class="string">&#x27;warning&#x27;</span></span><br><span class="line">    equal: [<span class="string">&#x27;alertname&#x27;</span>, <span class="string">&#x27;dev&#x27;</span>, <span class="string">&#x27;instance&#x27;</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">4.启动alermanager</span><br><span class="line">[root@elk02:1 ~]# <span class="built_in">cd</span> /softwares/alertmanager-0.27.0.linux-amd64/</span><br><span class="line">[root@elk02:1 alertmanager-0.27.0.linux-amd64]# ./alertmanager </span><br><span class="line"></span><br><span class="line">5.访问webui</span><br><span class="line">http://10.0.0.212:9093/#/status</span><br></pre></td></tr></table></figure><p><strong>3.修改Prometheus配置文件</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@elk01:0 ~]# vim /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml </span><br><span class="line">···</span><br><span class="line"><span class="comment"># Alertmanager configuration</span></span><br><span class="line">alerting:</span><br><span class="line">  alertmanagers:</span><br><span class="line">    - static_configs:</span><br><span class="line">        - targets:</span><br><span class="line">          - 10.0.0.212:9093</span><br><span class="line"></span><br><span class="line"><span class="comment"># Load rules once and periodically evaluate them according to the global &#x27;evaluation_interval&#x27;.</span></span><br><span class="line">rule_files:</span><br><span class="line">  - <span class="string">&quot;/softwares/prometheus-2.53.2.linux-amd64/status-rules.yaml&quot;</span></span><br></pre></td></tr></table></figure><p><strong>4.修改告警规则</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; /softwares/prometheus-2.53.2.linux-amd64/status-rules.yaml &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">groups:</span></span><br><span class="line"><span class="string">- name: service_status</span></span><br><span class="line"><span class="string">  rules:</span></span><br><span class="line"><span class="string">  - alert: 10.0.0.213:9100节点挂掉啦</span></span><br><span class="line"><span class="string">    expr: up&#123;instance=&quot;10.0.0.213:9100&quot;&#125; == 0</span></span><br><span class="line"><span class="string">    for: 15s</span></span><br><span class="line"><span class="string">    labels:</span></span><br><span class="line"><span class="string">      service: node_exporter</span></span><br><span class="line"><span class="string">      porter: 9100</span></span><br><span class="line"><span class="string">    annotations:</span></span><br><span class="line"><span class="string">      summary: &quot;&#123;&#123; $labels.instance &#125;&#125; 已停止运行超过 15s！&quot;</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><p><strong>5.重新加载Prometheus配置</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#检查Prometheus语法是否有误</span></span><br><span class="line">[root@elk01:0 ~]# /softwares/prometheus-2.53.2.linux-amd64/promtool check config /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml </span><br><span class="line"></span><br><span class="line"><span class="comment">#Prometheus热加载</span></span><br><span class="line">[root@elk01:0 ~]# curl -X POST http://10.0.0.211:9090/-/reload</span><br></pre></td></tr></table></figure><p><img src="https://cos.lukme.top/Pic/image-20241127094655913.png" alt="image-20241127094655913"></p><p>6.验证告警</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">停止elk3的node_exporter服务</span><br><span class="line">[root@elk03:0 ~]# systemctl stop node-exporter.service </span><br><span class="line"></span><br><span class="line">问题未修复没间隔30s发一次邮件（自己可设置）</span><br></pre></td></tr></table></figure><p><img src="https://cos.lukme.top/Pic/image-20241127095054688.png" alt="image-20241127095054688"></p><p>告警邮件</p><p><img src="https://cos.lukme.top/Pic/image-20241127095509855.png" alt="image-20241127095509855"></p><h2 id="修改告警模板">修改告警模板</h2><p><strong>1. 告警模板介绍</strong><br>默认的告警信息界面有些简单，可以借助告警的模板信息，对告警信息进行丰富，需要借助于Alertmanager的模板功能来实现。</p><p>告警模板的使用流程如下:<br>- 分析关键信息<br>- 定制模板内容<br>- Alertmanager加载模板文件<br>- 告警信息使用模板内容属性</p><p>模板文件使用标准Go模板语法，并暴露一些包含时间标签和值的变量。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">标签引用: &#123;&#123; <span class="variable">$label</span>.&lt;label_name&gt; &#125;&#125;</span><br><span class="line">指标样本值引用: &#123;&#123; <span class="variable">$value</span> &#125;&#125;</span><br></pre></td></tr></table></figure><p>为了显式效果，需要了解一些html相关技术，参考链接:<br><a href="https://www.w3school.com.cn/html/index.asp">https://www.w3school.com.cn/html/index.asp</a></p><p><strong>2.自定义模板</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">创建一个模板目录</span><br><span class="line">[root@elk02:0 ~]# <span class="built_in">mkdir</span> /softwares/alertmanager-0.27.0.linux-amd64/tmpl</span><br><span class="line">[root@elk02:0 tmpl]# <span class="built_in">cat</span> email.tmpl</span><br><span class="line">&#123;&#123; define <span class="string">&quot;alert.html&quot;</span> &#125;&#125;</span><br><span class="line">&lt;h1 style=<span class="string">&#x27;color: red;&#x27;</span>&gt;服务异常告警&lt;/h1&gt;</span><br><span class="line">&lt;table border=<span class="string">&quot;1&quot;</span>&gt;</span><br><span class="line">        &lt;<span class="built_in">tr</span>&gt;</span><br><span class="line">                &lt;th&gt;报警项&lt;/th&gt;</span><br><span class="line">                &lt;th&gt;实例&lt;/th&gt;</span><br><span class="line">                &lt;th&gt;报警阀值&lt;/th&gt;</span><br><span class="line">                &lt;th&gt;开始时间&lt;/th&gt;</span><br><span class="line">        &lt;/tr&gt;</span><br><span class="line">        &#123;&#123; range <span class="variable">$i</span>, <span class="variable">$alert</span> := .Alerts &#125;&#125;</span><br><span class="line">                &lt;<span class="built_in">tr</span>&gt;</span><br><span class="line">                        &lt;td&gt;&#123;&#123; index <span class="variable">$alert</span>.Labels <span class="string">&quot;alertname&quot;</span> &#125;&#125;&lt;/td&gt;</span><br><span class="line">                        &lt;td&gt;&#123;&#123; index <span class="variable">$alert</span>.Labels <span class="string">&quot;instance&quot;</span> &#125;&#125;&lt;/td&gt;</span><br><span class="line">                        &lt;td&gt;&#123;&#123; index <span class="variable">$alert</span>.Annotations <span class="string">&quot;value&quot;</span> &#125;&#125;&lt;/td&gt;</span><br><span class="line">                        &lt;td&gt;&#123;&#123; <span class="variable">$alert</span>.StartsAt &#125;&#125;&lt;/td&gt;</span><br><span class="line">                &lt;/tr&gt;</span><br><span class="line">        &#123;&#123; end &#125;&#125;</span><br><span class="line">&lt;/table&gt;</span><br><span class="line">&#123;&#123; end &#125;&#125;</span><br></pre></td></tr></table></figure><p><strong>3.alertmanager引用自定义模板文件</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@elk02:0 temp]# vim /softwares/alertmanager-0.27.0.linux-amd64/alertmanager.yml </span><br><span class="line"><span class="comment">#加载模板</span></span><br><span class="line">templates:</span><br><span class="line">  - <span class="string">&#x27;./tmpl/*.tmpl&#x27;</span></span><br><span class="line">···</span><br><span class="line">receivers:</span><br><span class="line">- name: <span class="string">&#x27;email&#x27;</span></span><br><span class="line">  email_configs:</span><br><span class="line">  - to: <span class="string">&#x27;3078155561@qq.com&#x27;</span></span><br><span class="line">    send_resolved: <span class="literal">true</span></span><br><span class="line">    <span class="comment"># 添加此行，定制邮件的标题，对于&quot;&#123;&#123;&#125;&#125;&quot;属性用于加载其他信息，需要使用单引号括住。</span></span><br><span class="line">    headers: &#123; Subject: <span class="string">&quot;[WARN] 报警邮件&quot;</span> &#125;</span><br><span class="line">    <span class="comment"># 添加此行，调用模板显式邮件正文，对于&quot;&#123;&#125;&quot;不需要使用单引号，否则服务启动不成功。</span></span><br><span class="line">    html: <span class="string">&#x27;&#123;&#123; template &quot;alert.html&quot; . &#125;&#125;&#x27;</span></span><br><span class="line">      <span class="comment">#alter.html是模板里定义的的define，.代表的是加载</span></span><br></pre></td></tr></table></figure><p><strong>4.altermanager语法检查</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@elk02:0 alertmanager-0.27.0.linux-amd64]# <span class="built_in">pwd</span></span><br><span class="line">/softwares/alertmanager-0.27.0.linux-amd64</span><br><span class="line">[root@elk02:0 alertmanager-0.27.0.linux-amd64]# ./amtool check-config ./alertmanager.yml </span><br><span class="line">Checking <span class="string">&#x27;./alertmanager.yml&#x27;</span>  SUCCESS</span><br><span class="line">Found:</span><br><span class="line"> - global config</span><br><span class="line"> - route</span><br><span class="line"> - 1 inhibit rules</span><br><span class="line"> - 1 receivers</span><br><span class="line"> - 1 templates</span><br><span class="line">  SUCCESS</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="comment">#altermanager自带的语法检查</span></span><br></pre></td></tr></table></figure><p><strong>5.重新启动altermanager</strong></p><p>上面我们定制邮件内容中包含阈值的部分，而我们在规则中并没有指定，所以prometheus需要修改以下规则文件。</p><p><strong>6.修改规则文件</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@elk01:1 ~]# vim /softwares/prometheus-2.53.2.linux-amd64/status-rules.yaml </span><br><span class="line">···</span><br><span class="line">    annotations:</span><br><span class="line">      summary: <span class="string">&quot;&#123;&#123; .instance &#125;&#125; 已停止运行超过 15s！&quot;</span></span><br><span class="line">      value: <span class="string">&quot;&#123;&#123; <span class="variable">$value</span> &#125;&#125;&quot;</span></span><br></pre></td></tr></table></figure><p><strong>7.检查Prometheus配置文件</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#检查Prometheus语法是否有误</span></span><br><span class="line">[root@elk01:0 ~]# /softwares/prometheus-2.53.2.linux-amd64/promtool check config /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml </span><br><span class="line"></span><br><span class="line"><span class="comment">#Prometheus热加载</span></span><br><span class="line">[root@elk01:0 ~]# curl -X POST http://10.0.0.211:9090/-/reload</span><br></pre></td></tr></table></figure><p><strong>访问prometheus的WebUI</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">10.0.0.91:9090/rules</span><br></pre></td></tr></table></figure><p><img src="https://cos.lukme.top/Pic/image-20241127104621570.png" alt="image-20241127104621570"></p><p><strong>8.验证测试</strong></p><p>停掉exporter服务</p><p><img src="https://cos.lukme.top/Pic/image-20241127110010277.png" alt="image-20241127110010277"></p><p>依据模板可以将告警和恢复模板分开，使用不同模板通知</p><p>推荐阅读:<br><a href="https://prometheus.io/docs/alerting/latest/configuration/">https://prometheus.io/docs/alerting/latest/configuration/</a></p>]]></content>
    
    
    <summary type="html">部署监控组建pushgetway和告警组件altermanager</summary>
    
    
    
    <category term="监控" scheme="https://lukme.top/categories/%E7%9B%91%E6%8E%A7/"/>
    
    <category term="Prometheus" scheme="https://lukme.top/categories/%E7%9B%91%E6%8E%A7/Prometheus/"/>
    
    
    <category term="Prometheus" scheme="https://lukme.top/tags/Prometheus/"/>
    
  </entry>
  
  <entry>
    <title>07-监控nginx和tomcat</title>
    <link href="https://lukme.top/posts/750619ba.html"/>
    <id>https://lukme.top/posts/750619ba.html</id>
    <published>2024-11-21T03:23:03.000Z</published>
    <updated>2024-12-05T04:40:27.332Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Prometheus监控nginx">Prometheus监控nginx</h2><h3 id="1-编译安装nginx">1 编译安装nginx</h3><p>1.1 安装编译工具</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CentOS：</span><br><span class="line">yum -y install git wget gcc make zlib-devel gcc-c++ libtool openssl openssl-devel</span><br><span class="line"></span><br><span class="line">Ubuntu：</span><br><span class="line">[root@elk93 ~]# apt -y install git wget gcc make zlib1g-dev build-essential libtool openssl libssl-dev</span><br></pre></td></tr></table></figure><p>1.2 克隆nginx-module-vts模块</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> git://github.com/vozlt/nginx-module-vts.git</span><br><span class="line"></span><br><span class="line">如果上述连接不好用，可以执行下面代码:</span><br><span class="line">git <span class="built_in">clone</span> https://gitee.com/jasonyin2020/nginx-module-vts.git</span><br></pre></td></tr></table></figure><p>1.3 下载nginx软件包</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@elk93 ~]# wget https://nginx.org/download/nginx-1.26.2.tar.gz</span><br></pre></td></tr></table></figure><p>1.4 解压nginx</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@elk93 ~]# tar xf nginx-1.26.2.tar.gz </span><br><span class="line"></span><br><span class="line">[root@elk93 ~]# ll nginx-1.26.2</span><br><span class="line">total 860</span><br><span class="line">drwxr-xr-x  8  502 staff   4096 Aug 13 00:39 ./</span><br><span class="line">drwx------ 10 root root    4096 Sep  5 14:35 ../</span><br><span class="line">drwxr-xr-x  6  502 staff   4096 Sep  5 14:35 auto/</span><br><span class="line">-rw-r--r--  1  502 staff 327851 Aug 13 00:39 CHANGES</span><br><span class="line">-rw-r--r--  1  502 staff 501527 Aug 13 00:39 CHANGES.ru</span><br><span class="line">drwxr-xr-x  2  502 staff   4096 Sep  5 14:35 conf/</span><br><span class="line">-rwxr-xr-x  1  502 staff   2611 Aug 12 22:28 configure*</span><br><span class="line">drwxr-xr-x  4  502 staff   4096 Sep  5 14:35 contrib/</span><br><span class="line">drwxr-xr-x  2  502 staff   4096 Sep  5 14:35 html/</span><br><span class="line">-rw-r--r--  1  502 staff   1397 Aug 12 22:28 LICENSE</span><br><span class="line">drwxr-xr-x  2  502 staff   4096 Sep  5 14:35 man/</span><br><span class="line">-rw-r--r--  1  502 staff     49 Aug 12 22:28 README</span><br><span class="line">drwxr-xr-x  9  502 staff   4096 Aug 13 00:39 src/</span><br></pre></td></tr></table></figure><p>1.5 配置nginx</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Centos：</span><br><span class="line"><span class="built_in">cd</span> nginx-1.22.1</span><br><span class="line">./configure --prefix=/softwares/nginx \</span><br><span class="line">--with-http_ssl_module \</span><br><span class="line">--with-http_v2_module \</span><br><span class="line">--with-http_realip_module \</span><br><span class="line">--with-http_stub_status_module \</span><br><span class="line">--without-http_gzip_module \</span><br><span class="line">--with-pcre \</span><br><span class="line">--with-file-aio \</span><br><span class="line">--with-stream \</span><br><span class="line">--with-stream_ssl_module \</span><br><span class="line">--with-stream_realip_module \</span><br><span class="line">--add-module=/root/nginx-module-vts</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Ubuntu:</span><br><span class="line">[root@elk93 ~]# <span class="built_in">cd</span> nginx-1.26.2/</span><br><span class="line">[root@elk93 nginx-1.26.2]# </span><br><span class="line">[root@elk93 nginx-1.26.2]# ./configure --prefix=/softwares/nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --without-http_rewrite_module --with-http_stub_status_module --without-http_gzip_module  --with-file-aio --with-stream --with-stream_ssl_module --with-stream_realip_module --add-module=/root/nginx-module-vts</span><br></pre></td></tr></table></figure><p>1.6 编译并安装nginx</p><pre><code>[root@elk93 nginx-1.26.2]# make -j 2 &amp;&amp; make install</code></pre><p>1.7 修改nginx的配置文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@elk93 nginx-1.26.2]# vim /softwares/nginx/conf/nginx.conf</span><br><span class="line">...</span><br><span class="line">http &#123;</span><br><span class="line">    vhost_traffic_status_zone;</span><br><span class="line">    upstream linux-promethues &#123;</span><br><span class="line">       server 10.0.0.31:9090;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    server &#123;</span><br><span class="line">        ...</span><br><span class="line">        location / &#123;</span><br><span class="line">            root   html;</span><br><span class="line">            <span class="comment"># index  index.html index.htm;</span></span><br><span class="line">            proxy_pass http://linux-promethues;</span><br><span class="line">        &#125;</span><br><span class="line">    location /status &#123;</span><br><span class="line">        vhost_traffic_status_display;</span><br><span class="line">        vhost_traffic_status_display_format html;</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>1.8 检查配置文件语法</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@elk93 nginx-1.26.2]# /softwares/nginx/sbin/nginx -t</span><br><span class="line">nginx: the configuration file /softwares/nginx/conf/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /softwares/nginx/conf/nginx.conf <span class="built_in">test</span> is successful</span><br></pre></td></tr></table></figure><p>1.9 启动nginx</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@elk93 nginx-1.26.2]# /softwares/nginx/sbin/nginx</span><br></pre></td></tr></table></figure><p>1.10 访问nginx的状态页面</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://10.0.0.93/status/format/prometheus</span><br></pre></td></tr></table></figure><h3 id="2-安装nginx-vtx-exporter">2 安装nginx-vtx-exporter</h3><p>2.1 下载nginx-vtx-exporter</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">CentOS：</span><br><span class="line">wget https://github.com/hnlq715/nginx-vts-exporter/releases/download/v0.10.3/nginx-vts-exporter-0.10.3.linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line">温馨提示:</span><br><span class="line">不建议下载更高版本，因为其会提升对GLIC的版本要求，可以通过<span class="string">&quot; strings /lib64/libc.so.6 | grep GLIBC_ &quot;</span>查看默认是2.17版本，若使用较高版本则需要2.32+</span><br><span class="line"></span><br><span class="line">Ubuntu:</span><br><span class="line">wget https://github.com/sysulq/nginx-vts-exporter/releases/download/v0.10.8/nginx-vtx-exporter_0.10.8_linux_amd64.tar.gz</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>2.2 解压软件包到path路径</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@elk92 ~]# tar xf nginx-vtx-exporter_0.10.8_linux_amd64.tar.gz -C /usr/local/bin/ nginx-vtx-exporter</span><br></pre></td></tr></table></figure><p>2.3 运行nginx-vtx-exporter</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@elk92 ~]# nginx-vtx-exporter -nginx.scrape_uri=http://10.0.0.93/status/format/json</span><br></pre></td></tr></table></figure><p>2.4 访问测试</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://10.0.0.92:9913/metrics</span><br><span class="line">http://10.0.0.93/status/format/prometheus</span><br></pre></td></tr></table></figure><h3 id="3-配置prometheus采集nginx数据">3 配置prometheus采集nginx数据</h3><p>3.1 修改配置文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@elk91 ~]# vim /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml </span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">scrape_configs:</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  - job_name: <span class="string">&quot;nginx-exporter&quot;</span></span><br><span class="line">    metrics_path: <span class="string">&quot;/status/format/prometheus&quot;</span></span><br><span class="line">    static_configs:</span><br><span class="line">      - targets:</span><br><span class="line">        - <span class="string">&quot;10.0.0.93:80&quot;</span></span><br><span class="line"></span><br><span class="line">  - job_name: <span class="string">&quot;nginx-vts-exporter&quot;</span></span><br><span class="line">    static_configs:</span><br><span class="line">      - targets:</span><br><span class="line">        - <span class="string">&quot;10.0.0.92:9913&quot;</span></span><br><span class="line">          ...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#检查Prometheus语法是否有误</span></span><br><span class="line"><span class="comment">#Prometheus热加载         （前面文章都有未赘述）</span></span><br></pre></td></tr></table></figure><p>3.2 查看Prometheus的WebUI</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://10.0.0.91:9090/targets?</span><br></pre></td></tr></table></figure><p>3.3 导入grafana模板</p><pre><code>2949</code></pre><h2 id="prometheus监控tomcat">prometheus监控tomcat</h2><p>部署tomcat-exporter<br>1 基于Dockerfile构建tomcat-exporter<br>参考链接：<br>[root@elk93 ~]# git clone <a href="https://gitee.com/jasonyin2020/tomcat-exporter.git">https://gitee.com/jasonyin2020/tomcat-exporter.git</a></p><p>2 编译tomcat exporter镜像</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@elk93 ~]# <span class="built_in">cd</span> tomcat-exporter/</span><br><span class="line">[root@elk93 tomcat-exporter]# ll</span><br><span class="line">total 44</span><br><span class="line">drwxr-xr-x  5 root root 4096 Sep  5 15:02 ./</span><br><span class="line">drwx------ 11 root root 4096 Sep  5 15:02 ../</span><br><span class="line">-rw-r--r--  1 root root   96 Sep  5 15:02 build.sh</span><br><span class="line">-rw-r--r--  1 root root  503 Sep  5 15:02 Dockerfile</span><br><span class="line">drwxr-xr-x  8 root root 4096 Sep  5 15:02 .git/</span><br><span class="line">drwxr-xr-x  2 root root 4096 Sep  5 15:02 libs/</span><br><span class="line">-rw-r--r--  1 root root 3407 Sep  5 15:02 metrics.war</span><br><span class="line">drwxr-xr-x  2 root root 4096 Sep  5 15:02 myapp/</span><br><span class="line">-rw-r--r--  1 root root  191 Sep  5 15:02 README.md</span><br><span class="line">-rw-r--r--  1 root root 7604 Sep  5 15:02 server.xml</span><br><span class="line">[root@elk93 tomcat-exporter]# </span><br><span class="line">[root@elk93 tomcat-exporter]# bash build.sh </span><br></pre></td></tr></table></figure><p>3.运行tomcat exporter镜像</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@elk93 tomcat-exporter]# docker run -p 28080:8080 -d --name tomcat-server registry.cn-hangzhou.aliyuncs.com/yinzhengjie-k8s/tomcat9-app:v1</span><br><span class="line">81926f3514f0531a462d289a022b6dbb12c4d68f2023e9c947ad9d8766d0fb90</span><br></pre></td></tr></table></figure><p>4.访问tomcat应用</p><pre><code>http://10.0.0.93:28080/metrics/http://10.0.0.93:28080/myapp/</code></pre><p>5 配置prometheus监控tomcat应用</p><p>5.1 修改配置文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@elk91 ~]# vim /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml </span><br><span class="line">...</span><br><span class="line">scrape_configs:</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  - job_name: <span class="string">&quot;tomcat-exporter&quot;</span></span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: </span><br><span class="line">        - <span class="string">&quot;10.0.0.93:28080&quot;</span></span><br><span class="line">        </span><br><span class="line"><span class="comment">#检查Prometheus语法是否有误</span></span><br><span class="line"><span class="comment">#Prometheus热加载</span></span><br></pre></td></tr></table></figure><p>5.2 查看Prometheus的WebUI</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://10.0.0.91:9090/targets</span><br></pre></td></tr></table></figure><p>5.3 导入grafana模板</p><pre><code>由于官方的支持并不友好，可以在GitHub自行搜索相应的tomcat监控模板。 参考链接:https://github.com/nlighten/tomcat_exporter/blob/master/dashboard/example.json</code></pre>]]></content>
    
    
    <summary type="html">带你了解使用Prometheus监控ELK集群</summary>
    
    
    
    <category term="监控" scheme="https://lukme.top/categories/%E7%9B%91%E6%8E%A7/"/>
    
    <category term="Prometheus" scheme="https://lukme.top/categories/%E7%9B%91%E6%8E%A7/Prometheus/"/>
    
    
    <category term="Prometheus" scheme="https://lukme.top/tags/Prometheus/"/>
    
  </entry>
  
  <entry>
    <title>06-监控docker容器及数据库</title>
    <link href="https://lukme.top/posts/668ffa27.html"/>
    <id>https://lukme.top/posts/668ffa27.html</id>
    <published>2024-11-20T03:23:03.000Z</published>
    <updated>2024-12-05T04:17:45.736Z</updated>
    
    <content type="html"><![CDATA[<h1>监控docker</h1><p><strong>环境准备</strong></p><table><thead><tr><th>主机名</th><th>WanIP</th><th>角色</th></tr></thead><tbody><tr><td>elk01</td><td>10.0.0.211</td><td>Prometheus服务端</td></tr><tr><td>elk02</td><td>10.0.0.212</td><td>作为docker的被监控端，安装docker，cadvisor</td></tr><tr><td>elk03</td><td>10.0.0.213</td><td>作为docker的被监控端，安装docker，cadvisor</td></tr></tbody></table><p>Prometheus监控docker容器环境<br>1.cadVisor<br>cadVisor是Google公司开源的一款容器监控工具，支持docker，podman容器管理工具的监控。</p><p>GitHub地址:<br><a href="https://github.com/google/cadvisor">https://github.com/google/cadvisor</a></p><p><strong>两台需要机器能够翻墙，因为拉取的是谷歌容器镜像仓库</strong></p><p><strong>我有cadvisor镜像，所有直接导入就行了</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@elk02:~# docker load  &lt; cadvisor-amd64-0.49.1.tar.gz </span><br><span class="line">root@elk03:~# docker load  &lt; cadvisor-amd64-0.49.1.tar.gz </span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">后续考虑提供cadvisor镜像</span><br><span class="line"></span><br><span class="line">docker run \</span><br><span class="line">  -v /:/rootfs:ro \</span><br><span class="line">  -v /var/run:/var/run:ro \</span><br><span class="line">  -v /sys:/sys:ro \</span><br><span class="line">  -v /var/lib/docker/:/var/lib/docker:ro \</span><br><span class="line">  -v /dev/disk/:/dev/disk:ro \</span><br><span class="line">  -p 18080:8080 \</span><br><span class="line">  -d  \</span><br><span class="line">  --name=cadvisor \</span><br><span class="line">  --privileged \</span><br><span class="line">  --device=/dev/kmsg \</span><br><span class="line">  gcr.io/cadvisor/cadvisor-amd64:v0.49.1</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">可以尝使用dockerhub里的cadvisor，镜像换为google/cadvisor:latest  </span><br></pre></td></tr></table></figure><p><strong>访问测试</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@elk03:1 ~]# curl -s 10.0.0.213:18080/metrics | <span class="built_in">head</span> -3</span><br><span class="line"><span class="comment"># HELP cadvisor_version_info A metric with a constant &#x27;1&#x27; value labeled by kernel version, OS version, docker version, cadvisor version &amp; cadvisor revision.</span></span><br><span class="line"><span class="comment"># TYPE cadvisor_version_info gauge</span></span><br><span class="line">cadvisor_version_info&#123;cadvisorRevision=<span class="string">&quot;6f3f25ba&quot;</span>,cadvisorVersion=<span class="string">&quot;v0.49.1&quot;</span>,dockerVersion=<span class="string">&quot;&quot;</span>,kernelVersion=<span class="string">&quot;5.15.0-124-generic&quot;</span>,osVersion=<span class="string">&quot;Alpine Linux v3.18&quot;</span>&#125; 1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">或者浏览器访问</span><br><span class="line">http://10.0.0.212:18080/containers/</span><br></pre></td></tr></table></figure><p><strong>prometheus定义要监控的docker主机</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">1.修改Prometheus的配置文件</span><br><span class="line">[root@elk02:2 ~]# vim /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml </span><br><span class="line">···</span><br><span class="line">   - job_name: <span class="string">&quot;docker&quot;</span></span><br><span class="line">      static_configs:</span><br><span class="line">      - targets:</span><br><span class="line">        - 10.0.0.212:18080</span><br><span class="line">        - 10.0.0.213:18080</span><br><span class="line">        </span><br><span class="line">2.检查Prometheus语法是否有误</span><br><span class="line">[root@elk01:0 ~]# /softwares/prometheus-2.53.2.linux-amd64/promtool check config /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml </span><br><span class="line"></span><br><span class="line">3.重新发起请求（热加载Prometheus）</span><br><span class="line">[root@elk02 ~]# curl -X POST http://10.0.0.211:9090/-/reload</span><br><span class="line"></span><br><span class="line">4.grafana导入对应的模板Id</span><br><span class="line">315</span><br><span class="line">10619</span><br></pre></td></tr></table></figure><h1>监控数据库</h1><h2 id="监控MySQL">监控MySQL</h2><p><strong>mysql本身并不支持metrics接口，因此需要独立部署mysql-exporter来提供metrics接口。</strong></p><p><strong>这里使用docker部署MySQL，使用Prometheus监控MySQL(不再赘述docker安装部署了)</strong></p><p>GitHub地址:</p><p><a href="https://github.com/prometheus/mysqld_exporter/releases/download/v0.16.0/mysqld_exporter-0.16.0.linux-amd64.tar.gz">https://github.com/prometheus/mysqld_exporter/releases/download/v0.16.0/mysqld_exporter-0.16.0.linux-amd64.tar.gz</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">1.下载mysql_exporter</span><br><span class="line">[root@elk02:1 ~]# wget https://github.com/prometheus/mysqld_exporter/releases/download/v0.16.0/mysqld_exporter-0.16.0.linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line">2.拉取镜像</span><br><span class="line">[root@elk02:1 ~]# docker pull mysql:8.3.0-oracle</span><br><span class="line"></span><br><span class="line">3.部署MySQL数据库 </span><br><span class="line">[root@elk02:1 ~]# docker run --name mysql-server -t \</span><br><span class="line">             -e MYSQL_DATABASE=<span class="string">&quot;linux&quot;</span> \</span><br><span class="line">             -e MYSQL_USER=<span class="string">&quot;luay&quot;</span> \</span><br><span class="line">             -e MYSQL_PASSWORD=<span class="string">&quot;123&quot;</span> \</span><br><span class="line">             -e MYSQL_ALLOW_EMPTY_PASSWORD=<span class="string">&quot;yes&quot;</span> \</span><br><span class="line">             --restart unless-stopped \</span><br><span class="line"> --network host \</span><br><span class="line">             -d mysql:8.3.0-oracle \</span><br><span class="line">             --character-set-server=utf8mb4 --collation-server=utf8mb4_bin \</span><br><span class="line">             --default-authentication-plugin=mysql_native_password</span><br><span class="line"></span><br><span class="line">4.查看运行状态</span><br><span class="line">[root@elk02:1 ~]# docker ps -l</span><br><span class="line">CONTAINER ID   IMAGE                COMMAND                  CREATED         STATUS      </span><br><span class="line">a069ae1367ff   mysql:8.3.0-oracle   <span class="string">&quot;docker-entrypoint.s…&quot;</span>   5 seconds ago   Up 4 seconds</span><br><span class="line"></span><br><span class="line">[root@elk02:1 ~]# netstat -lntup|grep 3306</span><br><span class="line">tcp6       0      0 :::3306      :::*      LISTEN      38663/mysqld       </span><br><span class="line">tcp6       0      0 :::33060     :::*      LISTEN      38663/mysqld </span><br><span class="line"></span><br><span class="line">5.解压软件包(后面步骤意思是将mysqld_exporter直接解压到/usr/local/bin/下，跳过一层目录)</span><br><span class="line">tar xf mysqld_exporter-0.15.1.linux-amd64.tar.gz -C /usr/local/bin/ mysqld_exporter-0.15.1.linux-amd64/mysqld_exporter  --strip-components=1</span><br><span class="line"></span><br><span class="line">6.创建MySQL的配置，指定默认的用户名和密码</span><br><span class="line">[root@elk02:1 ~]#  <span class="built_in">cat</span> &gt; /root/.my.cnf &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">[client]</span></span><br><span class="line"><span class="string">user=luay</span></span><br><span class="line"><span class="string">password=123</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">7.运行mysqld-exporter</span><br><span class="line">[root@elk02:1 ~]# mysqld_exporter --mysqld.address=<span class="string">&quot;10.0.0.212:3306&quot;</span> --web.listen-address=:9104 --config.my-cnf=<span class="string">&quot;/root/.my.cnf&quot;</span></span><br><span class="line"></span><br><span class="line">8.访问mysqld-exporter的webui</span><br><span class="line">http://10.0.0.212:9104/metrics</span><br><span class="line"></span><br><span class="line">9.修改Prometheus的配置文件</span><br><span class="line">[root@elk02:2 ~]# vim /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml </span><br><span class="line">···</span><br><span class="line">   - job_name: <span class="string">&quot;mysql&quot;</span></span><br><span class="line">      static_configs:</span><br><span class="line">      - targets:</span><br><span class="line">        - 10.0.0.212:9104</span><br><span class="line">        </span><br><span class="line">10.检查Prometheus语法是否有误</span><br><span class="line">[root@elk01:0 ~]# /softwares/prometheus-2.53.2.linux-amd64/promtool check config /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml </span><br><span class="line"></span><br><span class="line">11.重新发起请求（热加载Prometheus）</span><br><span class="line">[root@elk02 ~]# curl -X POST http://10.0.0.211:9090/-/reload</span><br><span class="line"></span><br><span class="line">12.检查Prometheus的WebUI</span><br><span class="line">http://10.0.0.211:9090/targets</span><br><span class="line"></span><br><span class="line">13.grafana导入对应的模板ID</span><br><span class="line">17320</span><br><span class="line">18949</span><br><span class="line">14057</span><br></pre></td></tr></table></figure><h2 id="监控redis">监控redis</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">1.拉取镜像</span><br><span class="line">[root@elk02:1 ~]# docker pull redis:7.2.5</span><br><span class="line"></span><br><span class="line">2.下载redis_exporter</span><br><span class="line">[root@elk02:1 ~]# wget https://github.com/oliver006/redis_exporter/releases/download/v1.62.0/redis_exporter-v1.62.0.linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line">3.启动redis</span><br><span class="line">[root@elk02:1 ~]# docker run -d --name redis-sever --network host redis:7.2.5 </span><br><span class="line"></span><br><span class="line">[root@elk02:1 ~]# netstat -lntup|grep 6379</span><br><span class="line">tcp     0   0 0.0.0.0:6379     0.0.0.0:*   LISTEN      39212/redis-server</span><br><span class="line">tcp6    0   0 :::6379          :::*        LISTEN      39212/redis-server</span><br><span class="line"></span><br><span class="line">4.解压软件包 </span><br><span class="line">[root@elk02:1 ~]# tar xf redis_exporter-v1.62.0.linux-amd64.tar.gz -C /usr/local/bin/ redis_exporter-v1.62.0.linux-amd64/redis_exporter --strip-components=1</span><br><span class="line"></span><br><span class="line">5.启动redis-exporter</span><br><span class="line">[root@elk92 ~]# redis_exporter -redis.addr redis://10.0.0.212:6379 -web.telemetry-path /metrics -web.listen-address :9121</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看redis_exporter帮助</span></span><br><span class="line">[root@elk02:1 ~]# redis_exporter -h</span><br><span class="line"></span><br><span class="line">5.浏览器访问</span><br><span class="line">10.0.0.212:9121/metrics</span><br></pre></td></tr></table></figure><p><img src="https://cos.lukme.top/Pic/image-20241123135827708.png" alt="image-20241123135827708"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">1.进入redis数据库</span><br><span class="line">[root@elk02:2 ~]# docker <span class="built_in">exec</span> -it redis-sever redis-cli --raw -n 1</span><br><span class="line">127.0.0.1:6379[1]&gt; </span><br><span class="line"></span><br><span class="line">2.写入数据</span><br><span class="line">127.0.0.1:6379[1]&gt; <span class="built_in">set</span> name zhangsan </span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379[1]&gt; get name</span><br><span class="line">zhangsan</span><br><span class="line">127.0.0.1:6379[1]&gt; <span class="built_in">set</span> age 18</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379[1]&gt; get age</span><br><span class="line">18</span><br><span class="line">127.0.0.1:6379[1]&gt; keys *</span><br><span class="line">name</span><br><span class="line">age</span><br><span class="line">127.0.0.1:6379[1]&gt; </span><br></pre></td></tr></table></figure><p><img src="https://cos.lukme.top/Pic/image-20241123140117078.png" alt="image-20241123140117078"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">1.修改Prometheus的配置文件</span><br><span class="line">[root@elk02:2 ~]# vim /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml </span><br><span class="line">···</span><br><span class="line">   - job_name: <span class="string">&quot;redis&quot;</span></span><br><span class="line">      static_configs:</span><br><span class="line">      - targets:</span><br><span class="line">        - 10.0.0.212:9121</span><br><span class="line">        </span><br><span class="line">10.检查Prometheus语法是否有误</span><br><span class="line">[root@elk01:0 ~]# /softwares/prometheus-2.53.2.linux-amd64/promtool check config /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml </span><br><span class="line"></span><br><span class="line">11.重新发起请求（热加载Prometheus）</span><br><span class="line">[root@elk02 ~]# curl -X POST http://10.0.0.211:9090/-/reload</span><br><span class="line"></span><br><span class="line">12.检查Prometheus的WebUI</span><br><span class="line">http://10.0.0.211:9021/targets</span><br><span class="line"></span><br><span class="line">13.grafana导入对应的模板ID</span><br><span class="line">763</span><br><span class="line">14091</span><br><span class="line">14615</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">Prometheus监控docker容器及docker起的数据库</summary>
    
    
    
    <category term="监控" scheme="https://lukme.top/categories/%E7%9B%91%E6%8E%A7/"/>
    
    <category term="Prometheus" scheme="https://lukme.top/categories/%E7%9B%91%E6%8E%A7/Prometheus/"/>
    
    
    <category term="Prometheus" scheme="https://lukme.top/tags/Prometheus/"/>
    
  </entry>
  
  <entry>
    <title>05-监控CPU</title>
    <link href="https://lukme.top/posts/2471ba3e.html"/>
    <id>https://lukme.top/posts/2471ba3e.html</id>
    <published>2024-11-19T03:23:03.000Z</published>
    <updated>2024-12-05T04:17:45.736Z</updated>
    
    <content type="html"><![CDATA[<p><strong>监控CPU的使用情况案例</strong><br>1 统计各个节点CPU的使用率<br>1.1 我们需要先找到CPU相关的KEY</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node_cpu_seconds_total</span><br></pre></td></tr></table></figure><p>1.2 过滤出CPU的空闲时间({mode=‘idle’})和全部CPU的时间(‘{}’)</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node_cpu_seconds_total&#123;<span class="attribute">mode</span>=<span class="string">&#x27;idle&#x27;</span>&#125;</span><br></pre></td></tr></table></figure><p>过滤CPU的空闲时间。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">node_cpu_seconds_total&#123;&#125;</span><br><span class="line">此处的<span class="string">&#x27;&#123;&#125;&#x27;</span>可以不写，因为里面没有任何参数，代表获取CPU的所有状态时间。</span><br></pre></td></tr></table></figure><p>1.3 统计1分钟内CPU的增量时间</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">increase</span><span class="params">(node_cpu_seconds_total&#123;mode=<span class="string">&#x27;idle&#x27;</span>&#125;[<span class="number">1</span>m])</span></span></span><br></pre></td></tr></table></figure><p>统计1分钟内CPU空闲状态的增量。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">increase(node_cpu_seconds_total[1m])</span><br></pre></td></tr></table></figure><p>统计1分钟内CPU所有状态的增量。</p><p>1.4 将结果进行加和统计</p><p>将1分钟内所有CPU空闲时间的增量进行加和计算。</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">sum</span><span class="params">(increase(node_cpu_seconds_total&#123;mode=<span class="string">&#x27;idle&#x27;</span>&#125;[<span class="number">1</span>m])</span></span>)</span><br></pre></td></tr></table></figure><p>将1分钟内所有CPU空闲时间的增量进行加和计算。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sum</span>(increase(node_cpu_seconds_total[1m]))</span><br></pre></td></tr></table></figure><p>1.5 按照不同节点进行分组</p><p>将1分钟内所有CPU空闲时间的增量进行加和计算，并按照机器实例进行分组。</p><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sum(<span class="name">increase</span>(<span class="name">node_cpu_seconds_total</span>&#123;mode=&#x27;idle&#x27;&#125;[<span class="number">1</span>m])) by (<span class="name">instance</span>)</span><br></pre></td></tr></table></figure><p>将1分钟内所有CPU空闲时间的增量进行加和计算，并按照机器实例进行分组。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sum</span>(increase(node_cpu_seconds_total[1m])) by (instance)</span><br></pre></td></tr></table></figure><p>1.6 计算1分钟内CPU空闲时间的百分比</p><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sum(<span class="name">increase</span>(<span class="name">node_cpu_seconds_total</span>&#123;mode=&#x27;idle&#x27;&#125;[<span class="number">1</span>m])) by (<span class="name">instance</span>) / sum(<span class="name">increase</span>(<span class="name">node_cpu_seconds_total</span>[<span class="number">1</span>m])) by (<span class="name">instance</span>)</span><br></pre></td></tr></table></figure><p>1.7 统计1小时内CPU的使用率，计算公式: (1 - CPU空闲时间的百分比) * 100%。</p><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="number">1</span> - sum(<span class="name">increase</span>(<span class="name">node_cpu_seconds_total</span>&#123;mode=&#x27;idle&#x27;&#125;[<span class="number">1</span>h])) by (<span class="name">instance</span>) / sum(<span class="name">increase</span>(<span class="name">node_cpu_seconds_total</span>[<span class="number">1</span>h])) by (<span class="name">instance</span>)) * <span class="number">100</span></span><br></pre></td></tr></table></figure><p>1.8 统计1分钟内CPU的使用率，计算公式: (1 - CPU空闲时间的百分比) * 100%。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(1 - <span class="built_in">sum</span>(increase(node_cpu_seconds_total&#123;mode=<span class="string">&#x27;idle&#x27;</span>&#125;[1m])) by (instance) / <span class="built_in">sum</span>(increase(node_cpu_seconds_total[1m])) by (instance)) * 100</span><br></pre></td></tr></table></figure><p><img src="https://cos.lukme.top/Pic/image-20241123101647287.png" alt="image-20241123101647287"></p><p>2 计算CPU用户态的1分钟内百分比</p><pre><code>sum(increase(node_cpu_seconds_total&#123;mode='user'&#125;[1m])) by (instance) / sum(increase(node_cpu_seconds_total[1m])) by (instance) * 100</code></pre><p>3 计算CPU内核态的1分钟内百分比</p><pre><code>(sum(increase(node_cpu_seconds_total&#123;mode='system'&#125;[1m])) by (instance) / sum(increase(node_cpu_seconds_total[1m])) by (instance)) * 100</code></pre><p>4 计算CPU IO等待时间的1分钟内百分比</p><pre><code>(sum(increase(node_cpu_seconds_total&#123;mode='iowait'&#125;[1m])) by (instance) / sum(increase(node_cpu_seconds_total[1m])) by (instance)) * 100</code></pre><p><strong>以此添加以上2,3,4语法效果如下</strong></p><p><img src="https://cos.lukme.top/Pic/image-20241123101831485.png" alt="image-20241123101831485"></p><p><strong>保存dashboard</strong></p><p><img src="https://cos.lukme.top/Pic/image-20241123102158402.png" alt="image-20241123102158402"></p><p><strong>如何实现类似这样选择效果？</strong></p><p><img src="https://cos.lukme.top/Pic/image-20241123102014754.png" alt="image-20241123102014754"></p><h2 id="grafana的变量定义">grafana的变量定义</h2><p><img src="https://cos.lukme.top/Pic/image-20241123102621980.png" alt="image-20241123102621980"></p><p><img src="https://cos.lukme.top/Pic/image-20241123103440922.png" alt="image-20241123103440922"></p><p><strong>应用保存后再次查看这个dashboard</strong></p><p><img src="https://cos.lukme.top/Pic/image-20241123103551574.png" alt="image-20241123103551574"></p><p>==不过此时我们点击是没有效果的，因为我们之前写的promQL是直接写死的没有使用变量==</p><p><strong>替换如下变量</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(<span class="built_in">sum</span>(increase(node_cpu_seconds_total&#123;mode=<span class="string">&#x27;iowait&#x27;</span>,instance=<span class="string">&quot;<span class="variable">$myhost</span>&quot;</span>&#125;[1m])) by (instance) / <span class="built_in">sum</span>(increase(node_cpu_seconds_total&#123;instance=<span class="string">&quot;<span class="variable">$myhost</span>&quot;</span>&#125;[1m])) by (instance)) * 100</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">(1 - <span class="built_in">sum</span>(increase(node_cpu_seconds_total&#123;mode=<span class="string">&#x27;idle&#x27;</span>,instance=<span class="string">&quot;<span class="variable">$myhost</span>&quot;</span>&#125;[1m])) by (instance) / <span class="built_in">sum</span>(increase(node_cpu_seconds_total&#123;instance=<span class="string">&quot;<span class="variable">$myhost</span>&quot;</span>&#125;[1m])) by (instance)) * 100</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">(<span class="built_in">sum</span>(increase(node_cpu_seconds_total&#123;mode=<span class="string">&#x27;system&#x27;</span>,instance=<span class="string">&quot;<span class="variable">$myhost</span>&quot;</span>&#125;[1m])) by (instance) / <span class="built_in">sum</span>(increase(node_cpu_seconds_total&#123;instance=<span class="string">&quot;<span class="variable">$myhost</span>&quot;</span>&#125;[1m])) by (instance)) * 100</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">sum</span>(increase(node_cpu_seconds_total&#123;mode=<span class="string">&#x27;user&#x27;</span>,instance=<span class="string">&quot;<span class="variable">$myhost</span>&quot;</span>&#125;[1m])) by (instance) / <span class="built_in">sum</span>(increase(node_cpu_seconds_total&#123;instance=<span class="string">&quot;<span class="variable">$myhost</span>&quot;</span>&#125;[1m])) by (instance) * 100</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://cos.lukme.top/Pic/image-20241123104039207.png" alt="image-20241123104039207"></p><p><strong>再次回到dashboard验证点击是否有变化（只验证了一个）</strong></p><p>==很明显变化了==</p><p><img src="D:/PixPin/History/recording.gif" alt="recording"></p><h2 id="自定义变量类型">自定义变量类型</h2><p><img src="https://cos.lukme.top/Pic/image-20241123105342511.png" alt="image-20241123105342511"></p><h2 id="dashboard备份">dashboard备份</h2><p><strong>点击到模板的设置，选择json model</strong></p><p><img src="https://cos.lukme.top/Pic/image-20241123111303063.png" alt="image-20241123111303063"></p>]]></content>
    
    
    <summary type="html">使用Prometheus监控CPU并出图展示</summary>
    
    
    
    <category term="监控" scheme="https://lukme.top/categories/%E7%9B%91%E6%8E%A7/"/>
    
    <category term="Prometheus" scheme="https://lukme.top/categories/%E7%9B%91%E6%8E%A7/Prometheus/"/>
    
    
    <category term="Prometheus" scheme="https://lukme.top/tags/Prometheus/"/>
    
  </entry>
  
  <entry>
    <title>04-监控ELK系列</title>
    <link href="https://lukme.top/posts/750619ba.html"/>
    <id>https://lukme.top/posts/750619ba.html</id>
    <published>2024-11-18T03:23:03.000Z</published>
    <updated>2024-12-05T04:38:04.407Z</updated>
    
    <content type="html"><![CDATA[<h2 id="监控zookeeper集群">监控zookeeper集群</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#1.修改zookeeper配置文件</span></span><br><span class="line">[root@elk03:2 ~]# vim /app/zookeeper/conf/zoo.cfg </span><br><span class="line">···</span><br><span class="line">metricsProvider.className=org.apache.zookeeper.metrics.prometheus.PrometheusMetricsProvider</span><br><span class="line">metricsProvider.httpHost=0.0.0.0</span><br><span class="line">metricsProvider.httpPort=7000</span><br><span class="line">metricsProvider.exportJvmInfo=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#2.同步到其他节点</span></span><br><span class="line">[root@elk01 ~]# scp /app/zookeeper/conf/zoo.cfg root@10.0.0.212:/app/zookeeper/conf/</span><br><span class="line">[root@elk01 ~]# scp /app/zookeeper/conf/zoo.cfg root@10.0.0.213:/app/zookeeper/conf/</span><br><span class="line"></span><br><span class="line"><span class="comment">#3.重启zookeeper集群</span></span><br><span class="line">[root@elk01 ~]# zkServer.sh restart</span><br><span class="line">[root@elk02 ~]# zkServer.sh restart</span><br><span class="line">[root@elk03 ~]# zkServer.sh restart</span><br><span class="line"></span><br><span class="line"><span class="comment">#4.测试访问zookeeper的监听端口是否正常</span></span><br><span class="line">[root@elk03 ~]# curl -s 10.0.0.211:7000/metrics | <span class="built_in">head</span> -3</span><br><span class="line"><span class="comment"># HELP approximate_data_size approximate_data_size</span></span><br><span class="line"><span class="comment"># TYPE approximate_data_size gauge</span></span><br><span class="line">approximate_data_size 15794.0</span><br><span class="line"></span><br><span class="line"><span class="comment">#5.Prometheus配置zookeeper </span></span><br><span class="line">[root@elk03:2 ~]# vim /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml </span><br><span class="line">···</span><br><span class="line">   - job_name: <span class="string">&quot;zookeeper&quot;</span></span><br><span class="line">      static_configs:</span><br><span class="line">      - targets:</span><br><span class="line">        - 10.0.0.211:7000</span><br><span class="line">        - 10.0.0.212:7000</span><br><span class="line">        - 10.0.0.213:7000</span><br><span class="line">        </span><br><span class="line"><span class="comment">#6.检查Prometheus语法是否有误</span></span><br><span class="line">[root@elk01:0 ~]# /softwares/prometheus-2.53.2.linux-amd64/promtool check config /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml </span><br><span class="line"></span><br><span class="line"><span class="comment">#7.重新发起请求（热加载Prometheus）</span></span><br><span class="line">[root@elk211 ~]# curl -X POST http://10.0.0.211:9090/-/reload</span><br><span class="line"></span><br><span class="line"><span class="comment">#8. 浏览器刷新访问,在target里即可看到被监控端</span></span><br><span class="line">10.0.0.211:9090/targets</span><br><span class="line"></span><br><span class="line"><span class="comment">#grafana导入模板ID</span></span><br><span class="line">10465</span><br></pre></td></tr></table></figure><h2 id="监控kafka集群">监控kafka集群</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#官方  https://prometheus.io/docs/instrumenting/exporters/  搜索kafka exporter</span></span><br><span class="line"></span><br><span class="line">1.下载kafka exporter </span><br><span class="line">wget https://github.com/danielqsj/kafka_exporter/releases/download/v1.8.0/kafka_exporter-1.8.0.linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line">2.解压kafka exporter软件包 并做软连接</span><br><span class="line">[root@elk01:3 ~]# tar xf kafka_exporter-1.8.0.linux-amd64.tar.gz -C /app/</span><br><span class="line">[root@elk01:3 ~]# <span class="built_in">ln</span> -s  /app/kafka_exporter-1.8.0.linux-amd64/ /app/kafka-exporter</span><br><span class="line"></span><br><span class="line">3.运行kafka exporter程序暴露kafka集群的指标提供http接口，以供Prometheus识别</span><br><span class="line">[root@elk01:3 ~]# /app/kafka-exporter/kafka_exporter \</span><br><span class="line">--web.listen-address=<span class="string">&quot;:9308&quot;</span> --web.telemetry-path=<span class="string">&quot;/metrics&quot;</span> \</span><br><span class="line">--kafka.server=elk211:9092 --kafka.server=elk212:9092  \</span><br><span class="line">--kafka.server=elk213:9092 --kafka.version=<span class="string">&quot;3.8.0&quot;</span></span><br><span class="line"></span><br><span class="line">4.访问kafka exporter测试</span><br><span class="line">http://10.0.0.213:9308/metrics</span><br><span class="line"></span><br><span class="line">5.Prometheus配置监控kafka</span><br><span class="line">[root@elk03:2 ~]# vim /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml </span><br><span class="line">···</span><br><span class="line">    - job_name: <span class="string">&quot;kafka&quot;</span></span><br><span class="line">      static_configs:</span><br><span class="line">      - targets:</span><br><span class="line">        - 10.0.0.213:9308 </span><br><span class="line">        </span><br><span class="line">6.检测Prometheus语法</span><br><span class="line">7.热加载Prometheus</span><br></pre></td></tr></table></figure><h2 id="监控elasticsearch集群">监控elasticsearch集群</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">1.下载elasticsearch exporter </span><br><span class="line">[root@elk01:3 ~]# wget https://github.com/prometheus-community/elasticsearch_exporter/releases/download/v1.7.0/elasticsearch_exporter-1.7.0.linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line">2.解压软件包</span><br><span class="line">[root@elk01:3 ~]# tar xf elasticsearch_exporter-1.7.0.linux-amd64.tar.gz -C /app</span><br><span class="line"></span><br><span class="line">3.运行elasticsearch exporter暴露ES集群的监控指标为http接口，供给Prometheus抓取数据</span><br><span class="line">[root@elk01:3 ~]# /app/elasticsearch_exporter-1.7.0.linux-amd64/elasticsearch_exporter \</span><br><span class="line">--web.telemetry-path=<span class="string">&quot;/metrics&quot;</span> \</span><br><span class="line">--web.listen-address=:9114 \</span><br><span class="line">--es.all \</span><br><span class="line">--es.uri=<span class="string">&quot;http://elastic:123456@10.0.0.211:9200&quot;</span></span><br><span class="line"></span><br><span class="line">4.访问elasticsearch exporter的WebUI</span><br><span class="line">http://10.0.0.212:9114/metrics</span><br><span class="line"></span><br><span class="line">5.Prometheus配置监控kafka</span><br><span class="line">[root@elk03:2 ~]# vim /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml </span><br><span class="line">···</span><br><span class="line">    - job_name: <span class="string">&quot;es&quot;</span></span><br><span class="line">      static_configs:</span><br><span class="line">      - targets:</span><br><span class="line">        - 10.0.0.213:9114</span><br><span class="line">        </span><br><span class="line">6.检测Prometheus语法</span><br><span class="line">7.热加载Prometheus</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">带你了解使用Prometheus监控ELK集群</summary>
    
    
    
    <category term="监控" scheme="https://lukme.top/categories/%E7%9B%91%E6%8E%A7/"/>
    
    <category term="Prometheus" scheme="https://lukme.top/categories/%E7%9B%91%E6%8E%A7/Prometheus/"/>
    
    
    <category term="Prometheus" scheme="https://lukme.top/tags/Prometheus/"/>
    
  </entry>
  
  <entry>
    <title>03-grafana出图</title>
    <link href="https://lukme.top/posts/c9c8c45c.html"/>
    <id>https://lukme.top/posts/c9c8c45c.html</id>
    <published>2024-11-17T03:23:03.000Z</published>
    <updated>2024-12-05T04:17:45.733Z</updated>
    
    <content type="html"><![CDATA[<h2 id="安装部署grafana">安装部署grafana</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">网址： https://grafana.com/grafana/download/9.5.21?pg=get&amp;plcmt=selfmanaged-box1-cta1</span><br><span class="line"></span><br><span class="line"><span class="comment">#1.安装软件包（选择9版本的最新版）</span></span><br><span class="line">[root@elk01:0 ~]# yum install -y https://dl.grafana.com/enterprise/release/grafana-enterprise-9.5.21-1.x86_64.rpm</span><br><span class="line"></span><br><span class="line"><span class="comment">#2.配置开机自启动</span></span><br><span class="line">[root@elk01:0 ~]# systemctl <span class="built_in">enable</span> --now grafana-server </span><br><span class="line"></span><br><span class="line"><span class="comment">#3.访问grafana的WebUI</span></span><br><span class="line">http://10.0.0.211:3000/login</span><br><span class="line"></span><br><span class="line">首次登录用户名和密码均为admin，登录点击后面直接点击skip跳过修改密码</span><br></pre></td></tr></table></figure><h2 id="配置Prometheus数据源">配置Prometheus数据源</h2><p><img src="https://cos.lukme.top/Pic/image-20241122135329713.png" alt="image-20241122135329713"></p><p><img src="https://cos.lukme.top/Pic/image-20241122135413189.png" alt="image-20241122135413189"></p><p><img src="https://cos.lukme.top/Pic/image-20241122135559291.png" alt="image-20241122135559291"></p><p><strong>下拉找到保存save即可</strong></p><h2 id="导入模板">导入模板</h2><p><a href="https://grafana.com/grafana/dashboards/?search=node">官方dashboard，点击直达，搜索node查看模板</a></p><p>找到合适模板知道模板id导入grafana</p><p><img src="https://cos.lukme.top/Pic/image-20241122135814095.png" alt="image-20241122135814095"></p><p><img src="https://cos.lukme.top/Pic/image-20241122141944442.png" alt="image-20241122141944442"></p><blockquote><p>还有个模板8919仅供参考</p></blockquote><p><strong>CPU压测后数据明显了</strong><img src="https://cos.lukme.top/Pic/image-20241122142250940.png" alt="image-20241122142250940"></p><h2 id="创建自己的模板">创建自己的模板</h2><p><img src="https://cos.lukme.top/Pic/image-20241123094852067.png" alt="image-20241123094852067"></p><p><strong>Add  visualization</strong></p><p><img src="https://cos.lukme.top/Pic/image-20241123095639123.png" alt="image-20241123095639123"></p><p><strong>==创建dashboard以及出图见05-监控CPU使用情况==</strong></p><h2 id="grafana修改模板">grafana修改模板</h2><p><strong>以普罗米模板11277为例</strong></p><p><strong>导入模板</strong></p><p><img src="https://cos.lukme.top/Pic/QQ_1726060882752.png" alt="QQ_1726060882752"></p><p><img src="https://cos.lukme.top/Pic/image-20240911212345131.png" alt="image-20240911212345131"></p><p><img src="https://cos.lukme.top/Pic/image-20240911212434248.png" alt="image-20240911212434248"></p><h2 id="修改模板">修改模板</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">去普罗米里发现新现版prometheus的project改为了job，所有下一步修改变量</span><br></pre></td></tr></table></figure><p><img src="https://cos.lukme.top/Pic/recording.gif" alt="recording"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">将project改为job，并且删掉不支持的project</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">Prometheus接入grafana出图展示</summary>
    
    
    
    <category term="监控" scheme="https://lukme.top/categories/%E7%9B%91%E6%8E%A7/"/>
    
    <category term="Prometheus" scheme="https://lukme.top/categories/%E7%9B%91%E6%8E%A7/Prometheus/"/>
    
    
    <category term="Prometheus" scheme="https://lukme.top/tags/Prometheus/"/>
    
  </entry>
  
  <entry>
    <title>02-prometheus常用函数介绍</title>
    <link href="https://lukme.top/posts/7c8bc612.html"/>
    <id>https://lukme.top/posts/7c8bc612.html</id>
    <published>2024-11-16T03:23:03.000Z</published>
    <updated>2024-12-05T04:17:45.731Z</updated>
    
    <content type="html"><![CDATA[<p><strong>Prometheus常用的函数</strong></p><h2 id="increase">increase</h2><p>increase函数:<br>用来针对counter数据类型，截取其中一段时间总的增量。</p><p>举个例子:</p><p>统计1分钟内，使用标签过滤器查看&quot;10.0.0.211:9100&quot;节点的第0颗CPU，空闲状态使用的总时间增量。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">increase(node_cpu_seconds_total&#123;instance=<span class="string">&quot;10.0.0.211:9100&quot;</span>,mode=<span class="string">&quot;idle&quot;</span>&#125;[1m])</span><br></pre></td></tr></table></figure><p><img src="https://cos.lukme.top/Pic/image-20241122125610115.png" alt="image-20241122125610115"></p><blockquote><p>一分钟内空闲59s，CPU太闲了，压测一波</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#1.安装压力测试工具</span></span><br><span class="line">[root@elk02 ~]# yum install -y stress</span><br><span class="line"></span><br><span class="line"><span class="comment">#2.压力测试CPU</span></span><br><span class="line">[root@elk03:1 ~]# stress --cpu 8 --io 4 --vm 2 --vm-bytes 128M --<span class="built_in">timeout</span> 10m</span><br></pre></td></tr></table></figure><p><img src="https://cos.lukme.top/Pic/image-20241122130528444.png" alt="image-20241122130528444"></p><h2 id="sum">sum</h2><p>sum函数:<br>加和的作用。 （将下方图1所有结果累加，不分组）</p><p>举个例子:</p><p>统计1分钟内，使用标签过滤器查看所有节点的第0颗CPU，空闲状态使用的总时间增量，并将返回结果累加。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sum</span>(increase(node_cpu_seconds_total&#123;mode=<span class="string">&quot;idle&quot;</span>,cpu=<span class="string">&#x27;0&#x27;</span>&#125;[1m]))</span><br></pre></td></tr></table></figure><p><img src="https://cos.lukme.top/Pic/image-20241122131145124.png" alt="image-20241122131145124"></p><p><img src="https://cos.lukme.top/Pic/image-20241122131116002.png" alt="image-20241122131116002"></p><h2 id="by">by</h2><p>by函数:<br>将数据进行分组，类似于MySQL的&quot;GROUP BY&quot;。</p><p>举个例子:</p><p>统计1分钟内，使用标签过滤器查看CPU空闲状态，并将结果进行累加，基于instance进行分组。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sum</span>(increase(node_cpu_seconds_total&#123;mode=<span class="string">&quot;idle&quot;</span>,cpu=<span class="string">&#x27;0&#x27;</span>&#125;[1m])) by (instance)</span><br></pre></td></tr></table></figure><p><img src="https://cos.lukme.top/Pic/image-20241122131653295.png" alt="image-20241122131653295"></p><h2 id="rate">rate</h2><p>rate函数:<br>它的功能是按照设置的时间段，取counter在这个时间段中平均每秒的增量。<br>举个例子:</p><p>统计1分钟内，使用标签过滤器查看&quot;10.0.0.212:9100&quot;节点的第0颗CPU，空闲状态使用的每秒的增量。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rate(node_cpu_seconds_total&#123;instance=<span class="string">&quot;10.0.0.212:9100&quot;</span>,mode=<span class="string">&quot;idle&quot;</span>,cpu=<span class="string">&#x27;0&#x27;</span>&#125;[1m])</span><br></pre></td></tr></table></figure><p><img src="https://cos.lukme.top/Pic/image-20241122132326591.png" alt="image-20241122132326591"></p><p>increase和rate如何选择:<br>(1)对于采集数据频率较低的场景建议使用increase函数，因为使用rate函数可能会出现断点,比如针对硬盘容量监控。<br>(2)对于采集数据频率较高的场景建议使用rate函数，比如针对CPU，内存，网络流量等都是可以基于rate函数来采集等。</p><h2 id="topk">topk</h2><p>topk函数:<br>取前几位的最高值，实际使用的时候一般会用该函数进行瞬时报警，而不是为了观察曲线图。</p><p>举个例子:<br>统计1分钟内，使用标签过滤器查看CPU，所有状态使用的每秒的增量，只查看前3个节点。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">topk(3,rate(node_cpu_seconds_total&#123;mode=<span class="string">&quot;idle&quot;</span>&#125;[1m]))</span><br></pre></td></tr></table></figure><p><img src="https://cos.lukme.top/Pic/image-20241122132911868.png" alt="image-20241122132911868"></p><p><img src="https://cos.lukme.top/Pic/image-20241122133011958.png" alt="image-20241122133011958"></p><h2 id="count">count</h2><p>count函数:<br>把数值符合条件的，输出数目进行累加加和。<br>比如说企业中有100台服务器，如果只有10台服务器CPU使用率高于80%时候是不需要报警的，但是数量超过70台时就需要报警了。</p><p>举个例子:<br>count(tcp_wait_conn &gt; 500):<br>假设tcp_wait_conn是咱们自定义的KEY。<br>若TCP等待数量大于500的机器数量就判断条件为真。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#对统计的结果进行计数。</span></span><br><span class="line"></span><br><span class="line">count(rate(node_cpu_seconds_total&#123;cpu=<span class="string">&quot;0&quot;</span>,mode=<span class="string">&quot;idle&quot;</span>&#125;[1m]))</span><br></pre></td></tr></table></figure><p><img src="https://cos.lukme.top/Pic/image-20241122133509836.png" alt="image-20241122133509836"></p><p>7 其他函数</p><p>推荐阅读:<br><a href="https://prometheus.io/docs/prometheus/latest/querying/functions/">https://prometheus.io/docs/prometheus/latest/querying/functions/</a></p>]]></content>
    
    
    <summary type="html">本篇介绍了Prometheus的常用函数</summary>
    
    
    
    <category term="监控" scheme="https://lukme.top/categories/%E7%9B%91%E6%8E%A7/"/>
    
    <category term="Prometheus" scheme="https://lukme.top/categories/%E7%9B%91%E6%8E%A7/Prometheus/"/>
    
    
    <category term="Prometheus" scheme="https://lukme.top/tags/Prometheus/"/>
    
  </entry>
  
  <entry>
    <title>01-prometheus介绍及部署</title>
    <link href="https://lukme.top/posts/d9386973.html"/>
    <id>https://lukme.top/posts/d9386973.html</id>
    <published>2024-11-15T03:23:03.000Z</published>
    <updated>2024-12-05T03:37:04.631Z</updated>
    
    <content type="html"><![CDATA[<h2 id="prometheus介绍">prometheus介绍</h2><p>1.什么是Prometheus<br>Prometheus是一款监控系统，可以监控传统业务（tomcat，nginx，mysql，redis，elasticsearch），还能够监控云原生业务，比如docker，k8s监控。</p><p><strong>官方链接:</strong><br><a href="https://prometheus.io/docs/introduction/overview/#architecture">https://prometheus.io/docs/introduction/overview/#architecture</a></p><p>推荐阅读:</p><pre><code>云原生CNCF官网:    https://landscape.cncf.io/Prometheus的GitHub地址:    https://github.com/prometheus/prometheusPrometheus的官网地址:    https://prometheus.io/</code></pre><p><img src="https://cos.lukme.top/Pic/image-20241121163541907.png" alt="image-20241121163541907"></p><table><thead><tr><th>主机名</th><th>WanIP</th><th>角色</th></tr></thead><tbody><tr><td>elk01</td><td>10.0.0.211</td><td>Prometheus服务端，安装Prometheus、node exporeter</td></tr><tr><td>elk02</td><td>10.0.0.212</td><td>被监控端，安装node exporeter</td></tr><tr><td>elk03</td><td>10.0.0.213</td><td>被监控端，安装node exporeter</td></tr></tbody></table><blockquote><p>我的环境使用的是之前部署elk的环境，主机名所以都是elk，—无关紧要</p></blockquote><h2 id="二进制部署prometheus">二进制部署prometheus</h2><p><strong>本篇使用的是一键安装方式脚本部署，安装目录都在/software目录下</strong>k8s阶段可以使用云原生方式部署</p><p>**1.下载Prometheus server **</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@elk01 ~]# wget https://github.com/prometheus/prometheus/releases/download/v2.53.3/prometheus-2.53.3.linux-amd64.tar.gz</span><br></pre></td></tr></table></figure><p>**2.解压软件包 **</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@elk01 ~]# tar xf prometheus-2.53.2.linux-amd64.tar.gz -C /app/</span><br><span class="line">[root@elk01 ~]# <span class="built_in">ln</span> -s /app/prometheus-2.53.2.linux-amd64/ /app/prometheus</span><br></pre></td></tr></table></figure><p>**3.启动Prometheus server **</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@elk01 ~]# <span class="built_in">cd</span> /app/prometheus/ &amp;&amp; ./prometheus </span><br></pre></td></tr></table></figure><p><strong>4.访问Prometheus的WebUI</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">10.0.0.211:9090</span><br></pre></td></tr></table></figure><blockquote><p>使用安装脚本一键安装prometheus,软件包放在同级目录的download里</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line">[root@elk01:0 auto_install_prometheus-server]# <span class="built_in">cat</span> install-prometheus-server.sh </span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="comment"># auther: lugaojie</span></span><br><span class="line"><span class="comment"># blog: www.lukme.top</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">VERSION=2.53.2</span><br><span class="line">ARCH=amd64</span><br><span class="line">SOFTWARE=prometheus-<span class="variable">$&#123;VERSION&#125;</span>.linux-<span class="variable">$&#123;ARCH&#125;</span>.tar.gz</span><br><span class="line">URL=https://github.com/prometheus/prometheus/releases/download/v<span class="variable">$&#123;VERSION&#125;</span>/<span class="variable">$&#123;SOFTWARE&#125;</span></span><br><span class="line">DOWNLOAD=./download          <span class="comment">#指定软件下载目录</span></span><br><span class="line">INSTALLDIR=/softwares</span><br><span class="line">BASEDIR=<span class="variable">$&#123;INSTALLDIR&#125;</span>/prometheus-<span class="variable">$&#123;VERSION&#125;</span>.linux-amd64</span><br><span class="line">DATADIR=/data/prometheus</span><br><span class="line">LOGDIR=/var/log/prometheus</span><br><span class="line">HOSTIP=0.0.0.0</span><br><span class="line">PORT=9090</span><br><span class="line">HOSTNAME=`hostname`</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">prepare</span></span>() &#123;</span><br><span class="line"><span class="comment"># 判断目录是否存在，若不存在则创建，-d指定目录，-o可以指定属主，-g指定数组</span></span><br><span class="line">[ -d <span class="variable">$INSTALLDIR</span> ] || install -d  <span class="variable">$&#123;INSTALLDIR&#125;</span></span><br><span class="line">[ -d <span class="variable">$DOWNLOAD</span> ] || install -d <span class="variable">$&#123;DOWNLOAD&#125;</span></span><br><span class="line">[ -d <span class="variable">$DATADIR</span> ] || install -d <span class="variable">$&#123;DATADIR&#125;</span></span><br><span class="line">[ -d <span class="variable">$LOGDIR</span> ] || install -d <span class="variable">$&#123;LOGDIR&#125;</span></span><br><span class="line"></span><br><span class="line">. /etc/os-release</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$ID</span>&quot;</span> == <span class="string">&quot;centos&quot;</span> ];<span class="keyword">then</span></span><br><span class="line"> <span class="comment"># 判断系统是否安装wget</span></span><br><span class="line"> [ -f /usr/bin/wget ] || yum -y install wget</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 判断文件是否存在，若不存在则下载</span></span><br><span class="line">[ -s <span class="variable">$&#123;DOWNLOAD&#125;</span>/<span class="variable">$&#123;SOFTWARE&#125;</span> ] || wget <span class="variable">$URL</span> -O <span class="variable">$&#123;DOWNLOAD&#125;</span>/<span class="variable">$&#123;SOFTWARE&#125;</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">deploy</span></span>() &#123;</span><br><span class="line"><span class="comment"># 检查环境</span></span><br><span class="line">prepare</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解压文件软件包</span></span><br><span class="line">tar xf <span class="variable">$&#123;DOWNLOAD&#125;</span>/<span class="variable">$&#123;SOFTWARE&#125;</span> -C <span class="variable">$&#123;INSTALLDIR&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成启动脚本</span></span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/systemd/system/prometheus-server.service &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">[Unit]</span></span><br><span class="line"><span class="string">Description== Linux  Prometheus Server</span></span><br><span class="line"><span class="string">Documentation=https://prometheus.io/docs/introduction/overview/</span></span><br><span class="line"><span class="string">After=network.target</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">Restart=on-failure</span></span><br><span class="line"><span class="string">ExecStart=/bin/bash -c &quot;$&#123;BASEDIR&#125;/prometheus \</span></span><br><span class="line"><span class="string">  --config.file=$&#123;BASEDIR&#125;/prometheus.yml \</span></span><br><span class="line"><span class="string">      --web.enable-lifecycle \</span></span><br><span class="line"><span class="string">      --storage.tsdb.path=$&#123;DATADIR&#125; \</span></span><br><span class="line"><span class="string">      --storage.tsdb.retention.time=60d  \</span></span><br><span class="line"><span class="string">      --web.listen-address=$&#123;HOSTIP&#125;:$&#123;PORT&#125;  \</span></span><br><span class="line"><span class="string">      --web.max-connections=65535  \</span></span><br><span class="line"><span class="string">      --storage.tsdb.retention.size=512MB \</span></span><br><span class="line"><span class="string">      --query.timeout=10s \</span></span><br><span class="line"><span class="string">      --query.max-concurrency=20 \</span></span><br><span class="line"><span class="string">      --log.level=info \</span></span><br><span class="line"><span class="string">      --log.format=json \</span></span><br><span class="line"><span class="string">      --web.read-timeout=5m &amp;&gt;&gt; $&#123;LOGDIR&#125;/prometheus-server.log&quot;</span></span><br><span class="line"><span class="string">ExecReload=/bin/kill -HUP \$MAINPID</span></span><br><span class="line"><span class="string">LimitNOFILE=65535</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Install]</span></span><br><span class="line"><span class="string">WantedBy=multi-user.target</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  --web.enable-lifecycle                      指定webUI的热加载功能</span></span><br><span class="line"><span class="comment">#  --storage.tsdb.path=$&#123;DATADIR&#125;     指定存储路径</span></span><br><span class="line"><span class="comment">#  --storage.tsdb.retention.time=60d  指定保留数据时间，默认15d</span></span><br><span class="line"><span class="comment">#  --web.max-connections=65535        指定最大连接数</span></span><br><span class="line"><span class="comment">#  --storage.tsdb.retention.size=512MB指定存储块大小，512M滚动一次</span></span><br><span class="line"><span class="comment">#  --log.level=info                                  指定日志级别</span></span><br><span class="line"><span class="comment">#  --log.format=json                              指定日志格式</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将服务设置为开机自启动</span></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl <span class="built_in">enable</span> --now prometheus-server</span><br><span class="line">systemctl status prometheus-server</span><br><span class="line"><span class="built_in">sleep</span> 0.3</span><br><span class="line">ss -ntl | grep <span class="variable">$&#123;PORT&#125;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">delete</span></span>()&#123;</span><br><span class="line">systemctl <span class="built_in">disable</span> --now prometheus-server.service</span><br><span class="line"><span class="built_in">rm</span> -rf /etc/systemd/system/node-exporter.service <span class="variable">$BASEDIR</span> <span class="variable">$DATADIR</span> <span class="variable">$LOGDIR</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">main</span></span>() &#123;</span><br><span class="line"><span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span> </span><br><span class="line"> deploy|i)</span><br><span class="line">   deploy</span><br><span class="line">   <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;HOSTNAME&#125;</span> 的prometheus-server 已经部署成功![successfully]&quot;</span></span><br><span class="line">   ;;</span><br><span class="line"> delete|r)</span><br><span class="line">   delete</span><br><span class="line">   <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;HOSTNAME&#125;</span> 的prometheus-server 已经卸载成功,期待下次使用~&quot;</span></span><br><span class="line">   ;;</span><br><span class="line"> *)</span><br><span class="line">   <span class="built_in">echo</span> <span class="string">&quot;Usage: <span class="variable">$0</span> deploy[i]|delete[r]&quot;</span></span><br><span class="line">   ;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">main <span class="variable">$1</span></span><br></pre></td></tr></table></figure></blockquote><h2 id="部署node-exporter">部署node exporter</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">部署过程同上，官网找到下载</span><br><span class="line"></span><br><span class="line">1.#下载node exporter</span><br><span class="line">[root@elk01 ~]# wget https://github.com/prometheus/node_exporter/releases/download/v1.8.2/node_exporter-1.8.2.linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line">2.#解压至指定目录</span><br><span class="line">[root@elk01 ~]# tar xf node_exporter-1.8.2.linux-amd64.tar.gz -C /app</span><br><span class="line">[root@elk01 ~]# <span class="built_in">ln</span> -s /app/node_exporter-1.8.2.linux-amd64 /app/node_exporter</span><br><span class="line"></span><br><span class="line">4.#启动node_exporter</span><br><span class="line">[root@elk01 ~]# <span class="built_in">cd</span>  /app/node_exporter &amp;&amp; ./node_exporter </span><br><span class="line"></span><br><span class="line">5.#另外两个节点同样安装 node exporter</span><br><span class="line"></span><br><span class="line"><span class="comment">#浏览器访问（这就是暴露出来的接口）</span></span><br><span class="line">http://10.0.0.211:9100/metrics</span><br><span class="line">http://10.0.0.212:9100/metrics</span><br><span class="line">http://10.0.0.213:9100/metrics</span><br></pre></td></tr></table></figure><blockquote><p>一键安装exporter,软件包放在同级目录的download目录下</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">[root@elk01:1 ~]# <span class="built_in">cat</span> auto-install-node-exporter/install-node-exporter.sh </span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="comment"># auther: lugaojie</span></span><br><span class="line"><span class="comment"># blog: https://www.lukme.top</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">VERSION=1.8.2</span><br><span class="line">SOFTWARE=node_exporter-<span class="variable">$&#123;VERSION&#125;</span>.linux-amd64.tar.gz</span><br><span class="line">URL=https://github.com/prometheus/node_exporter/releases/download/v<span class="variable">$&#123;VERSION&#125;</span>/<span class="variable">$&#123;SOFTWARE&#125;</span></span><br><span class="line">DOWNLOAD=./download</span><br><span class="line">INSTALLDIR=/softwares</span><br><span class="line">BASEDIR=<span class="variable">$&#123;INSTALLDIR&#125;</span>/node_exporter-<span class="variable">$&#123;VERSION&#125;</span>.linux-amd64</span><br><span class="line">HOST=<span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line">PORT=9100</span><br><span class="line">hostname=`hostname`</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">prepare</span></span>() &#123;</span><br><span class="line"><span class="comment"># 判断目录是否存在，若不存在则创建</span></span><br><span class="line">[ -d <span class="variable">$INSTALLDIR</span> ] || <span class="built_in">mkdir</span> -pv <span class="variable">$&#123;INSTALLDIR&#125;</span></span><br><span class="line">[ -d <span class="variable">$DOWNLOAD</span> ] || <span class="built_in">mkdir</span> -pv <span class="variable">$&#123;DOWNLOAD&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$ID</span>&quot;</span> == <span class="string">&quot;centos&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">  <span class="comment"># 判断系统是否安装curl</span></span><br><span class="line">  [ -f /usr/bin/wget ] || yum -y install wget</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 判断文件是否存在，若不存在则下载</span></span><br><span class="line">[ -s <span class="variable">$&#123;DOWNLOAD&#125;</span>/<span class="variable">$&#123;SOFTWARE&#125;</span> ] || wget <span class="variable">$URL</span> -O <span class="variable">$&#123;DOWNLOAD&#125;</span>/<span class="variable">$&#123;SOFTWARE&#125;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">install</span></span>() &#123;</span><br><span class="line"><span class="comment"># 检查环境</span></span><br><span class="line">prepare</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解压文件软件包</span></span><br><span class="line">tar xf <span class="variable">$&#123;DOWNLOAD&#125;</span>/<span class="variable">$&#123;SOFTWARE&#125;</span> -C <span class="variable">$&#123;INSTALLDIR&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成启动脚本</span></span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/systemd/system/node-exporter.service &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">[Unit]</span></span><br><span class="line"><span class="string">Description= Linux Node Exporter</span></span><br><span class="line"><span class="string">Documentation=https://prometheus.io/docs/introduction/overview/</span></span><br><span class="line"><span class="string">After=network.target</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">ExecStart=$&#123;BASEDIR&#125;/node_exporter --web.telemetry-path=&quot;/metrics&quot; \</span></span><br><span class="line"><span class="string">--web.listen-address=$&#123;HOST&#125;:$&#123;PORT&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Install]</span></span><br><span class="line"><span class="string">WantedBy=multi-user.target</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 将服务设置为开机自启动</span></span><br><span class="line">  systemctl daemon-reload</span><br><span class="line">  systemctl <span class="built_in">enable</span> --now node-exporter.service</span><br><span class="line">  systemctl status node-exporter.service</span><br><span class="line">  ss -ntl | grep 9100</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">remove</span></span>()&#123;</span><br><span class="line">systemctl <span class="built_in">disable</span> --now node-exporter.service</span><br><span class="line"><span class="built_in">rm</span> -rf /etc/systemd/system/node-exporter.service <span class="variable">$BASEDIR</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">main</span></span>() &#123;</span><br><span class="line"><span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span> </span><br><span class="line"> install|i)</span><br><span class="line">   install</span><br><span class="line">   <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;hostname&#125;</span> 的node-exporter 已经部署成功![successfully]&quot;</span></span><br><span class="line">   ;;</span><br><span class="line"> remove|r)</span><br><span class="line">   remove</span><br><span class="line">   <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;hostname&#125;</span> 的node-exporter 已经卸载成功,期待下次使用~&quot;</span></span><br><span class="line">   ;;</span><br><span class="line"> *)</span><br><span class="line">   <span class="built_in">echo</span> <span class="string">&quot;Usage: <span class="variable">$0</span> install[i]|remove[r]&quot;</span></span><br><span class="line">   ;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">main <span class="variable">$1</span></span><br></pre></td></tr></table></figure></blockquote><h2 id="修改Prometheus文件">修改Prometheus文件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#1.修改配置文件</span></span><br><span class="line">[root@elk01:0 ~]# vim /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml </span><br><span class="line"><span class="comment">#为了测试，拉取间隔时间可以设置为3s</span></span><br><span class="line">scrape_interval: 3s</span><br><span class="line">···末尾加上</span><br><span class="line">    <span class="comment">#job名随便，告诉Prometheus去哪拉取数据     </span></span><br><span class="line">  - job_name: <span class="string">&quot;elk&quot;</span></span><br><span class="line">    static_configs:</span><br><span class="line">      - targets: [<span class="string">&quot;10.0.0.211:9100&quot;</span>,<span class="string">&quot;10.0.0.212:9100&quot;</span>,<span class="string">&quot;10.0.0.213:9100&quot;</span>]</span><br><span class="line">      </span><br><span class="line"><span class="comment">#2.修改配置文件后，对配置文件进行语法检查（Prometheus自带的）</span></span><br><span class="line">[root@elk01:0 ~]# /softwares/prometheus-2.53.2.linux-amd64/promtool check config /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml </span><br><span class="line">Checking /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml</span><br><span class="line"> SUCCESS: /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml is valid prometheus config file syntax</span><br><span class="line"> </span><br><span class="line">`可以设置别名针对检查配置文件命令太长`</span><br><span class="line">[root@elk01:~]# vim /etc/profile</span><br><span class="line"><span class="built_in">alias</span> check=<span class="string">&#x27;/softwares/prometheus-2.53.2.linux-amd64/promtool check config /softwares/prometheus-2.53.2.linux-amd64/prometheus.yml&#x27;</span></span><br><span class="line"></span><br><span class="line">[root@elk01:0 ~]# <span class="built_in">source</span> /etc/profile</span><br><span class="line"></span><br><span class="line"><span class="comment">#3.重新加载配置（热加载）</span></span><br><span class="line">[root@elk211 ~]# curl -X POST http://10.0.0.211:9090/-/reload</span><br><span class="line"></span><br><span class="line"><span class="comment">#4. 浏览器刷新访问,在target里即可看到被监控端</span></span><br><span class="line">10.0.0.211:9090/targets</span><br></pre></td></tr></table></figure><p><img src="https://cos.lukme.top/Pic/image-20241122111710195.png" alt="image-20241122111710195"></p><p><strong>关于metrics</strong></p><p><img src="https://cos.lukme.top/Pic/image-20241122113152787.png" alt="image-20241122113152787"></p><p><strong>过滤数据</strong></p><p><img src="https://cos.lukme.top/Pic/image-20241122114130917.png" alt="image-20241122114130917"></p><h2 id="Prometheus-metrics-类型">Prometheus metrics 类型</h2><ul><li>prometheus metrics type<br>prometheus监控中采集过来的数据统一称为Metrics数据，其并不是代表具体的数据格式，而是一种统计度量计算单位。</li></ul><p>当我们需要为某个系统或者某个服务做监控时，就需要使用到metrics。</p><p>prometheus支持的metrics包括但不限于以下几种数据类型:<br>guage:<br>最简单的度量指标，只是一个简单的返回值，或者叫瞬时状态。<br>比如说统计硬盘，内存等使用情况。<br>couter:<br>就是一个计数器，从数据量0开始累积计算，在理想情况下，只能是永远的增长，不会降低(有特殊情况，比如粉丝量)。<br>比如统计1小时，1天，1周，1一个月的用户访问量，这就是一个累加的操作。<br>histograms:<br>是统计数据的分布情况，比如最小值，最大值，中间值，中位数等，代表的是一种近似百分比估算数值。<br>通过histograms可以分别统计处在一个时间段(1s,2s,5s,10s)内nginx访问用户的响应时间。<br>summary:<br>summary是histograms的扩展类型，主要弥补histograms不足。</p><h2 id="Prometheus的PromQL语法">Prometheus的PromQL语法</h2><p>1 查看某个特定的key<br>node_cpu_seconds_total</p><p>2.查看某个节点的指标</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node_cpu_seconds_total&#123;instance=<span class="string">&quot;10.0.0.211:9100&quot;</span>&#125;</span><br></pre></td></tr></table></figure><p>3 查看某个节点的某刻CPU的某种状态</p><pre><code>node_cpu_seconds_total&#123;instance=&quot;10.0.0.211:9100&quot;,mode=&quot;idle&quot;,cpu=&quot;1&quot;&#125;</code></pre><p>4 查询最近10s内某个节点CPU的某种状态时间</p><pre><code>node_cpu_seconds_total&#123;instance=&quot;10.0.0.211:9100&quot;,mode=&quot;idle&quot;,cpu=&quot;1&quot;&#125;[10s]</code></pre><p>5 统计10s内，使用标签过滤器查看&quot;10.0.0.211:9100&quot;节点的第0颗CPU，非空闲状态使用的总时间</p><pre><code>node_cpu_seconds_total&#123;instance=&quot;10.0.0.211:9100&quot;,mode!=&quot;idle&quot;,cpu=&quot;1&quot;&#125;[10s]</code></pre><p>6 统计10s内，使用标签过滤器查看&quot;10.0.0.211:9100&quot;节点的第0颗CPU，mode名称以字母&quot;i&quot;开头的所有CPU核心。</p><pre><code>node_cpu_seconds_total&#123;instance=&quot;10.0.0.211:9100&quot;,mode=~&quot;i.*&quot;,cpu=&quot;0&quot;&#125;[10s]</code></pre><p>7 统计10s内，使用标签过滤器查看&quot;10.0.0.211:9100&quot;节点的第0颗CPU，mode名称不是以字母&quot;i&quot;开头的所有CPU核心。</p><pre><code>node_cpu_seconds_total&#123;instance=&quot;10.0.0.211:9100&quot;,mode!~&quot;i.*&quot;,cpu=&quot;0&quot;&#125;[10s]</code></pre>]]></content>
    
    
    <summary type="html">本篇介绍了Prometheus的部署及Prometheus的metrics类型和PromQL语法</summary>
    
    
    
    <category term="监控" scheme="https://lukme.top/categories/%E7%9B%91%E6%8E%A7/"/>
    
    <category term="Prometheus" scheme="https://lukme.top/categories/%E7%9B%91%E6%8E%A7/Prometheus/"/>
    
    
    <category term="Prometheus" scheme="https://lukme.top/tags/Prometheus/"/>
    
  </entry>
  
  <entry>
    <title>14.基于kafka的日志收集</title>
    <link href="https://lukme.top/posts/b922fe1d.html"/>
    <id>https://lukme.top/posts/b922fe1d.html</id>
    <published>2024-10-30T02:46:01.000Z</published>
    <updated>2024-10-30T04:02:48.777Z</updated>
    
    <content type="html"><![CDATA[<h2 id="filebeat写入数据到kafka集群">filebeat写入数据到kafka集群</h2><p><strong>1. 创建topic</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@elk01:5 ~]# kafka-topics.sh --bootstrap-server 10.0.0.212:9092 --topic linux-study --partitions 3 --replication-factor 2 --create</span><br><span class="line">Created topic linux-study.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@elk01:5 ~]# kafka-topics.sh --bootstrap-server 10.0.0.212:9092 --topic linux-study --describe</span><br></pre></td></tr></table></figure><p><img src="https://cos.lukme.top/Pic/image-20241030003043850.png" alt="image-20241030003043850"></p><p><strong>2. filebeat写入数据到kafka</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@elk01:0 ~]# <span class="built_in">cat</span> /etc/filebeat/20-filebeat-to-kafka.yaml </span><br><span class="line">filebeat.inputs:</span><br><span class="line">  - <span class="built_in">type</span>: filestream</span><br><span class="line">    paths:</span><br><span class="line">      - /opt/access.log*</span><br><span class="line">  </span><br><span class="line">output.kafka:</span><br><span class="line">  <span class="comment"># 指定kafka集群地址</span></span><br><span class="line">  hosts: [<span class="string">&quot;10.0.0.211:9092&quot;</span>, <span class="string">&quot;10.0.0.212:9092&quot;</span>, <span class="string">&quot;10.0.0.213:9092&quot;</span>]</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 指定写入的topic地址</span></span><br><span class="line">  topic: <span class="string">&#x27;linux-study&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#启动filebeat实例</span></span><br><span class="line">[root@elk01:0 ~]# filebeat -e -c /etc/filebeat/20-filebeat-to-kafka.yaml</span><br></pre></td></tr></table></figure><p><strong>3. kafka节点测试</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@elk01:0 ~]#  kafka-console-consumer.sh --bootstrap-server 10.0.0.212:9092 --topic linux-study --from-beginning --group filebeat01</span><br></pre></td></tr></table></figure><p><img src="https://cos.lukme.top/Pic/image-20241030004427518.png" alt="image-20241030004427518"></p><h2 id="logstash从kafka集群读取数据">logstash从kafka集群读取数据</h2><p>**1.编写logstash实例 **</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@elk01:0 ~]# <span class="built_in">cat</span> /etc/logstash/conf.d/17-kafka-to-logstash.conf</span><br><span class="line">input &#123;</span><br><span class="line">  kafka &#123;</span><br><span class="line">    <span class="comment"># 指定kafka集群的地址</span></span><br><span class="line">    bootstrap_servers =&gt; <span class="string">&quot;10.0.0.211:9092,10.0.0.212:9092,10.0.0.213:9092&quot;</span></span><br><span class="line">    <span class="comment"># 指定topic列表</span></span><br><span class="line">    topics =&gt; [<span class="string">&quot;linux-study&quot;</span>]</span><br><span class="line">    <span class="comment"># 指定消费者组  (每次启动logstash，都需要换个组，因为同一个组的采集了不会再次采集，你也可以不用这个)</span></span><br><span class="line">    group_id =&gt; [<span class="string">&quot;filebeat01&quot;</span>]</span><br><span class="line">    <span class="comment"># 指定从offset开始读取数据的位置，earliest表示最早的数据开始读，latest表示从最新的位置读取。</span></span><br><span class="line">    auto_offset_reset =&gt; <span class="string">&quot;earliest&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  stdout &#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment"># elasticsearch&#123;</span></span><br><span class="line"> <span class="comment">#    hosts =&gt; [&quot;10.0.0.91:9200&quot;,&quot;10.0.0.92:9200&quot;,&quot;10.0.0.93:9200&quot;]</span></span><br><span class="line"> <span class="comment">#    index =&gt; &quot;oldboyedu-kafka-elk-%&#123;+yyyy.MM.dd&#125;&quot;</span></span><br><span class="line"> <span class="comment">#    user =&gt; &quot;elastic&quot;</span></span><br><span class="line"> <span class="comment">#    password =&gt; &quot;123456&quot;</span></span><br><span class="line"> <span class="comment">#  &#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>2. 启动logstash实例</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@elk01:0 ~]# logstash -rf /etc/logstash/conf.d/17-kafka-to-logstash.conf </span><br><span class="line"></span><br><span class="line">      <span class="string">&quot;@version&quot;</span> =&gt; <span class="string">&quot;1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;@timestamp&quot;</span> =&gt; 2024-10-29T17:05:27.448Z,</span><br><span class="line">       <span class="string">&quot;message&quot;</span> =&gt; <span class="string">&quot;&#123;\&quot;@timestamp\&quot;:\&quot;2024-10-29T16:39:24.279Z\&quot;,\&quot;@metadata\&quot;:&#123;\&quot;beat\&quot;:\&quot;filebeat\&quot;,\&quot;type\&quot;:\&quot;_doc\&quot;,\&quot;version\&quot;:\&quot;7.17.23\&quot;&#125;,\&quot;log\&quot;:&#123;\&quot;offset\&quot;:20478,\&quot;file\&quot;:&#123;\&quot;path\&quot;:\&quot;/opt/access.log\&quot;&#125;&#125;,\&quot;message\&quot;:\&quot;109.110.162.51 - - [04/Oct/2024:10:00:41 +0800] \\\&quot;GET / HTTP/1.1\\\&quot; 304 0 \\\&quot;-\\\&quot; \\\&quot;Mozilla/5.0 (iPhone; CPU iPhone OS 16_6 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.6 Mobile/15E148 Safari/604.1 Edg/129.0.0.0\\\&quot;\&quot;,\&quot;input\&quot;:&#123;\&quot;type\&quot;:\&quot;filestream\&quot;&#125;,\&quot;ecs\&quot;:&#123;\&quot;version\&quot;:\&quot;1.12.0\&quot;&#125;,\&quot;host\&quot;:&#123;\&quot;name\&quot;:\&quot;elk01\&quot;&#125;,\&quot;agent\&quot;:&#123;\&quot;id\&quot;:\&quot;0f020f85-7619-4e85-83ae-346d91b5ca57\&quot;,\&quot;name\&quot;:\&quot;elk01\&quot;,\&quot;type\&quot;:\&quot;filebeat\&quot;,\&quot;version\&quot;:\&quot;7.17.23\&quot;,\&quot;hostname\&quot;:\&quot;elk01\&quot;,\&quot;ephemeral_id\&quot;:\&quot;ed96638d-32ee-4ee0-afbb-504643c3d52a\&quot;&#125;&#125;&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cos.lukme.top/Pic/image-20241030010834508.png" alt="image-20241030010834508"></p><p><strong>3. 优化logstash</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">[root@elk01:0 ~]# <span class="built_in">cat</span> /etc/logstash/conf.d/17-kafka-to-logstash.conf</span><br><span class="line">input &#123;</span><br><span class="line">  kafka &#123;</span><br><span class="line">    <span class="comment"># 指定kafka集群的地址</span></span><br><span class="line">    bootstrap_servers =&gt; <span class="string">&quot;10.0.0.211:9092,10.0.0.212:9092,10.0.0.213:9092&quot;</span></span><br><span class="line">    <span class="comment"># 指定topic列表</span></span><br><span class="line">    topics =&gt; [<span class="string">&quot;linux-study&quot;</span>]</span><br><span class="line">    <span class="comment"># 指定消费者组  (每次启动logstash，都需要换个组，因为同一个组的采集了不会再次采集，你也可以不用这个)</span></span><br><span class="line">    group_id =&gt; [<span class="string">&quot;filebeat01&quot;</span>]</span><br><span class="line">    <span class="comment"># 指定从offset开始读取数据的位置，earliest表示最早的数据开始读，latest表示从最新的位置读取。</span></span><br><span class="line">    auto_offset_reset =&gt; <span class="string">&quot;earliest&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#对message字段进行json格式化</span></span><br><span class="line">filter &#123;</span><br><span class="line">  json &#123;</span><br><span class="line">    <span class="built_in">source</span> =&gt; <span class="string">&quot;message&quot;</span></span><br><span class="line">    <span class="comment">#移除不需要的字段，不然像下面一样出现很多没有价值的字段</span></span><br><span class="line">   <span class="comment"># remove_field =&gt; [ &quot;input&quot;,&quot;host&quot;,&quot;agent&quot;,&quot;@version&quot;,&quot;log&quot;, &quot;ecs&quot; ]</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  stdout &#123;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#输出结果展示</span></span><br><span class="line"></span><br><span class="line">         <span class="string">&quot;agent&quot;</span> =&gt; &#123;</span><br><span class="line">                <span class="string">&quot;name&quot;</span> =&gt; <span class="string">&quot;elk01&quot;</span>,</span><br><span class="line">                <span class="string">&quot;type&quot;</span> =&gt; <span class="string">&quot;filebeat&quot;</span>,</span><br><span class="line">            <span class="string">&quot;hostname&quot;</span> =&gt; <span class="string">&quot;elk01&quot;</span>,</span><br><span class="line">             <span class="string">&quot;version&quot;</span> =&gt; <span class="string">&quot;7.17.23&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ephemeral_id&quot;</span> =&gt; <span class="string">&quot;9a1e6795-8fe4-476b-ba6b-9d91b41f282c&quot;</span>,</span><br><span class="line">                  <span class="string">&quot;id&quot;</span> =&gt; <span class="string">&quot;1b86f9d4-c41a-4c30-8b3c-c921ed07d026&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">         <span class="string">&quot;input&quot;</span> =&gt; &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span> =&gt; <span class="string">&quot;filestream&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">      <span class="string">&quot;@version&quot;</span> =&gt; <span class="string">&quot;1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;@timestamp&quot;</span> =&gt; 2024-10-29T16:40:45.156Z,</span><br><span class="line">          <span class="string">&quot;host&quot;</span> =&gt; &#123;</span><br><span class="line">        <span class="string">&quot;name&quot;</span> =&gt; <span class="string">&quot;elk01&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">           <span class="string">&quot;ecs&quot;</span> =&gt; &#123;</span><br><span class="line">        <span class="string">&quot;version&quot;</span> =&gt; <span class="string">&quot;1.12.0&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">           <span class="string">&quot;log&quot;</span> =&gt; &#123;</span><br><span class="line">        <span class="string">&quot;offset&quot;</span> =&gt; 27088,</span><br><span class="line">          <span class="string">&quot;file&quot;</span> =&gt; &#123;</span><br><span class="line">            <span class="string">&quot;path&quot;</span> =&gt; <span class="string">&quot;/opt/access.log&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="comment">#移除字段后展示</span></span><br><span class="line">    <span class="string">&quot;@timestamp&quot;</span> =&gt; 2024-10-29T16:40:45.156Z,</span><br><span class="line">       <span class="string">&quot;message&quot;</span> =&gt; <span class="string">&quot;150.109.253.34 - - [04/Oct/2024:10:01:27 +0800] \&quot;GET /app HTTP/1.1\&quot; 404 197 \&quot;-\&quot; \&quot;Mozilla/5.0 (Linux; Android 8.0.0; SM-G955U Build/R16NW) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/116.0.0.0 Mobile Safari/537.36 Edg/129.0.0.0\&quot;&quot;</span></span><br></pre></td></tr></table></figure><p><strong>4. 正常操作优化,并输出到es集群</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">[root@elk01:0 ~]# <span class="built_in">cat</span> /etc/logstash/conf.d/17-kafka-to-logstash.conf</span><br><span class="line">input &#123;</span><br><span class="line">  kafka &#123;</span><br><span class="line">    <span class="comment"># 指定kafka集群的地址</span></span><br><span class="line">    bootstrap_servers =&gt; <span class="string">&quot;10.0.0.211:9092,10.0.0.212:9092,10.0.0.213:9092&quot;</span></span><br><span class="line">    <span class="comment"># 指定topic列表</span></span><br><span class="line">    topics =&gt; [<span class="string">&quot;linux-study&quot;</span>]</span><br><span class="line">    <span class="comment"># 指定消费者组  (每次启动logstash，都需要换个组，因为同一个组的采集了不会再次采集，你也可以不用这个)</span></span><br><span class="line">    group_id =&gt; [<span class="string">&quot;filebeat01&quot;</span>]</span><br><span class="line">    <span class="comment"># 指定从offset开始读取数据的位置，earliest表示最早的数据开始读，latest表示从最新的位置读取。</span></span><br><span class="line">    auto_offset_reset =&gt; <span class="string">&quot;earliest&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#对message字段进行json格式化</span></span><br><span class="line">filter &#123;</span><br><span class="line">  json &#123;</span><br><span class="line">    <span class="built_in">source</span> =&gt; <span class="string">&quot;message&quot;</span></span><br><span class="line">    <span class="comment">#移除不需要的字段</span></span><br><span class="line">    remove_field =&gt; [ <span class="string">&quot;input&quot;</span>,<span class="string">&quot;host&quot;</span>,<span class="string">&quot;agent&quot;</span>,<span class="string">&quot;@version&quot;</span>,<span class="string">&quot;log&quot;</span>, <span class="string">&quot;ecs&quot;</span> ]</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment"># 基于正则匹配任意文本，grok内置了120种匹配模式</span></span><br><span class="line">  grok &#123;</span><br><span class="line">    match =&gt; &#123;</span><br><span class="line">      <span class="string">&quot;message&quot;</span> =&gt; <span class="string">&quot;%&#123;HTTPD_COMBINEDLOG&#125;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  useragent &#123;</span><br><span class="line">    <span class="built_in">source</span> =&gt; <span class="string">&quot;agent&quot;</span></span><br><span class="line">    target =&gt; <span class="string">&quot;agent-kind&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">  geoip &#123;</span><br><span class="line">    <span class="built_in">source</span> =&gt; <span class="string">&quot;clientip&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">date</span> &#123;</span><br><span class="line">    match =&gt; [ <span class="string">&quot;timestamp&quot;</span>, <span class="string">&quot;dd/MMM/yyyy:HH:mm:ss Z&quot;</span> ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">output &#123;</span><br><span class="line">  stdout &#123;</span><br><span class="line">  &#125;</span><br><span class="line">  elasticsearch&#123;</span><br><span class="line">     hosts =&gt; [<span class="string">&quot;10.0.0.211:9200&quot;</span>,<span class="string">&quot;10.0.0.212:9200&quot;</span>,<span class="string">&quot;10.0.0.213:9200&quot;</span>]</span><br><span class="line">     index =&gt; <span class="string">&quot;kafka-elk-%&#123;+yyyy.MM.dd&#125;&quot;</span></span><br><span class="line">     user =&gt; <span class="string">&quot;elastic&quot;</span></span><br><span class="line">     password =&gt; <span class="string">&quot;123456&quot;</span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cos.lukme.top/Pic/image-20241030013045764.png" alt="image-20241030013045764"></p>]]></content>
    
    
    <summary type="html">本章介绍了基于ELFK架构+kafka收集日志处理</summary>
    
    
    
    <category term="ELK日志收集" scheme="https://lukme.top/categories/ELK%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86/"/>
    
    
    <category term="ELK" scheme="https://lukme.top/tags/ELK/"/>
    
  </entry>
  
  <entry>
    <title>13.使用supervisor管理服务</title>
    <link href="https://lukme.top/posts/1267bcfa.html"/>
    <id>https://lukme.top/posts/1267bcfa.html</id>
    <published>2024-10-30T02:45:01.000Z</published>
    <updated>2024-10-30T04:02:43.037Z</updated>
    
    <content type="html"><![CDATA[<h2 id="使用supervisor管理服务">使用supervisor管理服务</h2><p><strong>1. 下载supervisor</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@elk02:0 ~]#  apt -y install supervisor</span><br></pre></td></tr></table></figure><p><strong>2. 启动服务并设置开机自启</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@elk02:0 ~]#  systemctl start supervisor</span><br><span class="line">[root@elk02:0 ~]#  systemctl <span class="built_in">enable</span> supervisor</span><br></pre></td></tr></table></figure><p><strong>3.修改supervisor配置</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@elk01:2 ~]# vim /etc/supervisor/supervisord.conf</span><br><span class="line">···</span><br><span class="line"><span class="comment"># 以后需要配置的服务只需要放在/etc/supervisor/下，以.ini结尾的都可被supervisor管理</span></span><br><span class="line">[include]</span><br><span class="line">files = /etc/supervisor/*.ini</span><br></pre></td></tr></table></figure><p><strong>4.编辑ini配置文件</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@elk01:2 ~]# <span class="built_in">cat</span> /etc/supervisor/zk.ini </span><br><span class="line">[program:zookeeper]</span><br><span class="line"><span class="built_in">command</span>=/app/zookeeper/bin/zkServer.sh start-foreground</span><br><span class="line">autostart=<span class="literal">true</span></span><br><span class="line">autorestart=<span class="literal">true</span></span><br><span class="line">stderr_logfile=/var/log/zookeeper.err.log</span><br><span class="line">stdout_logfile=/var/log/zookeeper.out.log</span><br><span class="line">user=root</span><br><span class="line">priority=1</span><br><span class="line">environment=JAVA_HOME=<span class="string">&quot;/usr/share/elasticsearch/jdk/&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#注意修改zookeeper的安装路径，以及javahome路径   （使用  echo $JAVA_HOME 查看java环境 ）</span></span><br><span class="line">[root@elk01:2 ~]# <span class="built_in">echo</span> <span class="variable">$JAVA_HOME</span></span><br><span class="line">/usr/share/elasticsearch/jdk</span><br></pre></td></tr></table></figure><p><strong>5. 更新supervisor配置</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@elk01:2 ~]# supervisorctl update</span><br><span class="line"></span><br><span class="line">注意：每次跟新服务配置都需要update</span><br></pre></td></tr></table></figure><p><strong>6.supervisor管理命令</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#启动服务</span></span><br><span class="line">[root@elk01:2 ~]# supervisorctl start zookeeper</span><br><span class="line"></span><br><span class="line"><span class="comment">#停止服务</span></span><br><span class="line">[root@elk01:2 ~]# supervisorctl stop zookeeper</span><br><span class="line"></span><br><span class="line"><span class="comment">#启动或者停止所有服务</span></span><br><span class="line">[root@elk01:2 ~]# supervisorctl start/stop all</span><br><span class="line"></span><br><span class="line">友情提示：</span><br><span class="line">  如果你的zookeeper是使用zkServer.sh start 启动的，要先使用zkServer.sh stop关闭服务，不能使用zkServer启动服务，使用supervisor去关闭服务</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">本章介绍了使用supervisor统一管理zookeeper和kafka，相比systemd管理更加方便</summary>
    
    
    
    <category term="ELK日志收集" scheme="https://lukme.top/categories/ELK%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86/"/>
    
    
    <category term="ELK" scheme="https://lukme.top/tags/ELK/"/>
    
  </entry>
  
  <entry>
    <title>12.kafka的脚本管理及数据延迟、丢失分析</title>
    <link href="https://lukme.top/posts/70dc5443.html"/>
    <id>https://lukme.top/posts/70dc5443.html</id>
    <published>2024-10-30T02:44:01.000Z</published>
    <updated>2024-10-30T04:02:38.055Z</updated>
    
    <content type="html"><![CDATA[<h2 id="kafka的脚本管理">kafka的脚本管理</h2><h3 id="topic管理">topic管理</h3><p><strong>1.查看topic列表</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@elk01:1 ~]# kafka-topics.sh --bootstrap-server 10.0.0.211:9092 --list </span><br><span class="line"></span><br></pre></td></tr></table></figure><p>**2.创建topic **</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@elk01:1 ~]# kafka-topics.sh --bootstrap-server 10.0.0.211:9092 --topic luay --partitions 3 --replication-factor 2 --create</span><br><span class="line">Created topic luay.</span><br><span class="line"></span><br><span class="line"><span class="comment">#注释：</span></span><br><span class="line">--topic  luay           <span class="comment">#指定topic为luay</span></span><br><span class="line">--partitions 3          <span class="comment">#创建3个分区</span></span><br><span class="line">--replication-factor 2  <span class="comment">#创建2个副本</span></span><br><span class="line">--create                <span class="comment">#动作--创建</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#其它选项</span></span><br><span class="line">--delete                <span class="comment">#删除</span></span><br><span class="line">--alter                 <span class="comment">#修改</span></span><br><span class="line">--describe              <span class="comment">#输出详细信息</span></span><br></pre></td></tr></table></figure><p><img src="C:/Users/Dell/AppData/Roaming/Typora/typora-user-images/image-20241029180717295.png" alt="image-20241029180717295"></p><p><strong>3.修改分区数量【只能由小变大，不能由大变小】</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@elk01:1 ~]# kafka-topics.sh --bootstrap-server 10.0.0.211:9092 --topic luay --partitions 5 --alter</span><br></pre></td></tr></table></figure><p><img src="C:/Users/Dell/AppData/Roaming/Typora/typora-user-images/image-20241029180957289.png" alt="image-20241029180957289"></p><p><strong>4.查看指定topic的详细信息</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@elk01:1 ~]# kafka-topics.sh kafka-topics.sh --bootstrap-server 10.0.0.211:9092 --topic luay --describe</span><br></pre></td></tr></table></figure><p><img src="C:/Users/Dell/AppData/Roaming/Typora/typora-user-images/image-20241029181157071.png" alt="image-20241029181157071"></p><p><strong>5.删除topic</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@elk01:1 ~]# kafka-topics.sh kafka-topics.sh --bootstrap-server 10.0.0.211:9092 --topic luay --delete</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#kafka数据目录里topic会被标记-delete，等待一会便会自动删除</span></span><br><span class="line">[root@elk01:1 ~]# ll /app/data/kafka/</span><br><span class="line">drwxr-xr-x 2 root root 4096 Oct 29 18:15 luay-1.2baa4b610f314befbfbed58aaad84052-delete/</span><br><span class="line">drwxr-xr-x 2 root root 4096 Oct 29 18:15 luay-2.0f44f4821a1849ccb7e0e37e1fe65ff4-delete/</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="producer管理">producer管理</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@elk01:5 ~]# kafka-console-producer.sh --bootstrap-server 10.0.0.211:9092 --topic <span class="built_in">test</span></span><br><span class="line">&gt;999999</span><br><span class="line">[2024-10-29 20:49:30,357] WARN [Producer clientId=console-producer] Error <span class="keyword">while</span> fetching metadata with correlation <span class="built_in">id</span> 7 : &#123;<span class="built_in">test</span>=LEADER_NOT_AVAILABLE&#125; (org.apache.kafka.clients.NetworkClient)</span><br><span class="line"></span><br><span class="line"><span class="comment">#首次写入时，若topic不存在，则kafka集群默认会自动创建。</span></span><br><span class="line">[root@elk02:1 ~]# kafka-topics.sh --bootstrap-server 10.0.0.211:9092 --list</span><br><span class="line"><span class="built_in">test</span></span><br></pre></td></tr></table></figure><h2 id="kafka的consumer管理">kafka的consumer管理</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#生产者发送消息</span></span><br><span class="line">[root@elk01:5 ~]# kafka-console-producer.sh --bootstrap-server 10.0.0.211:9092 --topic <span class="built_in">test</span></span><br><span class="line">&gt;12112112</span><br><span class="line">&gt;666666</span><br><span class="line"></span><br><span class="line"><span class="comment">#消费者接收消息---接收现在开始的消息</span></span><br><span class="line">[root@elk01:4 ~]# kafka-console-consumer.sh --bootstrap-server 10.0.0.211:9092 --topic <span class="built_in">test</span></span><br><span class="line">666666</span><br><span class="line"></span><br><span class="line"><span class="comment">#消费者接收消息---从头接收消息    --from-beginning </span></span><br><span class="line">[root@elk01:4 ~]# kafka-console-consumer.sh --bootstrap-server 10.0.0.211:9092 --topic <span class="built_in">test</span> --from-beginning </span><br><span class="line">999999</span><br><span class="line">12112112</span><br><span class="line">666666</span><br></pre></td></tr></table></figure><h2 id="消费者组理念">消费者组理念</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">- kafka的消费者组概念</span><br><span class="line">1.kafka的offset存储位置</span><br><span class="line">kafka早期版本 0.9-版本，offset记录存储在zookeeper集群。</span><br><span class="line">从kafka 0.10+版本，默认的offset存储在kafka集群，存储在一个名为<span class="string">&quot;__consumer_offsets&quot;</span>内置的topic。(当消费者出现宕机，当前当前组里的其它消费者会从_consumer_offsets记录的偏移量里，找到已经取到哪里的数据，从此点继续往后取数据，而不是从新取所有数据，避免数据重复采集)</span><br><span class="line"></span><br><span class="line">2.相关术语</span><br><span class="line">consumer group：    消费者组，任意一个消费者都隶属于一个消费者组。</span><br><span class="line"></span><br><span class="line">1.而<span class="string">&quot;__consumer_offsets&quot;</span>内置的topic记录的偏移量并不属于某个消费者，而是基于消费者进行记录的。</span><br><span class="line">2.当消费者组的消费者数量发生变化时，会触发重平衡(Rebalance);</span><br><span class="line">  1.比如消费者组的消费者（C1/C2）新增或者下线，所谓的重平衡指的是该消费者组的消费者重新分配分区（0分区,1分区,2分区过程。</span><br><span class="line">  2.该消费者组若新增了消费者，也会触发重平衡;</span><br><span class="line">  3.当消费者组的数量多余partition数量时，则会导致该消费者组有空闲的消费者;（假设5个消费者，但是只有3个分区)</span><br></pre></td></tr></table></figure><p><img src="C:/Users/Dell/AppData/Roaming/Typora/typora-user-images/consumer_group.png" alt="consumer_group"></p><h2 id="kafka消费者组数据延迟分析">kafka消费者组数据延迟分析</h2><p>由图解，kafka的消费者是logstash，怎么会出现数据延迟呢？</p><p><img src="C:/Users/Dell/AppData/Roaming/Typora/typora-user-images/ElasticStack_MQ.png" alt="ElasticStack_MQ"></p><blockquote><p>当生产者过多，logstash忙不过来时候收集，就会出现数据延迟可能</p></blockquote><p>理论存在，分析实践</p><p><strong>1. 查看现有的消费者组列表</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@elk03:0 ~]# kafka-consumer-groups.sh --bootstrap-server  10.0.0.211:9092 --list</span><br><span class="line">console-consumer-10558</span><br><span class="line">console-consumer-73547</span><br><span class="line">console-consumer-4558</span><br></pre></td></tr></table></figure><p><strong>2.创建topic指定分区和副本</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@elk03:0 ~]# kafka-topics.sh --bootstrap-server 10.0.0.211:9092 --topic new --partitions 3 --replication-factor 2 --create</span><br><span class="line">Created topic new.</span><br></pre></td></tr></table></figure><p><strong>3.启动生产者</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@elk01:5 ~]# kafka-console-producer.sh --bootstrap-server 10.0.0.211:9092 --topic new</span><br><span class="line">&gt;999999</span><br></pre></td></tr></table></figure><p><strong>4.启动消费者</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#1. 启动第一个消费者，指定消费者组</span></span><br><span class="line">[root@elk01:4 ~]# kafka-console-consumer.sh --bootstrap-server 10.0.0.211:9092 --topic new --from-beginning --group dev</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.查看消费者列表</span></span><br><span class="line">[root@elk03:0 ~]# kafka-consumer-groups.sh --bootstrap-server  10.0.0.211:9092 --list</span><br><span class="line">dev</span><br><span class="line">console-consumer-10558</span><br><span class="line">console-consumer-73547</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.查看指定消费者的详细信息</span></span><br><span class="line">[root@elk03:0 ~]# kafka-consumer-groups.sh --bootstrap-server  10.0.0.211:9092 --group dev --describe</span><br><span class="line">GROUP           TOPIC           PARTITION  CURRENT-OFFSET  LOG-END-OFFSET  LAG</span><br><span class="line">dev             new             0          0               0               0  </span><br><span class="line">dev             new             1          0               0               0  </span><br><span class="line">dev             new             2          1               0               0  </span><br></pre></td></tr></table></figure><p><img src="C:/Users/Dell/AppData/Roaming/Typora/typora-user-images/image-20241029224849054.png" alt="image-20241029224849054"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 4.生产者继续写入测试数据</span></span><br><span class="line">[root@elk01:5 ~]# kafka-console-producer.sh --bootstrap-server 10.0.0.211:9092 --topic new</span><br><span class="line">&gt;999999999</span><br><span class="line">&gt;aaaaaaaa</span><br><span class="line">&gt;vbbbbbb</span><br><span class="line">&gt;ccccc</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 启动新的消费者</span></span><br><span class="line">[root@elk02:1 ~]# kafka-console-consumer.sh --bootstrap-server 10.0.0.211:9092 --topic new --from-beginning --group dev</span><br><span class="line"></span><br><span class="line">此时没有新的数据，因为被同一个组（dev）的第一个消费者已经采集过了</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. 写入测试数据</span></span><br><span class="line">[root@elk01:5 ~]# kafka-console-producer.sh --bootstrap-server 10.0.0.211:9092 --topic new</span><br><span class="line">&gt;999999999</span><br><span class="line">&gt;aaaaaaaa</span><br><span class="line">&gt;vbbbbbb</span><br><span class="line">&gt;ccccc</span><br><span class="line">&gt;9999999999</span><br><span class="line">&gt;69696969696</span><br></pre></td></tr></table></figure><p><strong>停止所有消费者，只写入数据</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@elk01:5 ~]# kafka-console-producer.sh --bootstrap-server 10.0.0.211:9092 --topic new</span><br><span class="line">&gt;h</span><br><span class="line">&gt;h</span><br><span class="line">&gt;asasasasasasas</span><br><span class="line"></span><br><span class="line"><span class="comment"># 再次查看详细数据</span></span><br><span class="line">[root@elk03:0 ~]# kafka-consumer-groups.sh --bootstrap-server  10.0.0.211:9092 --group dev --describe</span><br></pre></td></tr></table></figure><p><img src="C:/Users/Dell/AppData/Roaming/Typora/typora-user-images/image-20241029230457830.png" alt="image-20241029230457830"></p><h2 id="kafka数据丢失分析">kafka数据丢失分析</h2><blockquote><p>见图解</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">kafka的ISR列表导致数据丢失的原因：</span><br><span class="line">ISR:</span><br><span class="line">和leader副本同步的所有副本集合。</span><br><span class="line">OSR:</span><br><span class="line">和leader副本不同步所有副本集合。</span><br><span class="line">AR:</span><br><span class="line">所有副本，指的是leader  + follower，即AR = ISR + OSR </span><br><span class="line">LEO:</span><br><span class="line">英文全称为: LOG-END-OFFSET，表示每个partition最后一个Offset。</span><br><span class="line">HW:</span><br><span class="line">表示在ISR列表中所有LEO中最小的LEO。</span><br></pre></td></tr></table></figure><p><img src="C:/Users/Dell/AppData/Roaming/Typora/typora-user-images/kafka-ISR.png" alt="kafka-ISR"></p>]]></content>
    
    
    <summary type="html">本章介绍了Kafka的生产者和消费者如何发起数据和收集数据，并且分析数据延迟</summary>
    
    
    
    <category term="ELK日志收集" scheme="https://lukme.top/categories/ELK%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86/"/>
    
    
    <category term="ELK" scheme="https://lukme.top/tags/ELK/"/>
    
  </entry>
  
  <entry>
    <title>11.kafka介绍及部署</title>
    <link href="https://lukme.top/posts/35ea5361.html"/>
    <id>https://lukme.top/posts/35ea5361.html</id>
    <published>2024-10-30T02:43:01.000Z</published>
    <updated>2024-11-17T16:05:52.434Z</updated>
    
    <content type="html"><![CDATA[<h2 id="kafka介绍">kafka介绍</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Kafka 被称为下一代分布式消息系统，由 Scala 和 Java编写，是非营利性组织ASF(Apache Software Foundation)基金会中的一个开源项目，比如:HTTP Server、Tomcat、Hadoop、ActiveMQ等开源软件都属于 Apache基金会的开源软件，类似的消息系统还有RabbitMQ、ActiveMQ、ZeroMQ。</span><br><span class="line">Kafka用于构建实时数据管道和流应用程序。 它具有水平可伸缩性，容错性，快速性，可在数千家组织中同时投入生产协同工作。</span><br></pre></td></tr></table></figure><h2 id="kafka常见术语">kafka常见术语</h2><p>:dango:  <strong>1.</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">- topic:</span><br><span class="line">表示是主题，对应是逻辑存储单元，一般用于区分业务类型。可以和ES的索引对应。</span><br><span class="line">- partition</span><br><span class="line">分区，一个topic对应一个或多个partition。</span><br><span class="line">- replica:</span><br><span class="line">是数据的实际载体，真正存储数据的资源，分为leader和follower，其中leader对外提供读写，而follower负责数据的同步。</span><br><span class="line">- producer:</span><br><span class="line">生产者，往kafka集群写数据的一方。</span><br><span class="line">- consumer:</span><br><span class="line">消费者，从kafka读取数据的一方。</span><br></pre></td></tr></table></figure><p><img src="https://cos.lukme.top/Pic/topic.png" alt="topic"></p><blockquote><p>读取数据只能去leader读取，follow值负责同步数据</p></blockquote><p>:dango:<strong>2. 角色介绍</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">（1）Producer：Producer即生产者，消息的产生者，是消息的入口。负责发布消息到Kafka broker</span><br><span class="line">（2）Consumer：消费者，用于消费消息，即处理消息</span><br><span class="line"></span><br><span class="line">Broker：Broker是kafka实例，每个服务器上可以有一个或多个kafka的实例，假设每个broker对应一台服务器。每个kafka集群内的broker都有一个不重复的编号，如: broker-0、broker-1等……</span><br><span class="line"></span><br><span class="line">（3）Topic ：消息的主题，可以理解为消息的分类，一个Topic相当于数据库中的一张表,一条消息相当于关系数据库的一条记录，一个Topic或者相当于Redis中列表类型的一个Key，一条消息即为列表中的一个元素。kafka的数据就保存在topic。在每个broker上都可以创建多个topic。物理上不同 topic 的消息分开存储在不同的文件夹，逻辑上一个 topic的消息虽然保存于一个或多个broker 上, 但用户只需指定消息的topic即可生产或消费数据而不必关心数据存于何处，topic 在逻辑上对record(记录、日志)进行分组保存，消费者需要订阅相应的topic 才能消费topic中的消息</span><br><span class="line"></span><br><span class="line">（4）Consumer group: 每个consumer 属于一个特定的consumer group（可为每个consumer 指定 group name，若不指定 group name 则属于默认的group），同一topic的一条消息只能被同一个consumer group 内的一个consumer 消费，类似于一对一的单播机制，但多个consumer group 可同时消费这一消息，类似于一对多的多播机制</span><br><span class="line"></span><br><span class="line">（5）Partition ：是物理上的概念，每个topic 分割为一个或多个partition，即一个topic切分为多份.创建 topic时可指定 partition 数量，partition的表现形式就是一个一个的文件夹,该文件夹下存储该partition的数据和索引文件，分区的作用还可以实现负载均衡，提高kafka的吞吐量。同一个topic在不同的分区的数据是不重复的,一般Partition数不要超过节点数，注意同一个partition数据是有顺序的，但不同的partition则是无序的</span><br><span class="line"></span><br><span class="line">（6）Replication: 同样数据的副本，包括leader和follower的副本数,基本于数据安全,建议至少2个,是Kafka的高可靠性的保障，和ES的副本有所不同，Kafka中的副本数包括主分片数,而ES中的副本数不包括主分片数</span><br><span class="line"></span><br><span class="line">为了实现数据的高可用，比如将分区 0 的数据分散到不同的kafka 节点，每一个分区都有一个 broker 作为 Leader 和一个 broker 作为Follower，类似于ES中的主分片和副本分片。</span><br><span class="line"></span><br><span class="line">假设分区为 3, 即分三个分区0-2，副本为3，即每个分区都有一个 leader，再加两个follower，分区 0 的leader为服务器A，则服务器 B 和服务器 C 为 A 的follower，而分区 1 的leader为服务器B，则服务器 A 和C 为服务器B 的follower，而分区 2 的leader 为C，则服务器A 和 B 为C 的follower。</span><br><span class="line"></span><br><span class="line">AR： Assigned Replicas，分区中的所有副本的统称，包括leader和 follower，AR= lSR+ OSR</span><br><span class="line">lSR：<span class="built_in">ln</span> Sync Replicas，所有与leader副本保持同步的副本 follower和leader本身组成的集合，包括leader和 follower，是AR的子集</span><br><span class="line">OSR：out-of-Sync Replied，所有与leader副本同步不能同步的 follower的集合，是AR的子集</span><br></pre></td></tr></table></figure><p>:dango: 3. 分区和副本的优势</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">实现存储空间的横向扩容，即将多个kafka服务器的空间组合利用</span><br><span class="line">提升性能，多服务器并行读写</span><br><span class="line">实现高可用，每个分区都有一个主分区即 leader 分布在不同的kafka 服务器，并且有对应follower 分布在和leader不同的服务器上</span><br></pre></td></tr></table></figure><p>:dango: <strong>4. kafka写入消息流程</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">生产者（producter）先从kafka集群获取分区的leader</span><br><span class="line">生产者（producter）将消息发送给leader</span><br><span class="line">leader将消息写入本地文件</span><br><span class="line">followers从leader pull消息</span><br><span class="line">followers将消息写入本地后向leader发送ACK</span><br><span class="line">leader收到所有副本的ACK后向producter发送ACK</span><br></pre></td></tr></table></figure><p>:dango:  <strong>5. kafka特点和优势</strong></p><blockquote><p><code>特点：</code><br>分布式: 多机实现,不允许单机<br>分区: 一个消息.可以拆分出多个，分别存储在多个位置<br>多副本: 防止信息丢失，可以多来几个备份<br>多订阅者: 可以有很多应用连接kafka<br>Zookeeper: 早期版本的Kafka依赖于zookeeper， 2021年4月19日Kafka 2.8.0正式发布，此版本包括了很多重要改动，最主要的是kafka通过自我管理的仲裁来替代ZooKeeper，即Kafka将不再需要ZooKeeper！！！</p></blockquote><blockquote><p><code>优势：</code><br>高吞吐量：即使是非常普通的硬件Kafka也可以支持每秒数百万的消息。支持通过Kafka 服务器分区消息。<br>分布式： Kafka 基于分布式集群实现高可用的容错机制，可以实现自动的故障转移。<br>顺序保证：在大多数使用场景下，数据处理的顺序都很重要。大部分消息队列本来就是排序的，并且能保证数据会按照特定的顺序来处理。 Kafka保证一个Partiton内的消息的有序性（分区间数据是无序的，如果对数据的顺序有要求，应将在创建主题时将分区数partitions设置为1）。<br>支持 Hadoop 并行数据加载。<br>通常用于大数据场合,传递单条消息比较大，而Rabbitmq 消息主要是传输业务的指令数据,单条数据较小。</p></blockquote><h2 id="单点部署kafka">单点部署kafka</h2><p><strong>1.下载kafka</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@elk01 ~]#wget https://downloads.apache.org/kafka/3.8.0/kafka_2.13-3.8.0.tgz</span><br></pre></td></tr></table></figure><p><strong>2.解压kafka</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@elk01 ~]# tar xf kafka_2.13-3.8.0.tgz -C /app/</span><br></pre></td></tr></table></figure><p><strong>3.修改kafka的配置文件</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@elk01:3 ~]# vim /app/kafka_2.13-3.8.0/config/server.properties </span><br><span class="line">···</span><br><span class="line"><span class="comment"># 修改kafka的broker的ID信息</span></span><br><span class="line">broker.id=211</span><br><span class="line"><span class="comment"># 修改数据目录</span></span><br><span class="line">log.dirs=/app/data/kafka</span><br><span class="line"><span class="comment"># 修改元数据存储zookeeper集群地址</span></span><br><span class="line">zookeeper.connect=10.0.0.211:2181,10.0.0.212:2181,10.0.0.213:2181/kafka380</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;注释：&#x27;</span></span><br><span class="line">/kafka380   是将以后的znode都放在kafka380下，不指定则默认都在zookeeper的 / 下</span><br></pre></td></tr></table></figure><p><strong>4.配置环境变量</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@elk01 ~]# <span class="built_in">cat</span>  /etc/profile.d/kafka.sh</span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="built_in">export</span> KAFKA_HOME=/app/kafka_2.13-3.8.0</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$KAFKA_HOME</span>/bin</span><br><span class="line"></span><br><span class="line"><span class="comment">#加载环境变量</span></span><br><span class="line">[root@elk01:4 ~]# <span class="built_in">source</span> /etc/profile.d/kafka.sh </span><br></pre></td></tr></table></figure><p><strong>5.启动kafka节点</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@elk01:4 ~]# kafka-server-start.sh -daemon <span class="variable">$KAFKA_HOME</span>/config/server.properties</span><br></pre></td></tr></table></figure><p><img src="https://cos.lukme.top/Pic/image-20241029000747486.png" alt="image-20241029000747486"></p><h2 id="kafka配置文件详解">kafka配置文件详解</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Licensed to the Apache Software Foundation (ASF) under one or more</span></span><br><span class="line"><span class="comment"># contributor license agreements.  See the NOTICE file distributed with</span></span><br><span class="line"><span class="comment"># this work for additional information regarding copyright ownership.</span></span><br><span class="line"><span class="comment"># The ASF licenses this file to You under the Apache License, Version 2.0</span></span><br><span class="line"><span class="comment"># (the &quot;License&quot;); you may not use this file except in compliance with</span></span><br><span class="line"><span class="comment"># the License.  You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#    http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span></span><br><span class="line"><span class="comment"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment"># See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment"># limitations under the License.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># This configuration file is intended for use in ZK-based mode, where Apache ZooKeeper is required.</span></span><br><span class="line"><span class="comment"># See kafka.server.KafkaConfig for additional details and defaults</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="comment">############################# Server Basics #############################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># broker 的全局唯一编号，不能重复，只能是数字。</span></span><br><span class="line">broker.id=0</span><br><span class="line"></span><br><span class="line"><span class="comment">############################# Socket Server Settings #############################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 套接字服务器侦听的地址。如果未配置，主机名将等于的值</span></span><br><span class="line"><span class="comment"># java.net.InetAddress.getCanonicalHostName(), with PLAINTEXT listener name, and port 9092.</span></span><br><span class="line"><span class="comment">#   FORMAT:</span></span><br><span class="line"><span class="comment">#     listeners = listener_name://host_name:port</span></span><br><span class="line"><span class="comment">#   EXAMPLE:</span></span><br><span class="line"><span class="comment">#     listeners = PLAINTEXT://your.host.name:9092</span></span><br><span class="line"><span class="comment">#listeners=PLAINTEXT://:9092</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 侦听器名称、主机名和代理将向客户端公布的端口。</span></span><br><span class="line"><span class="comment"># 如果未设置，则使用“listeners”的值。</span></span><br><span class="line"><span class="comment">#advertised.listeners=PLAINTEXT://your.host.name:9092</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将侦听器名称映射到安全协议，默认情况下它们是相同的。有关更多详细信息，请参阅配置文档</span></span><br><span class="line"><span class="comment">#listener.security.protocol.map=PLAINTEXT:PLAINTEXT,SSL:SSL,SASL_PLAINTEXT:SASL_PLAINTEXT,SASL_SSL:SASL_SSL</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 处理网络请求的线程数量(服务器用于从网络接收请求并向网络发送响应的线程数)</span></span><br><span class="line">num.network.threads=3</span><br><span class="line"></span><br><span class="line"><span class="comment"># 用来处理磁盘 IO 的线程数量</span></span><br><span class="line">num.io.threads=8</span><br><span class="line"></span><br><span class="line"><span class="comment"># 发送套接字的缓冲区大小</span></span><br><span class="line">socket.send.buffer.bytes=102400</span><br><span class="line"></span><br><span class="line"><span class="comment"># 接收套接字的缓冲区大小</span></span><br><span class="line">socket.receive.buffer.bytes=102400</span><br><span class="line"></span><br><span class="line"><span class="comment"># 请求套接字的缓冲区最大大小</span></span><br><span class="line">socket.request.max.bytes=104857600</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">############################# Log Basics #############################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># kafka 运行日志(数据)存放的路径,路径不需要提前创建,kafka 自动帮你创建,可以配置多个磁盘路径,路径与路径之间可以用&quot;,&quot;分隔</span></span><br><span class="line">log.dirs=/usr/kafka/kafka_2.13-3.6.1/datas</span><br><span class="line"></span><br><span class="line"><span class="comment"># 每个topic在当前 broker上的默认分区数。更多的分区允许更大的并行性以供使用，但这也会导致代理之间有更多的文件。</span></span><br><span class="line">num.partitions=1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动时用于日志恢复和关闭时用于刷新的每个数据目录的线程数。(用来恢复和清理 data 下数据的线程数量)对于数据目录位于RAID阵列中的安装，建议增加此值。</span></span><br><span class="line">num.recovery.threads.per.data.dir=1</span><br><span class="line"></span><br><span class="line"><span class="comment">############################# Internal Topic Settings  #############################</span></span><br><span class="line"><span class="comment"># 每个 topic 创建时的副本数，默认时 1 个副本,对于开发测试以外的环境，建议使用大于1的值以确保可用性，如3</span></span><br><span class="line">offsets.topic.replication.factor=1</span><br><span class="line">transaction.state.log.replication.factor=1</span><br><span class="line">transaction.state.log.min.isr=1</span><br><span class="line"></span><br><span class="line"><span class="comment">############################# Log Flush Policy #############################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Messages are immediately written to the filesystem but by default we only fsync() to sync</span></span><br><span class="line"><span class="comment"># the OS cache lazily. The following configurations control the flush of data to disk.</span></span><br><span class="line"><span class="comment"># There are a few important trade-offs here:</span></span><br><span class="line"><span class="comment">#    1. Durability: Unflushed data may be lost if you are not using replication.</span></span><br><span class="line"><span class="comment">#    2. Latency: Very large flush intervals may lead to latency spikes when the flush does occur as there will be a lot of data to flush.</span></span><br><span class="line"><span class="comment">#    3. Throughput: The flush is generally the most expensive operation, and a small flush interval may lead to excessive seeks.</span></span><br><span class="line"><span class="comment"># The settings below allow one to configure the flush policy to flush data after a period of time or</span></span><br><span class="line"><span class="comment"># every N messages (or both). This can be done globally and overridden on a per-topic basis.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 强制将数据刷新到磁盘之前要接受的消息数</span></span><br><span class="line"><span class="comment">#log.flush.interval.messages=10000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在强制刷新之前，消息可以在日志中停留的最长时间</span></span><br><span class="line"><span class="comment">#log.flush.interval.ms=1000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">############################# Log Retention Policy #############################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The following configurations control the disposal of log segments. The policy can</span></span><br><span class="line"><span class="comment"># be set to delete segments after a period of time, or after a given size has accumulated.</span></span><br><span class="line"><span class="comment"># A segment will be deleted whenever *either* of these criteria are met. Deletion always happens</span></span><br><span class="line"><span class="comment"># from the end of the log.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># segment 文件保留的最长时间，超时将被删除</span></span><br><span class="line">log.retention.hours=168</span><br><span class="line"></span><br><span class="line"><span class="comment"># 基于大小的日志保留策略。除非剩余的</span></span><br><span class="line"><span class="comment"># segments下降到 log.retention.bytes 以下。独立于log.retention.hours的函数.</span></span><br><span class="line"><span class="comment">#log.retention.bytes=1073741824</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 每个 segment 文件的最大大小，默认最大 1G ，当达到此大小时，将创建一个新的segment。</span></span><br><span class="line">log.segment.bytes=1073741824</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查日志段以查看是否可以根据保留策略删除它们的间隔(检查过期数据的时间，默认 5 分钟检查一次是否数据过期)</span></span><br><span class="line">log.retention.check.interval.ms=300000</span><br><span class="line"></span><br><span class="line"><span class="comment">############################# Zookeeper #############################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Zookeeper集群连接字符串,一个以逗号分隔的&#x27;主机:端口&#x27;对，每个对对应一个zk服务器。可以在url中附加一个可选的chroot字符串，以指定所有kafka-znode的根目录。</span></span><br><span class="line">zookeeper.connect=10.0.0.211:2181,10.0.0.212:2181,10.0.0.213:2181</span><br><span class="line"></span><br><span class="line"><span class="comment"># 连接到zookeeper 的超时时间（毫秒）</span></span><br><span class="line">zookeeper.connection.timeout.ms=18000</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">############################# Group Coordinator Settings #############################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 以下配置指定GroupCoordinator将延迟初始使用者重新平衡的时间（以毫秒为单位）。</span></span><br><span class="line"><span class="comment"># 随着新成员加入组，再平衡将进一步延迟group.initial.rebalance.delay.ms的值，最大值为max.poll.interval.ms。</span></span><br><span class="line"><span class="comment"># 默认值为3秒。</span></span><br><span class="line"><span class="comment"># 我们在这里将其覆盖为0，因为它为开发和测试提供了更好的开箱即用体验。</span></span><br><span class="line"><span class="comment"># 但是，在生产环境中，默认值3秒更合适，因为这将有助于避免在应用程序启动期间进行不必要的、可能代价高昂的重新平衡。</span></span><br><span class="line">group.initial.rebalance.delay.ms=3</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="部署kafka集群">部署kafka集群</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">重复单点部署的1-6步骤，不过需要注意的是，配置文件的broker.id=211/212/213  根据你的ip后尾自行修改(三个节点不相同，且为正整数就行)</span><br></pre></td></tr></table></figure><blockquote><p>温馨提示：三个  节点做hosts解析,将主机名解析到你的ip上，巨坑，一开始忘记反向解析这个问题了</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@elk211 ~]# <span class="built_in">cat</span> &gt;&gt; /etc/hosts &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">10.0.0.211 elk01</span></span><br><span class="line"><span class="string">10.0.0.212 elk02</span></span><br><span class="line"><span class="string">10.0.0.213 elk03</span></span><br></pre></td></tr></table></figure><p><img src="https://cos.lukme.top/Pic/image-20241029185857776.png" alt="image-20241029185857776"></p><p>以此为戒。。。。。。巨坑</p></blockquote><p><img src="https://cos.lukme.top/Pic/image-20241029002841827.png" alt="image-20241029002841827"></p><blockquote><p>我们配置文件里没有指定每个kafka的地址，那它们是如何找到彼此的呢？</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@elk01:4 ~]# grep -Ev <span class="string">&#x27;^#|^$&#x27;</span> /app/kafka_2.13-3.8.0/config/server.properties </span><br><span class="line">broker.id=211</span><br><span class="line">num.network.threads=3</span><br><span class="line">num.io.threads=8</span><br><span class="line">socket.send.buffer.bytes=102400</span><br><span class="line">socket.receive.buffer.bytes=102400</span><br><span class="line">socket.request.max.bytes=104857600</span><br><span class="line">log.dirs=/app/data/kafka</span><br><span class="line">num.partitions=1</span><br><span class="line">num.recovery.threads.per.data.dir=1</span><br><span class="line">offsets.topic.replication.factor=1</span><br><span class="line">transaction.state.log.replication.factor=1</span><br><span class="line">transaction.state.log.min.isr=1</span><br><span class="line">log.retention.hours=168</span><br><span class="line">log.retention.check.interval.ms=300000</span><br><span class="line">zookeeper.connect=10.0.0.211:2181,10.0.0.212:2181,10.0.0.213:2181/kafka380</span><br><span class="line">zookeeper.connection.timeout.ms=18000</span><br><span class="line">group.initial.rebalance.delay.ms=0</span><br></pre></td></tr></table></figure><p><font color=red>kafka通过连接zookeeper，去找到各个kafka</font></p></blockquote>]]></content>
    
    
    <summary type="html">本章介绍了Kafka的作用,优势,角色以及如何部署kafka集群</summary>
    
    
    
    <category term="ELK日志收集" scheme="https://lukme.top/categories/ELK%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86/"/>
    
    
    <category term="ELK" scheme="https://lukme.top/tags/ELK/"/>
    
  </entry>
  
  <entry>
    <title>10.zookeeper的图形化管理</title>
    <link href="https://lukme.top/posts/da2b0f43.html"/>
    <id>https://lukme.top/posts/da2b0f43.html</id>
    <published>2024-10-30T02:42:01.000Z</published>
    <updated>2024-10-30T04:02:29.309Z</updated>
    
    <content type="html"><![CDATA[<h2 id="zookeeper的类型">zookeeper的类型</h2><ol><li>临时znode类型</li></ol><p>当客户端会话断开连接，若在规定时间(默认是30s)内没有重新连接则该客户端创建的所有znode都会被删除。</p><ol start="2"><li>永久znode</li></ol><p>当客户端会话断开连接，znode不会被删除。</p><blockquote><p>默认创建的znode都是永久的，如果想要创建临时znode，则需要指定&quot;-e&quot;参数。</p></blockquote><p><strong>验证测试</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">[zk: localhost:2181(CONNECTED) 0] <span class="built_in">ls</span> /</span><br><span class="line">[luay, zookeeper]</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看znode状态信息</span></span><br><span class="line">[zk: localhost:2181(CONNECTED) 1] <span class="built_in">stat</span> /luay</span><br><span class="line">cZxid = 0x400000002</span><br><span class="line">ctime = Mon Oct 28 13:09:07 UTC 2024</span><br><span class="line">mZxid = 0x40000000e</span><br><span class="line">mtime = Mon Oct 28 13:11:34 UTC 2024</span><br><span class="line">pZxid = 0x40000000b</span><br><span class="line">cversion = 5</span><br><span class="line">dataVersion = 3</span><br><span class="line">aclVersion = 0</span><br><span class="line">ephemeralOwner = 0x0</span><br><span class="line">dataLength = 4</span><br><span class="line">numChildren = 1</span><br><span class="line"></span><br><span class="line"><span class="comment">#临时创建znode</span></span><br><span class="line"></span><br><span class="line">[zk: localhost:2181(CONNECTED) 2] create -e /abc</span><br><span class="line">Created /abc</span><br><span class="line"></span><br><span class="line">[zk: localhost:2181(CONNECTED) 6] <span class="built_in">stat</span> /abc</span><br><span class="line">cZxid = 0xf00000002</span><br><span class="line">ctime = Mon Oct 28 14:23:04 UTC 2024</span><br><span class="line">mZxid = 0xf00000002</span><br><span class="line">mtime = Mon Oct 28 14:23:04 UTC 2024</span><br><span class="line">pZxid = 0xf00000002</span><br><span class="line">cversion = 0</span><br><span class="line">dataVersion = 0</span><br><span class="line">aclVersion = 0</span><br><span class="line">ephemeralOwner = 0xd500028c8caa0000</span><br><span class="line">dataLength = 0</span><br><span class="line">numChildren = 0</span><br><span class="line"></span><br><span class="line">`注意：ephemeralOwner这一行，不是和上面永久znode状态一样，上面永久的是0x0`</span><br><span class="line"></span><br><span class="line"><span class="comment">#退出连接等待30s再次连接查看--没了</span></span><br><span class="line">[zk: localhost:2181(CONNECTED) 0] <span class="built_in">ls</span> /</span><br><span class="line">[luay, zookeeper]</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;重新建立链接，默认30s后数据就自动删除！&#x27;</span></span><br></pre></td></tr></table></figure><h2 id="zookeeper的JVM调优">zookeeper的JVM调优</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1.zookeeper的堆内存调优思路（这里调试128m测试）</span><br><span class="line">生成环境中，建议配置2GB-4GB即可。默认是1GB。</span><br><span class="line"></span><br><span class="line">2.查看默认的堆内存大小</span><br><span class="line">[root@elk03:1 ~]#  ps -ef | grep zookeeper | grep -i xmx</span><br></pre></td></tr></table></figure><p><img src="C:/Users/Dell/AppData/Roaming/Typora/typora-user-images/image-20241028223011825.png" alt="image-20241028223011825"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">3.修改官方的环境变量脚本</span><br><span class="line">[root@elk03:1 ~]# <span class="built_in">cat</span> /app/zookeeper/bin/zkEnv.sh </span><br><span class="line">···</span><br><span class="line"><span class="comment"># default heap for zookeeper server</span></span><br><span class="line">ZK_SERVER_HEAP=<span class="string">&quot;<span class="variable">$&#123;ZK_SERVER_HEAP:-128&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># default heap for zookeeper client</span></span><br><span class="line">ZK_CLIENT_HEAP=<span class="string">&quot;<span class="variable">$&#123;ZK_CLIENT_HEAP:-128&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">4. 同步到其它节点</span><br><span class="line">[root@elk03 ~]# scp /app/zookeeper/bin/zkEnv.sh 10.0.0.211:/app/zookeeper/bin/  </span><br><span class="line">[root@elk03 ~]# scp /app/zookeeper/bin/zkEnv.sh 10.0.0.212:/app/zookeeper/bin/</span><br><span class="line"></span><br><span class="line">5.重启zookeeper集群（所有节点）</span><br><span class="line">[root@elk03:1 ~]# zkServer.sh restart</span><br><span class="line"></span><br><span class="line">6.再次查看占用内存大小</span><br><span class="line">[root@elk03 ~]# ps -ef | grep zookeeper | grep -i xmx</span><br></pre></td></tr></table></figure><h2 id="zookeeper的图形化管理">zookeeper的图形化管理</h2><p><strong>了解</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#依赖1.8版本jdk</span></span><br><span class="line">https://github.com/zhitom/zkweb/releases/download/zkWeb-v1.2.1/zkWeb-v1.2.1.jar</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">1.解压jdk</span><br><span class="line">[root@elk01 ~]#tar xf jdk-8u291-linux-x64.tar.gz -C /app/</span><br><span class="line"></span><br><span class="line">2.前台启动zkweb</span><br><span class="line">[root@elk01 ~]# /app/jdk1.8.0_291/bin/java -jar /app/zkWeb-v1.2.1.jar </span><br><span class="line"></span><br><span class="line">后台启动：</span><br><span class="line">[root@elk01 ~]# <span class="built_in">nohup</span> /app/jdk1.8.0_291/bin/java -jar /app/zkWeb-v1.2.1.jar &amp;&gt; /tmp/zkweb.log</span><br><span class="line"></span><br><span class="line">3.浏览器访问</span><br><span class="line">10.0.0.211:8099/</span><br></pre></td></tr></table></figure><blockquote><p>注：多个节点直接以   ,  分开  10.0.0.211:2181,10.0.0.212:2181,10.0.0.213:2181</p></blockquote><p><img src="C:/Users/Dell/AppData/Roaming/Typora/typora-user-images/image-20241028231813958.png" alt="image-20241028231813958"></p><p><img src="C:/Users/Dell/AppData/Roaming/Typora/typora-user-images/image-20241028232321533.png" alt="image-20241028232321533"></p>]]></content>
    
    
    <summary type="html">本章介绍了zookeeper使用图形化管理以及JVM内存调优</summary>
    
    
    
    <category term="ELK日志收集" scheme="https://lukme.top/categories/ELK%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86/"/>
    
    
    <category term="ELK" scheme="https://lukme.top/tags/ELK/"/>
    
  </entry>
  
  <entry>
    <title>09.zookeeper集群部署</title>
    <link href="https://lukme.top/posts/1c1f467f.html"/>
    <id>https://lukme.top/posts/1c1f467f.html</id>
    <published>2024-10-30T02:41:01.000Z</published>
    <updated>2024-10-30T04:02:23.769Z</updated>
    
    <content type="html"><![CDATA[<h2 id="zookeeper作用和应用场景">zookeeper作用和应用场景</h2><p><strong>1.zookeeper存储什么数据</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">存储的主要是一些配置信息，可以用于服务注册，服务发现等常见。</span><br><span class="line">zookeeper的存储结构和Linux文件系统很相似，有多级目录。</span><br><span class="line"></span><br><span class="line">和Linux的根文件系统和类似，分为目录和文件，zookeeper也类似，只不过没有文件和目录的区别，而是都称之为zookeeper node，简称znode。</span><br><span class="line"></span><br><span class="line">znode不适合存储大量数据，一个znode默认最大存储2MB的数据。</span><br></pre></td></tr></table></figure><p><strong>2.zookeeper的应用场景</strong></p><p>和kafka，hbase，HDFS，YARN，Dubbo，Solr等服务，提供了配置信息，注册中心等辅助功能。</p><p><strong>ElasticStack架构升级–MQ</strong></p><blockquote><p>filebeat数据采集交给Kafka消息队列，logstash去拉取Kafka里的数据处理交给ES集群</p></blockquote><p><img src="https://cos.lukme.top/Pic/ElasticStack_MQ.png" alt="ElasticStack_MQ"></p><p>消息队列产品</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Rocket MQ</span><br><span class="line">Active MQ</span><br><span class="line">Kafka</span><br><span class="line">Rebbit MQ</span><br></pre></td></tr></table></figure><h2 id="zookeeper单点部署">zookeeper单点部署</h2><p><code>这里仅为测试，可跳过步骤 4,5 直接部署集群，避免单点故障</code></p><blockquote><p>官方版本选择：<a href="https://zookeeper.apache.org/releases.html">https://zookeeper.apache.org/releases.html</a></p><p>zookeeper集群的节点数量选择</p><p>当每秒请求量低于6w/s，读取数据占据70%，大多数是读的场景，官方测试数据建议选择3台集群。</p></blockquote><p><strong>1.下载zookeeper</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@elk01:3 ~]# wget https://dlcdn.apache.org/zookeeper/zookeeper-3.8.4/apache-zookeeper-3.8.4-bin.tar.gz</span><br></pre></td></tr></table></figure><p>**2.解压软件包 **</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@elk01:3 ~]# tar xf apache-zookeeper-3.8.4-bin.tar.gz -C /app/</span><br><span class="line"></span><br><span class="line"><span class="comment">#做软链接</span></span><br><span class="line">[root@elk01:3 ~]# <span class="built_in">ln</span> -s /app/apache-zookeeper-3.8.4-bin/ /app/zookeeper</span><br></pre></td></tr></table></figure><p><strong>3.配置环境变量</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@elk01:3 ~]# <span class="built_in">cat</span> /etc/profile.d/zk.sh</span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="built_in">export</span> JAVA_HOME=/usr/share/elasticsearch/jdk</span><br><span class="line"><span class="built_in">export</span> ZK_HOME=/app/zookeeper</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$ZK_HOME</span>/bin:<span class="variable">$JAVA_HOME</span>/bin</span><br><span class="line"></span><br><span class="line"><span class="comment">#加载环境变量</span></span><br><span class="line">[root@elk01:3 ~]# <span class="built_in">source</span> /etc/profile.d/zk.sh</span><br></pre></td></tr></table></figure><p><strong>4.准备配置文件</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@elk01:3 ~]#  <span class="built_in">cp</span> /app/zookeeper/conf/zoo&#123;_sample,&#125;.cfg </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#这里只是对配置文件的解读，未修改配置文件，复制出来默认即可</span></span><br><span class="line">[root@elk01:3 ~]# <span class="built_in">cat</span> /app/zookeeper/conf/zoo.cfg </span><br><span class="line"><span class="comment"># 指定最小的时间单位tick，默认单位是毫秒，此处最小单位是1  tick=2s</span></span><br><span class="line">tickTime=2000</span><br><span class="line"><span class="comment"># 在集群初始化时的时间默认是10 tick，则表示20s</span></span><br><span class="line">initLimit=10</span><br><span class="line"><span class="comment"># 数据同步时间5 tick，则表示10s</span></span><br><span class="line">syncLimit=5</span><br><span class="line"><span class="comment"># 数据的存储目录</span></span><br><span class="line">dataDir=/tmp/zookeeper</span><br><span class="line"><span class="comment"># 服务监听的端口</span></span><br><span class="line">clientPort=2181</span><br></pre></td></tr></table></figure><p><strong>5.启动测试</strong></p><blockquote><p>注意，zookeeper启动会监听8080端口，启动失败注意查看端口冲突</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#排错看日志</span></span><br><span class="line">[root@elk01:3 ~]# ll /app/zookeeper/logs/</span><br><span class="line">-rw-r--r-- 1 root root 16469 Oct 28 17:12 zookeeper-root-server-elk01.out</span><br></pre></td></tr></table></figure></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@elk01:3 ~]# zkServer.sh start</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /app/zookeeper/bin/../conf/zoo.cfg</span><br><span class="line">Starting zookeeper ... STARTED</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看状态</span></span><br><span class="line">[root@elk01:3 ~]# zkServer.sh status</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /app/zookeeper/bin/../conf/zoo.cfg</span><br><span class="line">Client port found: 2181. Client address: localhost. Client SSL: <span class="literal">false</span>.</span><br><span class="line">Mode: standalone</span><br><span class="line"></span><br><span class="line"><span class="comment">#standalone  单点状态</span></span><br></pre></td></tr></table></figure><p><strong>连接测试</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@elk01:3 ~]# zkCli.sh      或者</span><br><span class="line">[root@elk01:3 ~]# zkCli.sh -server 10.0.0.211</span><br><span class="line"></span><br><span class="line">2024-10-28 17:06:31,811 [myid:localhost:2181] - INFO  [main-SendThread(localhost:2181):o.a.z.ClientCnxn<span class="variable">$SendThread</span>@1453] - Session establishment complete on server localhost/127.0.0.1:2181, session <span class="built_in">id</span> = 0x10001704a360000, negotiated <span class="built_in">timeout</span> = 30000</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">WatchedEvent state:SyncConnected <span class="built_in">type</span>:None path:null</span><br><span class="line">[zk: localhost:2181(CONNECTED) 1] <span class="built_in">ls</span> /      <span class="comment">#ls命令测试下</span></span><br><span class="line">[zookeeper]</span><br><span class="line"></span><br><span class="line"><span class="comment">#出现它的session id  即为部署成功</span></span><br></pre></td></tr></table></figure><h2 id="zookeeper集群部署">zookeeper集群部署</h2><blockquote><p>如果zookeeper单点未做，步骤1,3可跳过</p></blockquote><p><strong>1. 停止服务</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@elk01:3 ~]# zkServer.sh stop</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /app/zookeeper/bin/../conf/zoo.cfg</span><br><span class="line">Stopping zookeeper ... STOPPED</span><br></pre></td></tr></table></figure><p><strong>2.修改配置文件</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[root@elk01 ~]# <span class="built_in">cat</span> /app/zookeeper/conf/zoo.cfg </span><br><span class="line"><span class="comment"># 定义最小单元的时间范围tick。</span></span><br><span class="line">tickTime=2000</span><br><span class="line"><span class="comment"># 启动时最长等待tick数量。</span></span><br><span class="line">initLimit=5</span><br><span class="line"><span class="comment"># 数据同步时最长等待的tick时间进行响应ACK</span></span><br><span class="line">syncLimit=2</span><br><span class="line"><span class="comment"># 指定数据目录</span></span><br><span class="line">dataDir=/app/data/zk</span><br><span class="line"><span class="comment"># 监听端口</span></span><br><span class="line">clientPort=2181</span><br><span class="line"><span class="comment"># 开启四字命令允许所有的节点访问。</span></span><br><span class="line">4lw.commands.whitelist=*</span><br><span class="line"><span class="comment"># server.ID=A:B:C[:D]</span></span><br><span class="line"><span class="comment"># ID:</span></span><br><span class="line"><span class="comment">#    zk的唯一编号。</span></span><br><span class="line"><span class="comment"># A:</span></span><br><span class="line"><span class="comment">#    zk的主机地址。</span></span><br><span class="line"><span class="comment"># B:</span></span><br><span class="line"><span class="comment">#    leader的选举端口，是谁leader角色，就会监听该端口。</span></span><br><span class="line"><span class="comment"># C: </span></span><br><span class="line"><span class="comment">#    数据通信端口。</span></span><br><span class="line"><span class="comment"># D:</span></span><br><span class="line"><span class="comment">#    可选配置，指定角色。</span></span><br><span class="line">server.91=10.0.0.211:2888:3888</span><br><span class="line">server.92=10.0.0.212:2888:3888</span><br><span class="line">server.93=10.0.0.213:2888:3888</span><br><span class="line"></span><br><span class="line"><span class="comment">## Metrics Providers</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># https://prometheus.io Metrics Exporter</span></span><br><span class="line"><span class="comment">#metricsProvider.className=org.apache.zookeeper.metrics.prometheus.PrometheusMetricsProvider</span></span><br><span class="line"><span class="comment">#metricsProvider.httpHost=0.0.0.0</span></span><br><span class="line"><span class="comment">#metricsProvider.httpPort=7000</span></span><br><span class="line"><span class="comment">#metricsProvider.exportJvmInfo=true</span></span><br></pre></td></tr></table></figure><p><strong>3.恢复原环境</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@elk01:3 ~]# <span class="built_in">rm</span> -fr /app/zookeeper/logs/*</span><br><span class="line">[root@elk01:3 ~]# <span class="built_in">rm</span> -fr tmp/zookeeper/*</span><br></pre></td></tr></table></figure><p><strong>4. 同步数据</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#拷贝环境变量文件</span></span><br><span class="line">[root@elk01 ~]# scp /etc/profile.d/zk.sh 10.0.0.212:/etc/profile.d/</span><br><span class="line">[root@elk01 ~]# scp /etc/profile.d/zk.sh 10.0.0.213:/etc/profile.d/</span><br><span class="line"></span><br><span class="line"><span class="comment">#拷贝zookeeper文件</span></span><br><span class="line">[root@elk01 ~]# scp apache-zookeeper-3.8.4-bin.tar.gz 10.0.0.212:/root</span><br><span class="line">[root@elk01 ~]# scp apache-zookeeper-3.8.4-bin.tar.gz 10.0.0.213:/root</span><br><span class="line"></span><br><span class="line"><span class="comment">#在对端解压zookeeper，做软链接（两个节点同步操做）</span></span><br><span class="line">[root@elk02 ~]# tar xf apache-zookeeper-3.8.4-bin.tar.gz -C /app/</span><br><span class="line"></span><br><span class="line">[root@elk02 ~]# <span class="built_in">ln</span> -s /app/apache-zookeeper-3.8.4-bin/ /app/zookeeper</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#拷贝zookeeper配置文件</span></span><br><span class="line">[root@elk01 ~]# scp /app/zookeeper/conf/zoo.cfg 10.0.0.212:/app/zookeeper/conf/</span><br><span class="line">[root@elk01 ~]# scp /app/zookeeper/conf/zoo.cfg 10.0.0.213:/app/zookeeper/conf/</span><br></pre></td></tr></table></figure><p><strong>5.生成myid文件</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建数据目录（配置文件里声明的目录）  </span></span><br><span class="line">`这里使用循环是因为三台机器我已两两做了免密,另外两个节点也可使用命令  <span class="built_in">mkdir</span> /app/data/zk -p`</span><br><span class="line">[root@elk01:3 ~]# <span class="keyword">for</span> i <span class="keyword">in</span> `<span class="built_in">seq</span> 211 213` ;<span class="keyword">do</span> ssh 10.0.0.<span class="variable">$i</span> <span class="built_in">mkdir</span> /app/data/zk -p ;<span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#生成myid文件</span></span><br><span class="line">[root@elk01:3 ~]# <span class="keyword">for</span> n <span class="keyword">in</span> `<span class="built_in">seq</span> 211 213` ;<span class="keyword">do</span> ssh 10.0.0.<span class="variable">$n</span> <span class="string">&quot;echo <span class="variable">$n</span> &gt; /app/data/zk/myid&quot;</span>;<span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#myid文件作用</span></span><br><span class="line">如果首次启动时候没有事务文件，则会比较myid文件里，谁最大谁就是master</span><br></pre></td></tr></table></figure><p><strong>6.启动服务</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@elk01 ~]# zkServer.sh start</span><br><span class="line">[root@elk02 ~]# zkServer.sh start</span><br><span class="line">[root@elk03 ~]# zkServer.sh start</span><br><span class="line"></span><br><span class="line"><span class="comment">#如果报错找不到命令，可能是配置的环境变量没有生效，执行如下</span></span><br><span class="line">[root@elk03 ~]# <span class="built_in">source</span> /etc/profile.d/zk.sh </span><br><span class="line"></span><br><span class="line"><span class="comment">#查看状态</span></span><br><span class="line">[root@elk03:1 ~]# zkServer.sh status</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /app/zookeeper/bin/../conf/zoo.cfg</span><br><span class="line">Client port found: 2181. Client address: localhost. Client SSL: <span class="literal">false</span>.</span><br><span class="line">Mode: leader</span><br></pre></td></tr></table></figure><p><strong>7.避坑指南</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">我所遇到的坑：</span><br><span class="line"> 1.如果做集群，三个节点的配置文件一样，否则会有zookeeper起不来情况</span><br><span class="line"> 2.删除如果你想清空环境重新启动zookeeper，记得日志和数据目录一起清除，否则服务起不来</span><br></pre></td></tr></table></figure><h2 id="验证zookeeper集群高可用">验证zookeeper集群高可用</h2><p><strong>1.连接测试</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@elk01 ~]# zkCli.sh -server 10.0.0.212:2181</span><br><span class="line">[root@elk01 ~]# zkCli.sh -server 10.0.0.213:2181</span><br><span class="line">···</span><br><span class="line">ablishment complete on server elk03/10.0.0.213:2181, session <span class="built_in">id</span> = 0xd40001f2a52b0000, negotiated <span class="built_in">timeout</span> = 30000</span><br></pre></td></tr></table></figure><p><strong>2. 将leader节点挂掉，集群会自动选举出新的leader，集群正常对外提供服务</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#当前leader节点是elk03</span></span><br><span class="line">[root@elk03 ~]# zkServer.sh status</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /app/zookeeper/bin/../conf/zoo.cfg</span><br><span class="line">Client port found: 2181. Client address: localhost. Client SSL: <span class="literal">false</span>.</span><br><span class="line">Mode: leader</span><br><span class="line"></span><br><span class="line"><span class="comment">#停止elk03的zookeeper</span></span><br><span class="line">[root@elk03 ~]# zkServer.sh stop</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /app/zookeeper/bin/../conf/zoo.cfg</span><br><span class="line">Stopping zookeeper ... STOPPED</span><br><span class="line"></span><br><span class="line"><span class="comment">#经查看leader在elk02节点上</span></span><br><span class="line">[root@elk02 ~]# zkServer.sh status</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /app/zookeeper/bin/../conf/zoo.cfg</span><br><span class="line">Client port found: 2181. Client address: localhost. Client SSL: <span class="literal">false</span>.</span><br><span class="line">Mode: leader</span><br><span class="line"></span><br><span class="line"><span class="comment">#如果此时再次停止leader节点，那还会不会再选举？</span></span><br><span class="line">`经测试，停掉elk02节点的zookeeper时候，elk01节点不会选举为leader，而是会停止zookeeper服务`</span><br><span class="line">这也是我前面猜的坑，只有一台zookeeper时候是起不来服务的</span><br><span class="line"></span><br><span class="line"><span class="comment">#恢复  两个节点停止的服务重新启用即可</span></span><br></pre></td></tr></table></figure><blockquote><p>总结：</p><p>1.zookeeper分布式集群的特点，半数以上节点存活才能对外提供服务;<br>2.zookeeper一个集群中仅有一个leader和多个follower;<br>3.如果一个zookeeper集群想要容忍N台故障，该集群最少要有2N+1个节点</p></blockquote><h2 id="zookeeper基础命令">zookeeper基础命令</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#连接zookeeper</span></span><br><span class="line">[root@elk02:1 ~]# zkCli.sh</span><br><span class="line">WatchedEvent state:SyncConnected <span class="built_in">type</span>:None path:null</span><br><span class="line"></span><br><span class="line"><span class="comment">#1. 查看znode列表</span></span><br><span class="line">[zk: localhost:2181(CONNECTED) 1] <span class="built_in">ls</span> /</span><br><span class="line">[zookeeper]</span><br><span class="line"></span><br><span class="line"><span class="comment">#2. 创建znode</span></span><br><span class="line">[zk: localhost:2181(CONNECTED) 2] create /luay</span><br><span class="line">Created /luay</span><br><span class="line">[zk: localhost:2181(CONNECTED) 3] <span class="built_in">ls</span> /</span><br><span class="line">[luay, zookeeper]</span><br><span class="line"></span><br><span class="line"><span class="comment">#3. 创建znode时指定数据</span></span><br><span class="line">[zk: localhost:2181(CONNECTED) 4] create /test abc</span><br><span class="line">Created /test</span><br><span class="line"></span><br><span class="line"><span class="comment">#4. 查看znode的数据</span></span><br><span class="line">[zk: localhost:2181(CONNECTED) 5] get /test</span><br><span class="line">abc</span><br><span class="line"></span><br><span class="line"><span class="comment">#5. 修改znode的值</span></span><br><span class="line">[zk: localhost:2181(CONNECTED) 7] get /luay</span><br><span class="line">null</span><br><span class="line">[zk: localhost:2181(CONNECTED) 8] <span class="built_in">set</span> /luay new</span><br><span class="line">[zk: localhost:2181(CONNECTED) 9] get /luay</span><br><span class="line">new</span><br><span class="line"></span><br><span class="line"><span class="comment">#6. 创建子znode</span></span><br><span class="line">[zk: localhost:2181(CONNECTED) 10] <span class="built_in">ls</span> /luay </span><br><span class="line">[]</span><br><span class="line">[zk: localhost:2181(CONNECTED) 11] create /luay/happy xixi</span><br><span class="line">Created /luay/happy</span><br><span class="line">[zk: localhost:2181(CONNECTED) 12] get /luay/happy</span><br><span class="line">xixi</span><br><span class="line"></span><br><span class="line"><span class="comment">#7. 删除znode，前提是该znode没有子节点</span></span><br><span class="line">[zk: localhost:2181(CONNECTED) 13] <span class="built_in">ls</span> /test</span><br><span class="line">[] </span><br><span class="line">[zk: localhost:2181(CONNECTED) 14] delete /test</span><br><span class="line">[zk: localhost:2181(CONNECTED) 15] <span class="built_in">ls</span> /test</span><br><span class="line">Node does not exist: /test</span><br><span class="line">[zk: localhost:2181(CONNECTED) 16] <span class="built_in">ls</span> /</span><br><span class="line">[luay, zookeeper]</span><br><span class="line"></span><br><span class="line"><span class="comment">#8. 删除非空znode，该znode有子节点，会报错</span></span><br><span class="line">[zk: localhost:2181(CONNECTED) 17] delete /luay</span><br><span class="line">Node not empty: /luay</span><br><span class="line">[zk: localhost:2181(CONNECTED) 18] </span><br></pre></td></tr></table></figure><blockquote><p>你会发现我连接zookeeper时候是还有本地连接方式，当我使用远程方式连接elk01时候也会有数据，因为zookeeper做了集群</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@elk03 ~]# zkCli.sh -server 10.0.0.211:2181</span><br><span class="line"></span><br><span class="line">[zk: localhost:2181(CONNECTED) 3] <span class="built_in">ls</span> /</span><br><span class="line">[luay, zookeeper]</span><br></pre></td></tr></table></figure></blockquote><h2 id="zookeeper的watch机制（了解）">zookeeper的watch机制（了解）</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">开两个终端，其中一个终端使用watch，另一个终端创建子znode</span><br><span class="line"></span><br><span class="line"><span class="comment">#1. 监控一个znode下子节点的变化</span></span><br><span class="line">[zk: 10.0.0.211:2181(CONNECTED) 0] <span class="built_in">ls</span> -w /luay</span><br><span class="line">[]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#发起创建动作</span></span><br><span class="line">[zk: 10.0.0.211:2181(CONNECTED) 11] create /luay/abc</span><br><span class="line">Created /luay/abc</span><br><span class="line"></span><br><span class="line"><span class="comment">#监控终端则输出</span></span><br><span class="line">[zk: 10.0.0.211:2181(CONNECTED) 1] </span><br><span class="line">WATCHER::</span><br><span class="line">WatchedEvent state:SyncConnected <span class="built_in">type</span>:NodeChildrenChanged path:/luay</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 监控znode的数据是否发生变化 （另一个终端只需要修改znode值即可监控到）</span></span><br><span class="line">[zk: 10.0.0.211:2181(CONNECTED) 0] get -w /luay</span><br><span class="line">[]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 注意：</span></span><br><span class="line">- 1.watch事件是一次性的，只记录第一次创建或者修改动作;</span><br><span class="line">- 2.watch事件一旦触发，就会通知监控者程序，由该程序去负责相应的逻辑处理;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">本章介绍了zookeeper集群的部署及基于kafka架构图</summary>
    
    
    
    <category term="ELK日志收集" scheme="https://lukme.top/categories/ELK%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86/"/>
    
    
    <category term="ELK" scheme="https://lukme.top/tags/ELK/"/>
    
  </entry>
  
  <entry>
    <title>08.文档读写流程</title>
    <link href="https://lukme.top/posts/cfedfcaa.html"/>
    <id>https://lukme.top/posts/cfedfcaa.html</id>
    <published>2024-10-30T02:40:01.000Z</published>
    <updated>2024-10-30T04:02:17.234Z</updated>
    
    <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="抱歉, 这个密码看着不太对, 请再试试." data-whm="抱歉, 这个文章不能被校验, 不过您还是能看看解密后的内容.">  <script id="hbeData" type="hbeData" data-hmacdigest="ce8649610c701f3708bbd23f88d3c1e9008927ca3698c07b84a347bc963191c5">410fa1838f124ea5ac656ff0dc0984fe4470cc585ff257fdda3d3583f45908bb850cfcf9a51c23fc8a55ff84b4e6e27df94ca98ba14ea1d297b3e8b70e9bea7a1474236149082d0911fc5a3d8e00a27d0b982c3ed00e847d4729006cc158aa07e8587bc1f402f37255301c51246228886368208b80e98152c3136ede0651c3551d3586ea2b0452074da05e43a1e1ebad6cb20aa6c0dfb57b12114f073835a96fe371cb615651ed87dc9a1c964c7b6e4538635dc4f5ae11e3e671cf889a6c5720e20ae12049d046ad03c30a6be4857e95c4d91af895436a2004b4f82163dc3dfa4d8beb8ea8753a1940632e9337686184d092625b128007a0e031a54056f1f9809e4df1893613fb49e334de4b17c06969a1696c690f54bf6ba0db7350819925133af8ed6a9ac71e0520ab729b178362f6e6c857a00d6bfded6bcce1b59ca145fe12bc9097575dc0b7a68eb202f135bcddf59c42301360407c75bec3f3cfcd876c0d33b97477f3de1711094069735061a933d250283972016957409d3b5a0bdf09106e73a024981da8f793ace4c295e3c09fbe5aae74528b496a7fb47b4f285f0bc489f6a5e783f23d2ab6a50c8e351a3da8e2a8c6b76224ef5841ee59764864370162e37763c5aaec52ce8eb32615f0783edd55f26f4ce0db5b26a1e9ccfc92475d852ee103a6bb2e923a5c4dee66c242467341271847f34c0f7f1000b57df7fa6fa88e58778838ab42376d539873ae9c201f0642f7a17bae9202a9c271e6bc9968d3ff70aa9784d0d1662e37c6d56ca295314575e3cedc5c909011a91f548f8d218e182c61ebecc0f94a99e74f4508b047517ab72b58a71aec5f95814ff7ff8f468db8d4af1bcb5cf9c172d818d3da273cdd5357ac05db58774928755fc4caaf56d13059eac973f57e4dfd253057d86caadefc455b672e00e0d312ff43650a495d9c1259ed706f75fbf5e7bcf3ba5d37454e83e370222dbf5b8e81358533591a0644682c18ef5b74ea39777d33f802c007f533ea9c03e505d664b3c5871452d6feb15b18b228502fadda2fe2b4b184dcd00607fc4fcedd87032e2933b297d46be31068b7e5d4abaebc89220786b4820527f390d74a7f755b834bf083b611b43bbbc3ff980ec0fdfffdfa7482881fc95033db261bd8655f27b214d18df8d981473a2b50dec0a154ee54746c7155397cfd6284685d2177acca4cf634c052ad2d656a8a5a457b39f9e58c35de974d8fcdb6cadc3f3ff46746943ed6981dcfdea564db24649cc48d89fd5bd1dadcfd43159530987176484fa0a495e91189b6651d87945b72294962a42edbb199a0ce9aa299f22e6a2093f40d0369bc516bdcb34339c4a4c965c29baedb67786164a8289d2b880762722423766f24ed5af9481826ba59af5b1eff7a953793069139e3438fba72624288e7388a057a4d165b529e63f93566baa28cbcd664642a5e6e3bcd60b47ea112e9cdc85828f110c0b1ca10d8aca17084544eaeac3aad1d570186bfc6a76f0fd594d56c9bb3a58da36ed0394c5aa199e5a1e193da7d81e9271bc48369b50699b254aaebe77ab6a918ed32f0362bb56d1353de4d8ee419ff57c79f5b87e4497bd5ae9b08b3b0e55ed88df5f8867c3092148f77fa00493eac5aa4b581ae9516a4db456a316c1e14cde5db8148985c64c5f279e30262f0526c61194a335a80ac5ae836b7d13a1349bb3c05fdf88e2a57c9ff8aa855083a55862c70f065d975a699ea1138f9eb945a521b7ee1b7798b7449a450738587dd4d1a1eb87c66332a61aa286dd20a43429ac3e320cf9fb8e480d37692dab587b7e6c709f05dcafede114c265104a678d88f571a2f0c91ac42d82f0483c6610988c77a10a212c2181f40d98d443f9ef42235d9b35ad7e5e682cbf2fae3d4610e86923fd23a2fe0cf515e57b55ae46a12187a0b01cbd76342c9f64e62cd2151da8bb431ef838f4b60aa58a84243d8b7a4095a41fe1e16139cbd87912c6be1541fe34e0c711df26036678d3aef47df38ae2514e9955e316de8c7a2420fba2447e160bd0654a6dfaaa06dc2f9b5a021aae21b55768848eed619d7750f6747d3a9abfa9010c12ccf4c0be9d152c8acb35f16ca10765d302fd00ad094facdb63bfd187934c615ab42bb35623a9b53d76a2155db4aca353406e774d5c5245d1faf18047d80a2f56124b0b838bfd73ded750a2718115926b7036e3c74202a57c62f0e517a3f4207fb4f48e2f9d5ca325d6f11d5b16813f9c0baa4a41642e40d51b866a8aeed4730b16f59ab7af829b039ba547863a7bb89a74fc3c1649e5e71926a85716eac0dc816f748fc87b3cef1b1d150a1f0a7052c8c9129b3e4f18927c57c5d23f2004157bba9746742d1a04cdb710d41a8dddbfa7a2743cfbbce111ee7b21dae3497c93114841ba504be82319fdc4e38f387b30ea9363c53d7e6906a864289689ab61a0ac4f69b64495fd71c6f41115c9841d52e2a7c054265e3e00d8d8e07a699b09f9138d495d0b0962fd3cae50f787c00950d43aac93c81c355f557061e40b3b0262b07a4d13030e2caf1ae4be95ea1c749ad1369a88c545f41f0872b1e5f028b2518aa1dae3324b338b2b43853e35eee3e23d99b39090526b4b1f5e0b5954e62412ad241a186ceb9dc42b4982d560d26c40470dc380a49f89e921f9d95d948650e77cb4b0841652c364f6254df0ea1b0ba8c8db4c2fbfe407954857f67fa0f9520f7d77aea933729d464c97251bc9a2cd4f1c06fa237b8da05b17e1a28f1ab294dc3612bdb5b83d942f2dcaf30a6b2b98f37e7620acba822a401d8dd34b3acebba90dbc5db534ebcbdc4e74d9ea458225eca0b2130ea57089d1bb369c2fe5d6659b2471a3272c1772491f8b81a32bc5dab89e24f2196e3d5fe1ec8534b0c385e69ac88c2a0c723a3b9036912ee2ce051dfc886c686ba88ba9deb0fd6e4663a7f161a79e3ef03f3b19e9f9741990391b2188fd7170c4f2defc46507c0d76c7ee17acecd7f59bd9bf268376677ca001a2fafa25d3fda87fe61654415ca95b94e5788dd83d9459649890341f137138705a551aebaf1b619896e27cd5f436bc1ea6d8bc99edd8db42554c8162bf5568cea739fc2f0da464ba391ef76e2b1ea63b125fed2c152da38d3cc47a38a83e97ea1ab03e3b7c64dc6976dd85a68b0a4d425290bcac62bf16fa29cac96fd8f74092bed2166a82c86df2314bb56911b7fde07bc6b288c30128fef9a764b4236c2898e1419f237e2b53e995c5accc5d9a17214813c060c94a54cd51e1abef81a20c1f5c2343e0526650a914cc2ae5022087e2f1f44149dcf8be21d8019db87ca29d359959f9df67ab493dd188fbc78e80db878b241f468325d4b28f219461e2694f774282124452efbe708dd567ff796399de37852c93b5a9fa9f2a1fb0f3719fa385b950b8422038a8f1113a3d40bfc7c4be2f96288e7c21e771e97707934cac08d5f41ee0e08417accea5925727161dc0d625de7eed4c434daa21fa31b96d38a50506003cea309a3c0244c1137d93b133a4dac11d95e68cc36a7ff067f36d65bd0173f629be7b19d51b0b10ba2aed790eedb565d5067118dbb7a23d71d744c8d4f6dec3fdec948e2ffe12c255177cfd9963491c158bfd4fe92c02d3edd3f246e5da068636bcb2dcb3579bce8e90810474429952c90feff0458ef2a4d15c59ee1787fd3a93d302ee0678aa6bb0a6eb04fd5ba7219ed0fc4783de741ab03cfe7215eba2f8aa8dd2ef065527fcc0213c1091f7d69002f81dd448ccaddca452ce482d88be9413f1f9ffb565c37a9682cad76f9d1688ab273f27e962a0edf308bd4f8521b5cd4641bab9d8e261f8f2dfdcf72fec29648bc0f8991065465a2fc2a066967c9ae6bf89f647d18942b34c5657d3694a0c842f25e2b59441d5847c067cdd7749c55880e87ef19778c3a7b05cb24ad333eb2bef311ce30c2c32f8674349a2b40346c14a302cabbb5022154eb383fc43c14a9677edb2769854311983bd62981d28a330d400659ba28719d6f4763959b97e41aae7dfe2b984b4515fe5a4775918212dfe2f233c1f5926e9f80f01cab0876b906bb4776040897fe3bf2d1c238a3ce90723ebee7902dc7f27924e44e5c31f83b50dfb8c30a8fc225e6a17047ff1d3def3901d53c2daac9c68e65288c0ce826b3bca9a4d3711d48373def8cd841758ffab566a28e516504c98f0412d17a4d1d5504f90351ced8ee51bd5f29553076bcf9bb8af14d12467184904a4a9687eb1a5c74468d629398b092a110f401fd5ca9961b9b7897710a870b9b8ba09100d7c3fde5b91802c79c20d2f37ab2677026ef13768af3f14174940b3df73c85c5e376950d579044efd668a3600c1c2a289dc1ad44029d41ac4f7974ef1f091ba68d315182ed364d5c7daba7a43c7324446a604966cc9f12120e32d814a326a9563b05773635d993a36879cd0516bbaa37becd2824ed25a857ef4029f02adf91846298dfe47318dc0f3f96c052ad432282bf484bc5395020b6087c04fc2facb92d991bd7758ee06bdfa2bd40972c85035e95b7de73d909661200287d5880998f020d485ade74a1faa97da4a05a414dd517c268b408b5bebf7669aaeb18a0cd80dd5f53d7f34790b53db6ca216f6973ee3b24d01c6e32a1763e29a2e683a56f07116d941720b5ba9376b4258dba4b73aac1fa2f9aa55143f77abf12b64afeb2478d3015e5e945f3bdf09179688b1d33de5a35eab48069ed7294acba6f5ea2ac0dff02e8188d48203b5da70ea56a62ab9dbc6e5cdd1e922f8e53483e9607cd80f5526412a5ccc76dd9aa3365b8043544c4a3b7cc99bad6b146a581e69811ea59bf9ba6fe4c260567bf754b28378664d1829bd09b14d5fd183cc14799ffbf9d2f6d1e734fad3399dd86ec6946f71cc88cfcec7b174c4c04073a0b2429317901e07490c736f75f3e4777a3016cc6aaa3a2b88fe0c8fa4efafbbf3e20131c2b3843eab9aa1bd68d5436854f01f69084054356431a990f220883bd25d62ec0a7767e0087ed6fff8fc199bdce865899ac57795da5a2596443cb703a71c7c0e6c56a56916d46f2e2f2d60ea3baf08c740001b82f2b721392ccd939643754b7289b37e397baea1429895ff7ef546a007d23e7e2dc9bfbd5928673b51081735ec384eac9bb1074795580095810623b7f3d07025cf4079738ca38f5b930130d56a5721c1d4bab520e3e12ec8d29a8e988b40209e3e802a30385f78bc54ff62cf0d64503aaaaebc1c4d78b50346d3bce081fdd5d807d8905d19afcbd4ac4f835f8a89c87cdeb65f4b7eebc8c2400c832513b265b15ad7aa23e661fec4257fa6875646293cf441d85eeaefad35a80fba513831cc31fe4c0c3cb4e23fa7e2d5db7995c09fc08477cf25bea565fbca573f91759f59650bd960518eb9b60094f351e8f8784f15a198957643bd4dc46ef7e57466c1e1011f375e7b2a634ee042dcc4516c235dd6a82d6435e2a715dad4ad0bde5396b3875dd5383f2a55ef2b096157f1ebc06a4f7650ba31ddba0efa4c84baa85bcf19170a89f8b9d36076026f31ed71b0e0df7103e0d0575cc109009ea0a46b5a52142ccb8aee4ebe57ea5fc408792e88b37a744682c3d2ec36d0c8d6597efadcf7e7f2512345e65a56e397737f60e60ddcc7811c2fcef7928ac5c555b41c3d3514e746ca9a331263091862d69702cdce2ac3564cd387f6aad4b1c847063b36625410772a17709541944e12fa7c1f775b19e71a92408a6968388ab7434553efe99d223530900966e92afed04626e2d2b104b1d2a4c66cbdbcc37f2c1ee37b5e0e044ef2822b54619f433caf4f916ee84867ae8a8850d706826104be349e081ce136ffadf0bdcbf9ccd3fa941c422aa7fb76ba7b92ec59704aa6a216460e52ab116dbcfddce377eb05c977a0d78695df01a02d67b67fc6ae9f80f4c674ccedfad1ffbb05cb565db3b7eea8e993ab79d3de22c56aa8965e929626c7246532e292b8a70785f03cc0c1fd2d9f8d7a9e0b8a231bc40842cdff37b30b115f4f5ab81ec9f18d9e57249b81356e3769d5115261e19d53a1f45d306765bf1106fb977ad74857ab47e02ae04d8e9acb29777bf8447cdf25c5a8d09669d02f3c44b0280e05998e861184b424d73bb8b42312c99823a98ac04f635a9cc3bec6e5267cd953f1424ade9a1069aff13c2c31877a9ffa0dacdff94c0a5b31d3d6119f993368d40bf215931691d286bb80bef60ee351af940480e37951b323247e63b058ef39d4c2d1f7a8a173970a600e816bfaf9d44278f23ecc5ef629adc99b41a6ec79468bd038f3bcd56d6b22e27713dd20be0689753c0f9637a252568415d570ccc90cbe3b7c5316822509cfb09b37054661b1a5483cc7290ccafd2fb5c29f4b7b39f09cf039b5b2a511e1f48a4486ea68b55295b21693ba8d4b7cd99f89a460bd355a22ba06a3988241d46f77161e5a92434e6884f99a34031dab0ecd5c7026b61648fe428bd736703853caa546de7c61392f34be80cad49111f58793b62c1f42460b0c7ae1c8a73e3817d5dcbca99a2a7725ffea5eb2872a7b94680b9f07eb0f12ee04ca3f3ded2e89307be1e127593324c59e5091231248f0853a0a3d404aafee727ed6fd71616ed2b5b6c69c20283217e4028ab54f53985ccfeee057427ba0c3a32f23f3f731ef4e247befcf6bb997d4afc793503c3169cbd998bc246d685054c1c0bc111b976369b0cf38c197e9558a0ca99cecc96c24a4f1d25d20793cb0cc824ad2f6aae5a3a59336a6a7cc369ce79d5ffc4100f77c02289320fbd3da06e818aaa3947b8f5ddd76f7cb24f5157d722c5e2d56a61d2cb699a25054139ac27f047b045a2393689526ca23f4e3dff38cfe5677f38bce4983ea0b0d9497d2eab5be4c0ed564e69ad5225abbe9e8a88e64f64933c539a96de16e8ef2a91dfe3b3102cd072e3601e982814c43a38cd34c43dba167762de4c43ed0869756407461c101b179ddab6b698fe2c458064bd27ea5ac3a68d9ff7a112271b435ff3e33aedc388a2744e4751ebf7a1848655893cf15690e3e7680e301a065c3ea397952a6a4592bc959483b29ee023d8bde9599c9cd5ea3b97a8c7ea110c05c000753cd0706f2eb01adf736dd78a9b2d43132a582653e9edcff1968e28e2e1ef4ce0791e0671a6a5f70e9c86dc96941ecb1e2ab4f7235d7b2934a73b7be6743ae58b5a2e737a9c78d65718cd3dfd19115322001556a369e1c72bf299ad0942aed9be1a06a8594fbf45dcf098bda83c3959f19258c790f9da45319f0d5deedc360f05835fbc0d90b9b2dc6f1edf4f10bc8c81872a5ffd6118099bf6356f8ea3009ea7288e4342f7bb44fe90a7bdbddcf64ccd67c2b9b454d0d4a50f529416ed05052b4e91012ae76aa4b65ae08a9433bdcfefaeec1682b2d52c3a55c4112288686b8a39dc76e4f694393199806fd5582a38baba460f22e08b248eb66bf7384414be1797e7cb9579ea3ae74367ff316e455e4d50fc4f617c806673d9761165fa3c04044ac06c9e9d1dc2a6ddc8ad1cb75690f175bcc337cdddacf8d661a2a5c102d9fd1c54cf68f52bd65dc5f041b154483194c25bb1ee67847b93094b361973597c3c7c1dc67a9792a2ba316a365189d5f65959a998e851ce72ee58309b37e78848089763ad69683f60a9b43e49c75ae43f34d592de09c7c0924f172e1ee47b741d8724d5558e63e380a10843fbaddd0614d3f1f4d64ca43953b4044338fad50b9bc22feb10568bdf3feb911fdc73ad37c3cff74b2d8ea56272caeb6c8bb8b23da528e91ebb85975f8fab72120442a383991b18a6887984a2b241c468e55effe759487ad618249b9a3a1031a19a9669fe7f2ee7b6804d61b3c5e3ac20c7ac2f38a1278572208680c804944d6a151b4125186949377847b963139fde996425452a5c961556b4715c5d0f292ec5d40b8f79904cff287e4b3dd49e5830f888510b883cc7b3e6e24e032a7e10848bd0a10eff856f69745901d5f6645effd47897bc4f35acc85b1b9e06249d35ad5c3f7301f13503a5a99b3c16cd8c94b9020258ac1d774cf1c7796ddcd8675f60951571aa004572d8ba4ede20718186e28b8a8dc9151d18bf124c98f367505195cdc0a0be34984ddc90e5326a550619287d4bf154819685e8e312b3210df2bca8741e43adc5354c1dfa0489efb845d971fc4f5a7ddd697640f4e002f4aa27b4abb3757163abd6957c02ad954f17a60d2ac9a8cc4fe6c082f4cc6413aa0fbbac78f47664d2fa6982eed2ef715ac4dcb90b28b7bc240cf71ee1e2a06a07ad25a5c3f1b224ba1debfec03f54d231fd10955ec4817b24408fdf6f1b777e12cec227bbfacda251167a714f3f44681d8295fbdb379c9bf7c4df53211b41ef22f171ad034df2342bed53fb256bf68fe5d55ef787803be6f2f98cc5a4663dd9aceb7139a6b9835f30ce5bd35a48709bdf38188cbbf7046db8a92bdcccea8516531910c232dc87cf8c5d617b2f604c92e0aadc06dfe23090d3f2bc6aa5a7a10a3dcbf5af0432ce3c133e50f6ac0c11c4f865251585a8db59e9f76d74ec6b5f2526d0fb7fff5039fb1013a44d9759aac8fdce7e578e92dccc07a6ce79de4b5bbae7d9e16d00f14b77e4ad47039b43681168c695dc6c7a911f6cbf3fe386d2ce804b5a40ea1bf16daf8606502a5c627bbe886d7244cf432b194658e4ff1ea888f09bfb131d8be46bb6d9d372599bebdc1ee02df4f48adeb028cab050f96e3ea7d0f3ed9e578317f85b4a7603a85dacb2e821911a8a98e412e66249edad61b5f8529c2e3a070695544fcb6b58a33e4d2922e0450e348a41b638e4e4018bd797cb06e90da0a9888a88e004ae1458fa5aca80173f45a03c01e03982931d9bf92d9c264ae096c6a32477dc86aecf33e9dfb0efa13b72487271477b05b30270dcc938f65c34e39d198ea6fe21330ab0e3d3ce5e28be70f557fd02142f243503724ee75132f512dd620719f9c56a41221d36542d0b2c542ad527f3a72eaf6410c8e207f6d8b14e06bea0aa533d5646d2e86ae6ddee8e9da03de8a26b8eb186a65d3a4580b9fc45be968601cad7072542069f7e177106f13fd9ae9b75631fcf57327cb4b5dacea375cc91f07d34d85e97aca4ebdd8e891a76e6e73c2fbe0d997b23adb3cacfdf9155dc43d53f86719ba35af8f0b5576e96357b1ecc9d0f15c286e39ff4df9ae93a3e106cd5be303a2c57de4ca01023a9e4efa01c26193cdc6c4c392b773c1bd9d3458e7f4849c68d529d424cc7c5fddda13b427a0f66047671b16d6f8718f436622c2a23afe7b2cb665369f5d7b1fe755014ab2088ce63913f2afd8fe004d9b6db00b675626bee8cff5b9213eb3213b80722dc84a635c819188ddc7100d952b1741b698c96eabafd87833f81cf94916a4aa4f13ec22f83c869dc765b4fba1c0ee5b7526ff6270629a5868415a44b5671a8454534e07f5690d185f7e25c61f6c9f64a1daf839ad6d26a31932898d4c1442893d5e37cfafedb2905949d62b01458b171f1cbc9bfd256e21bcfd0360413b2c36fd4964c007843e69baaaa5645993912e4e645e48744456bb7fa31931d68158f959df0730128458b3e14bb5f20444db4af47904413641a2d53ae5366a1643904a5ad166dadcb56cbfaf61d566d0156793dcb4f786ebb516f249af3abef8efc8fe5056180750d745bfb043119a562835060ccafea1d410a125958f1d84954369b8f0d3d222a7d4c186e770a57bd01a3316d5958e057cd36a26599d84c32efa5f82577794245bf5e3c164eea8fefa70c145d3155296374703fc6071ae26ace5692941982c92722e058b7812ebc74b9fc9238b3d8892e630519b8f224e76a50b0c0afd99f1fc6f2485404d6719ced4b8da8a468b6dd3ac0f1e5ebdd7d3715ef05ff006ddc84717dd1b29da88aebd29d17c8bf11f1b592da0a11d11a842324dd163def5c192251d46b2ca465b9d1f1fb534548af085282b9dc62e91b8ebba0d7eb0ef26d75260743973d27049bcf642cefea784a5f12b62751b9ad37d68de70986654a0b9cf1ef996888b72f286bbbb890a3d006edb534cbb1340c27c5d09edd11a57cdbbf2f5dd1b3644c2657e99dfc82ed9529ecf15ae708ac9f22412bda7ec550e1003f6829049bbb98d7c93e1a966fe42caa39ac9ab5e4a77c8346bb8b05e5d9f3cad36424e8b9d695ad151f4570146587709ffa895c1c821bd88dc3ab13910292127ecfec641b29cbbd06a366746d2af2c750a5fd93a345a551a159b03981e52258b092d121211494796bbed15e4afcb987d3430d06de3a07121997d94b0794fa2710de301e4ea9c9ca07672001476d847443a0d11221ad6da6cf645f9cfc9846ec0fedad518de95ffdb31ec0bc29979a16948284a81f044381e77c0a4c5171fad73d06a4dad2c12ea38354b71c99797dc7e5af4578d0c5feb7953a66df8fbaa8d3a63553c5216e5894be93ba40245473c8768264b272f4ddd800c6bb88836b27c49935a86e8d7ce08bdcebd86adfd005ee0817eb8189a9a978445894a362c6a2e5b4483711b137b029da1a60c8242a62a27a6303006a824918c1f8b43cdd5e3404d9138c3a0e1a99f6995b5082c366117637a2d76c6a8f4301ec4bca0f91fba5f3889e683667baa4aa6f77bfe41b0be082fa9586608469266b373c7a0bfa56d5baf175dafcdf85ae46b6f50f402e608d509414bceac3e89b65a345ae09d00abb46830e43e0abb6a135d11e7d0dd9d5219dc962ebdfb277e128bf66d286e556c84e543cf1995fdfb16169d8a9da64a1c9b782b31481edff553662599f0ad8ab82bd74969de6992b1a9a30aaf4842b5988c383f93b372cae56d422fa4247c555234d0349e5941341e558523daa9f727fd1def0a3e60f6cc64b597d50db0056c08f9ab8838f8ba1c8ac0593a0915292d63eb284328110f0ab11fd0d4e9c54d7093abf7c1e2fa1c1e6808cd05ea15a32b48f1764637f6b949a4c5fbd8eb7cee64c77eff7aa2ac4f709766563ebedf0be9de579a2b264bdab474e8c94c9a39db4a134b3ff81cb6457eaf6a2251fd6fd9b44fb48cc7806ac86e5db8ef3a394a1a0ac6b357d28febf3462653f8742ae86029e23e04945641c80c62dbf498b1882803b8274b9ffc5585c60e9c4102a908a326ad50b58ed53e25dd99dc38fd15e945d1dedfdbf01715684d6d31c0130d211d37adb198eeb0491369d1b7d9b6cec66dc33dc65bc4fa10bbb1a096c6c9118bfeb9ea2a894de6454cf269e3088ddedaf1f90e6676bdf17c820c5e37677c058e2f0414181f4aaac28151b308e315d7e19bb22f6c18865fdc009abc42763705890c43e485f5dac253b2ad8c9d40a4d2efb25f8e6b18a192a39625001af82df38eec5ebb59386c0e242626f50575a7d81d12d8217de8828800518f13ce107c7d3f0889011a28e99a970ac3b3ef60ee8cb04c6024878a794a135ec07ebc1e78091b6c9205aadfdfe45702d0c4b91fe90bb2683aca3862fc4fcde6483cd678b8cb02bef6e58564e78366a2ba9c048386b1dbe73801965499fad9682aca444612e127a5a54e21796c2274dcc64b5e33f3801f482f4e6be29fa29bac1a2d61a0b5305a1878cdce31b1fec64936992b3bae29fd69cab0066337a318afe2dd8a05addf8ba14c5be038862ccf8051c505eb1f640c4872fca6f730d7d2d632d604e7f4b84e8d1b324914c9e44cb5c35e57ca9a3454b98421b889735797ea5b71f13e2b5e0d0b7aaace7deb471962e25e6ebd66894ccf4b0dd5ac6aa122e1872dd91c29ed070bd7b44e12449af602763028bd48d53f79084cfdaa85070d8f6ed5cd3363961143d7b3d489bc368484e3ba355eb26ca3d5ac7b418807e3b6292909b9906561772885698f25358abffd483e6f28a7144bb1f4d77a9f0e382390b232e53976059f484d7d3c002a281cb86ca789c0e2d5ddcf54abe52626103db8839b6f4cb96e67eedfdec5e943268a6a48dd882d1970cec7451fb8932f7076f89cffecc77f228bd5db553bad05f0b557cfbbbca4101ff455d4959a045acd413fd7a352c3ffee2b0510d673ebc095153ec0b9ea44a4dec7d9f62d32df03307c08fea8b36be38fec5159f46821573f674b56adee8650bd01380aa14abbefa9bf47dbc424d441b6abe299b5ffee196e96047e40855b7a4abc6b043fb09432d82bc36fd855ed7a3c80aa4e5740e6aa531046d7013f699ee477cc96546279b103134986aee3172ccbeb1e7434828b6a95409fc12511dc9ec3c019a4d04cd5b732b26838aaa87d23be7d27280263709c3ecfc18cd0c192d307b5cc341c95e5274105b5e1900ca553856a6d74e0ab6702d69a5f6b6ce5091e6e50a992aa984e6b081c2e96906df469f041c4f92dd8e45db7152f2ba0612021c20a6d55e56ed1ac9af8e38553fd1dda8099a329217c3a8c5611664010e68a71c55a2275a8e1a4932d4cfba37938649b27204f853b6cac4e7d2c349a2a1a212393d484fec27b8a035786fd3bccd43dadd19e9f3e5e9963027612ff5b67f22c8056fc61b9ceea90e8ab4a8ab0bfa52958527a3bb72392304c29b772e3eba1095fb42c4417b065ad37cef9c6f45108fd685a69cdbee5dcd1b10d388a55467e5dbcb5c33e6153633668e5f1125f2d1d4b12d283543be1699d8003ef63735e7c734303be25e26505a4a295a18b9848bc40dca49d98b7b4d383e61e7553f6c4b643a6ec64a4453cd0fd64f75fd4cf00c1319a5a0bb565c48a468e4a4946228a1d0fd722cc0fce2fe48251b859fbbd075a01d9e151f5f7f1a6a09181377513e061dc7f1f03aba9f036b52d647338596d9d18f4da9c38bb807008c1c86c0ec47bbcc28f937c75d37c461e15f643b6ed80b9b08e35b8632182554cb67b1061a6f1f78a8697bd00b0475fe2a734f7353a49a609dbf0c075787fa10b914dc56da2f22a0f1ef0dc9e50550214a62b40db63e56a2640586e4530de575808c85d3cdefa82b2e39645efa2aab97f82197a27aadd8f1887dd81f899fa859f21489cd3c5860ecb014828575e6440821c07d114e008f352b43247f88b8f569f447b9e0276e76a1083947ac4ccc59435e66d3cc6c7a4b34672e318eafbdc4699cff168e23145fc9c29a3a33ce4adce8c815fb58c6a142aec10a6e0a82cf7edfb4cff14a3b493486f5a8f94a3a6d88afda15d8b4bcfe90b6ee291b7ec84aa4c40e959abc472dece21d5fdcd7f7cad23231c2aaadf21a2c615324fe564bb00041bd105d0c2408df29ceb47e9fece5f0e956321fca60e679ca66ca1c8865f0e66e7f92fb9ea1e955fde5749a28881a84b69f4d3777aab0254998f1994e7b3aa3c0c391ebb5137167acdef058335948ed14a6515e8f12c6edb4659bd8ef42b1b0c5406ffc1b91f9af76ae1c0c9ba0de7bdb71a6f634f63e51c58fe950b8008e9db9c73fb3f50a5fe005a11cd3dbf8a52d96b5cc0c451e23726bf9c8926129f91e43dc97e7270503ee5c9641c0a90d4d5f3db5f8832fdf4243ba43e8d9198e77bd0890f33be16b8e022cb7c9dcba247f0d8e3c4fd8bdfa61dd97ff30da8ee45a6140591f39966898cd49d076d8ecf6315c2cb05c0e80ad9dc60061da3176fe81ad024e02c1c85ec6d01dd5488b218b17eb5a698db8cb925dd5ed979d94e94f5d0c41e0ad97fef5051a9ea018b1930897e19414baf1e0b88d95cdcbd62ce48101d1a9b6845e4fe579fe13160d324b6b864162327ca68b1ae32cbb09156b72a7bc1ba99c975d6b3e9519158bc187635110664f14885e3b0424415057c2feccb628a29a94a758a332b8726577ae5b1d42493ee3a11ba5add9dcfb0a26de2870725e378870841af623d5fecc6148fe3123dae4ae5c838027ad67ea8a2629e967700faeffdbb5abc45d8ea4f2da0825f815d7208505bb58386109f14e619a350f1c2c01fb9108b2d91714bb5d3840adf6bdc23143ddcaed698a290aabba763486db1435f5f93760e0e0e6fe4407ece616cb98a54f2a5a857689b8b717b42c086e4874a93058f250ee8ced0edefee560dd44fe3c678c0b0d249dbb8f65c07bfed7a995db95e70453980a812a6cb39d5a3aca928a7f53d77ecbf652832291ccc957316874b4b5e395de693ae0a99c1e4016d3d94d26fa89c34ce7b1b90711bacc6522f56d6216c87a3c2e25c60fa28c607134068d915a2fbb218f937ff84b577eea67b67e3d3d7485691bf3e4aaff1ddb67261ce15065e93800e657423131d2a017d9f0bdd3810dc24043c15df59455555ff525724e20725cbd8fd4369cb9183bf728ad58249ba34c65a62a5c221d1e563bd54bbc8ba639737d847aa9cc07bdfcb1870f52b28fe573dd7e5c1f08770f31dbd84b82c299782cd463cc3f7006b8c47c1fe4df31eaec4dfbb8d8273355f3a0523585f671b8619b92c150d0a8104c7cc42948a2ba951e816278347552bd71f46c6a7ca1a41b745f320d06c643f16513336446b933825e48213dd741c98efe56be05f22175a2f1e8256d86c03bf54fd8ed70db018ae15dd27973e6cc6a131b51bf6fea8400b60d0eba5e590d72079e884f3149639fd510889978b8a58efb10e4ac0a72141b758e8823be9478cc79856851c06ca61d0abd23c9c402a67624b09de284a29efff98c96ba681544e00bedb0507e41894f937d59c40366a77aa753dd60d448d0b3fc07faccbf1bc5c116c0e5699fb37183835a1df8c0d5f1acfb50b13efa47f6b10124ba3de36ea957a27bc53d06a4162db0c9aa86c5bb8efeed7b60cc7656d787d51d89e0ac48366e8eb43099d8da1fce8ea4346d3aff8e32497cdf8704736202f188aadf8583936df97e60816869f8e4fd84494282056b905e1e599170b8922b6b0146a9b3c8c8ab2d431bbcaac13c2b57912c377af9f07eba1d2472630b41f344fd4b7790d34b430dcbf5ac8af553e14bdf6d9360271ee87c88fee4206c4e0c3fca0cfcdfac64465a2e26a483d4541d2ec164fc3cbec166e7a444857d29b5988a07d182f9bc42dc9d8487d3c30dc0d93c3a6d382aae9f065450592294c43c8523bf6dfa352f2873a41eed01486403d2e5976d2217ce12db1ff4d4c35a9399071b7d97d029623647ef285e23f415285057377458f4e31154a8828f6b918344db32bfe3d47283aa88a112ff02ecf83c3f9a34aee0158e4b0ad7a790defe39c9148527c58ffa6d4184dfedf67510a092f9b1153ea51653b493d495acfd1635bb66a6e83b28f4a8bc407ac00e6f271ae3bb6458029002c9bdb282cd6d7fed10b7307e04723978e97687445c97e776b6a70b2f8e2967dacbbd6c4259e7d6a783bc3e354694580d0cdea0018b1f66c6115fd6bae46a8dbd488d9e4cbd733a3a93a6bb051c9356415aa19176bb134c044ffb22ec4107aef88e7baebd206d05667d079b9c655c4d5ebf7db7010fab4e54fff21c85a3940eb097172247c206ea7496cd89db4caf58004f05c2e2b40c9f21d70e6660f1631ba9a146beac63ae06923930c929c0cb30425e77acabe38b11a5afc48c3424eaae4645c98ce6fbef16df381f34580f106133ff602bc2526162d6ad600eb9319960bb8cf35d89f2c087974e521b572496d4d3d9c8836f9949c814c862e698506dc3c00f5907494046c991db9182bd4c88af55a9f1dc3fae202d62196ec2c3648c5273851ada032f61711a54bf0eec75da5ce0e82de7a74826eaf8e108fac80efa40ff4fb067ab21fdde69e611d14ac718b4b5d175734b8c1c1d38d429faa096bc95725f9bdfa2af3410154444a824211af899da920e5a16dd64fc34227a18a2fb56f7418442c34b9a2dda04f240cc73c76541146f0571c9b99634ecd755052dd5fbca002bf6f2eb3024b6c1ddc149089e9b78eb4ff3d163e5c84261f83ef8f90690159a0fb0d7be3f03d31eb545a977a355ff5286763af5abd4ef23f89bb81c06a8c7e0f848db75406d67721ff7385c9b3dd478ab01e32bc8b31f1aa3a0f269d20947c0f06b0cd4efe57ee260468efb701a63b23b8b4d3b45455ced2f222482fa083135b0e33446f5f906ab665e20641feade49fa2f74d15e64b1a442b64d2d6139bfa43710abe346aa1f2b39aa65ee751d3a18be8bcfde29838245ea7cc7d219b09f871cb2fea05d81b50e75809e8efd84106c2803aa22fb46e4706eba31f4ab18cf6006fa502a571761722ceffad4f99944b4b558a767a38d2ba64f056ff1963b8e0af64019e84c250af06a70680f78d220bc6263ebff0ce2394c3c2601fdf4845c0effc25e817d6efbd1e81b8526bf2632b9f496d7665eefe7a9ec7bd21d29dcdccd5a7283ab24691e6185ba808e753129b8a184e3fbcd00766ccee6f82457b509060057e30406c0a952c9862d99b35e383e1612cd6e7f0340cb17c74ef82c7c5d7ae9c94c018e2a89f26b89fda6d626977860d0ffc2084257a48376522ae434998c4a02c15bb6bae60e445b346495d2348361f19a3e6a82e9c437aa11af0995b843996a4106a3df5b4297e8775d4caf5cb2d01099e8505ccef2f2f5e7926a223fdb7595d89208a748d4ca57640206c8e07705e6dfaf918dfed8f0a2a26a923e14f0df749b51daa0566e800a1380419affaa2a4580be63e8d2b3bc1b56abae84a5ae8af7baf7d6cda42b6698aba130c38b5d591023347629f200ec77549572107d1a7b1d377b0b80fab22adeee0b0066c579f32b2e3d6ca1b2207b3038cfb7b3293812d30f99403039991214db930868d2a77068b481ea7ebcd33ce972910c1bcddb17467f697a2eb8e3c23276c55978ebafab124342798b804f4796d2b8c863e0d56ec6fc8861e738ee968db41470164dd6e91fbed86c7a7beb0ab72c8c8a34d4b6b780ca85bbd121be8d66fa9d17a3d31124aae7cc6e75251cd80aadff717eaff7bf2fcdee466e707239f278cb133f0000014750e25f8b52b325bfe199acc6ba9352a49d2f11f50b0f7c5f5f60f68666bff4c1443a3b5892d3308d6e8a30f85af5e7f272bd72b456a86f97f19ecef55a4d21182c6bcbd191cdbb238639387824a11aa191da99e05b2cd8bf356c106ed8fc3bbabec1a54271b08c8e91111a4183263c903dd0bb1fb5fe75521ecadbe88397970b18a6b97270b3b8262f3fac588ee27b209a6319942d9ffc51896877056910ae412744def28820ef61254af21cb0bd60b317693a36f2404cbcb29a87e6d75bd99beda95b4ea0210f3954d33872da4808c724081520f90a94601e084b4a312d2c64fdfac6af2be1a8fda90cf20b12bfe462010a50d36b5ff8ba08a590d51be83753e4b15d7c35ce5a89200e8cc66cf6e1d822cbab01e24cd83c3babc6f2685b7ddd0948f360ae2e8b5065df675792a4aa9717cbf98473481c6b5f8a3f93a4ec75679d681ca9aa1ccbbd9c661c1906023ea2e660e41b39cf13fcd3528b03cb4295e0f1c1abca1c136db4b054a4f5c3d9a03d6c8972eefa72d0b98f543c0f20f1c08d2408b386c731f2ab7697f4db095dd77a03c7e645654c5662446a475885735cb45c4ee37dcdcf758e4b45e9bcdd774df61a62e7cda2ed75885d2f54edfc4ff53774df8e1ace64b30bbe7f3b3a66a1e4dc1352fa0dcf060163779345a26a08924dc9e56660535467531646a9ae5d50423b68d217f44fcc8189a21b68beca197f4404c4be1d89c90e3afd74185ed2f91d9f52455df031eb5143051257caa0a1b426c867d4881313ab51af6194c48ddc0874cee89de35a7c03b780d0ccd55319251e97a17024362c2e7b8a9ca774e1eaff7cb58524562475a282cffdb61148017c95e473e27784c3484eb98a37d3c872f9c4d4cd384cd52d2b6316dffb6646cfcc75566fde996b2a06b01996fca5d8421f8ba1ac8a20d866399841236d1fad90e3a53947c3024f7158</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-xray">      <input class="hbe hbe-input-field hbe-input-field-xray" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-xray" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-xray">您好, 这里需要密码.</span>      </label>      <svg class="hbe hbe-graphic hbe-graphic-xray" width="300%" height="100%" viewBox="0 0 1200 60" preserveAspectRatio="none">        <path d="M0,56.5c0,0,298.666,0,399.333,0C448.336,56.5,513.994,46,597,46c77.327,0,135,10.5,200.999,10.5c95.996,0,402.001,0,402.001,0"></path>        <path d="M0,2.5c0,0,298.666,0,399.333,0C448.336,2.5,513.994,13,597,13c77.327,0,135-10.5,200.999-10.5c95.996,0,402.001,0,402.001,0"></path>      </svg>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
    
    
    <summary type="html">本篇介绍了ES读写文档流程以及底层分片原理</summary>
    
    
    
    <category term="ELK日志收集" scheme="https://lukme.top/categories/ELK%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86/"/>
    
    
    <category term="ELK" scheme="https://lukme.top/tags/ELK/"/>
    
  </entry>
  
  <entry>
    <title>07.Elasticsearch参数调优</title>
    <link href="https://lukme.top/posts/793b821e.html"/>
    <id>https://lukme.top/posts/793b821e.html</id>
    <published>2024-10-30T02:39:01.000Z</published>
    <updated>2024-10-30T04:02:11.629Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Elasticsearch参数调优">Elasticsearch参数调优</h2><h3 id="1-系统层面的调优">1. 系统层面的调优</h3><p>系统层面的调优主要是<code>内存的设定</code>与<code>避免交换内存</code>。</p><p>ES 安装后默认设置的堆内存是 <code>1GB</code>，这很明显是不够的，那么接下来就会有一个问题出现：我们要设置多少内存给 ES 呢？</p><p>其实这是要看我们集群节点的内存大小，还取决于我们是否在服务器节点上还是否要部署其他服务。</p><ul><li>如果内存相对很大，如 64G 及以上，并且我们不在 ES 集群上部署其他服务，那么我建议 ES 内存可以设置为 31G-32G，因为这里有一个 32G 性能瓶颈问题，直白的说就是即使你给了 ES 集群大于 32G 的内存，其性能也不一定会更加优良，甚至会不如设置为 31G-32G 时候的性能。<br>以我调优的集群为例，我所调优的服务器节点内存为 64G，服务器节点上也基本不跑其他服务，所以我把 ES 集群内存大小设置为了 31G，以充分发挥集群性能。</li><li>设置 ES 集群内存的时候，还有一点就是确保堆内存最小值（Xms）与最大值（Xmx）的大小是相同的，防止程序在运行时改变堆内存大小，这是一个很耗系统资源的过程。</li><li>还有一点就是避免交换内存，可以在配置文件中对内存进行锁定，以避免交换内存（也可以在操作系统层面进行关闭内存交换）。对应的参数：<code>bootstrap.mlockall: true</code></li></ul><h3 id="2-分片与副本">2. 分片与副本</h3><ul><li><code>分片 (shard)</code>：ES 是一个分布式的搜索引擎, 索引通常都会分解成不同部分, 分布在不同节点的部分数据就是分片。ES 自动管理和组织分片, 并在必要的时候对分片数据进行再平衡分配, 所以用户基本上不用担心分片的处理细节。创建索引时默认的分片数为 5 个，并且一旦创建不能更改。</li><li><code>副本 (replica)</code>：ES 默认创建一份副本，就是说在 5 个主分片的基础上，每个主分片都相应的有一个副本分片。额外的副本有利有弊，有副本可以有更强的故障恢复能力，但也占了相应副本倍数的磁盘空间。</li></ul><p>那我们在创建索引的时候，应该创建多少个分片与副本数呢？</p><ul><li>对于副本数，比较好确定，可以根据我们集群节点的多少与我们的存储空间决定，我们的集群服务器多，并且有足够大多存储空间，可以多设置副本数，一般是 1-3 个副本数，如果集群服务器相对较少并且存储空间没有那么宽松，则可以只设定一份副本以保证容灾（副本数可以动态调整）。</li><li>对于分片数，是比较难确定的。因为一个索引分片数一旦确定，就不能更改，所以我们在创建索引前，要充分的考虑到，以后我们创建的索引所存储的数据量，否则创建了不合适的分片数，会对我们的性能造成很大的影响。</li></ul><h3 id="3-参数调优">3. 参数调优</h3><p>下面我会介绍一些 ES 关键参数的调优。</p><p>有很多场景是，我们的 ES 集群占用了多大的 cpu 使用率，该如何调节呢。cpu 使用率高，有可能是写入导致的，也有可能是查询导致的，那要怎么查看呢？</p><p>可以先通过 <code>GET _nodes/&#123;node&#125;/hot_threads</code> 查看线程栈，查看是哪个线程占用 <code>cpu</code> 高，如果是 <code>elasticsearch[&#123;node&#125;][search][T#10]</code> 则是查询导致的，如果是 <code>elasticsearch[&#123;node&#125;][bulk][T#1]</code> 则是数据写入导致的。</p><p>在实际调优中，cpu 使用率很高，如果不是 SSD，建议把 <code>index.merge.scheduler.max_thread_count: 1</code> 索引 merge 最大线程数设置为 1 个，该参数可以有效调节写入的性能。因为在存储介质上并发写，由于寻址的原因，写入性能不会提升，只会降低。</p><p>还有几个重要参数可以进行设置，各位同学可以视自己的集群情况与数据情况而定。</p><ul><li><code>index.refresh_interval</code>：这个参数的意思是数据写入后几秒可以被搜索到，默认是 1s。每次索引的 refresh 会产生一个新的 lucene 段, 这会导致频繁的合并行为，如果业务需求对实时性要求没那么高，可以将此参数调大，实际调优告诉我，该参数确实很给力，cpu 使用率直线下降。</li><li><code>indices.memory.index_buffer_size</code>：如果我们要进行非常重的高并发写入操作，那么最好将 <code>indices.memory.index_buffer_size</code> 调大一些，index buffer 的大小是所有的 shard 公用的，一般建议（看的大牛博客），对于每个 shard 来说，最多给 <code>512mb</code>，因为再大性能就没什么提升了。ES 会将这个设置作为每个 shard 共享的 index buffer，那些特别活跃的 shard 会更多的使用这个 buffer。默认这个参数的值是 10%，也就是 jvm heap 的 10%。</li><li><code>translog</code>：ES 为了保证数据不丢失，每次 index、bulk、delete、update 完成的时候，一定会触发刷新 translog 到磁盘上。在提高数据安全性的同时当然也降低了一点性能。如果你不在意这点可能性，还是希望性能优先，可以设置如下参数：</li></ul><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;index.translog&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;sync_interval&quot;</span>: <span class="string">&quot;120s&quot;</span>,     <span class="comment">--sync间隔调高</span></span><br><span class="line">        <span class="string">&quot;durability&quot;</span>: <span class="string">&quot;async&quot;</span>,       -– 异步更新</span><br><span class="line">        <span class="string">&quot;flush_threshold_size&quot;</span>:<span class="string">&quot;1g&quot;</span>  <span class="comment">--log文件大小</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><ul><li>这样设定的意思是开启异步写入磁盘，并设定写入的时间间隔与大小，有助于写入性能的提升。</li></ul><p><strong>还有一些超时参数的设置：</strong></p><ul><li><code>discovery.zen.ping_timeout</code> 判断 master 选举过程中，发现其他 node 存活的超时设置</li><li><code>discovery.zen.fd.ping_interval</code> 节点被 ping 的频率，检测节点是否存活</li><li><code>discovery.zen.fd.ping_timeout</code> 节点存活响应的时间，默认为 30s，如果网络可能存在隐患，可以适当调大</li><li><code>discovery.zen.fd.ping_retries ping</code> 失败/超时多少导致节点被视为失败，默认为 3</li></ul><h3 id="4-其他建议">4. 其他建议</h3><p>还有一些零碎的优化建议喔。</p><ul><li><code>插入索引自动生成 id</code>：当写入端使用特定的 id 将数据写入 ES 时，ES 会检查对应的索引下是否存在相同的 id，这个操作会随着文档数量的增加使消耗越来越大，所以如果业务上没有硬性需求建议使用 ES 自动生成的 id，加快写入速率。</li><li><code>避免稀疏索引</code>：索引稀疏之后，会导致索引文件增大。ES 的 keyword，数组类型采用 doc_values 结构，即使字段是空值，每个文档也会占用一定的空间，所以稀疏索引会造成磁盘增大，导致查询和写入效率降低。</li></ul><h2 id="jvm调优">jvm调优</h2><blockquote><p>仅提供思路，生产环境建议给到物理机内存一半，上限32G即可</p></blockquote><p>1.JVM调优策略</p><p>推荐设置是物理机的一半内存，但是当物理机的内存大于32GB的时候，若内存是64GB，则就是32GB内存。默认就是物理机内存的一半。</p><p>但是当大于64GB时，比如物理机是256GB内存，此时不应该设置内存为宿主机的一半，应该最大上限设置为32GB。</p><p>2.修改堆内存大小</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看当前内存使用状态</span></span><br><span class="line">[root@elk01:0 ~]# free -h</span><br><span class="line">               total        used        free      shared  buff/cache   available</span><br><span class="line">Mem:           3.8Gi       2.2Gi       1.2Gi       0.0Ki       388Mi       1.4Gi</span><br><span class="line">Swap:          2.7Gi       736Mi       2.0Gi</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看java程序已占用内存</span></span><br><span class="line">[root@elk92 ~]# ps -ef | grep java | grep -i xms</span><br><span class="line"></span><br><span class="line"><span class="comment">#我给的是4G内存，占用一半内存</span></span><br></pre></td></tr></table></figure><p><img src="https://cos.lukme.top/Pic/image-20241027215156903.png" alt="image-20241027215156903"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#修改内存大小</span></span><br><span class="line">[root@elk01:0 ~]# vim /etc/elasticsearch/jvm.options</span><br><span class="line">···</span><br><span class="line">-Xms256m</span><br><span class="line">-Xmx256m</span><br></pre></td></tr></table></figure><p><strong>拷贝文件到其他2个节点</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@elk01:0 ~]# scp /etc/elasticsearch/jvm.options 10.0.0.212:/etc/elasticsearch/</span><br><span class="line">[root@elk01:0 ~]# scp /etc/elasticsearch/jvm.options 10.0.0.213:/etc/elasticsearch/</span><br></pre></td></tr></table></figure><p><strong>重启ES集群</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@elk01:0 ~]#  systemctl restart elasticsearch</span><br><span class="line"></span><br><span class="line"><span class="comment">#注意：生产环境最好滚动重启，当前重启完毕后再重启其它节点（防止所有集群宕机）</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看集群状态是否OK</span></span><br><span class="line">[root@elk01:2 ~]# curl 10.0.0.211:9200/_cat/nodes</span><br><span class="line">10.0.0.213 42 97 0 0.25 0.30 0.28 cdfhilmrstw * elk03</span><br><span class="line">10.0.0.211 75 48 3 1.38 0.81 0.64 cdfhilmrstw - elk01</span><br><span class="line">10.0.0.212 52 97 0 0.34 0.31 0.28 cdfhilmrstw - elk02</span><br></pre></td></tr></table></figure><p><strong>再次查看内存占用</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@elk01:2 ~]# free -h</span><br><span class="line">               total        used        free      shared  buff/cache   available</span><br><span class="line">Mem:           3.8Gi       1.1Gi       2.0Gi       0.0Ki       771Mi       2.5Gi</span><br><span class="line">Swap:          2.7Gi        60Mi       2.7Gi</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">针对Elasticsearch参数调优，从系统，分片上分析</summary>
    
    
    
    <category term="ELK日志收集" scheme="https://lukme.top/categories/ELK%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86/"/>
    
    
    <category term="ELK" scheme="https://lukme.top/tags/ELK/"/>
    
  </entry>
  
  <entry>
    <title>06.ES集群加密</title>
    <link href="https://lukme.top/posts/de7fd46f.html"/>
    <id>https://lukme.top/posts/de7fd46f.html</id>
    <published>2024-10-30T02:38:01.000Z</published>
    <updated>2024-10-30T04:02:06.950Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ES集群加密">ES集群加密</h2><p><strong>未加密前</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@elk91 ~]# curl 10.0.0.211:9200/_cat/nodes?v</span><br><span class="line">ip        heap.percent ram.percent cpu load_1m load_5m load_15m node.role   master name</span><br><span class="line">10.0.0.92           78          66   0    0.01    0.02     0.03 cdfhilmrstw -      elk01</span><br><span class="line">10.0.0.93           44          47   1    0.02    0.02     0.01 cdfhilmrstw -      elk02</span><br><span class="line">10.0.0.91           54          68   1    0.22    0.17     0.12 cdfhilmrstw *      elk03</span><br></pre></td></tr></table></figure><p><strong>1. 生成证书文件</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@elk91 ~]# /usr/share/elasticsearch/bin/elasticsearch-certutil cert --days 3650 -out /etc/elasticsearch/elastic-certificates.p12 -pass <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#修改证书权限（否则es没有权限读取证书）</span></span><br><span class="line">[root@elk91 ~]# <span class="built_in">chown</span> elasticsearch:elasticsearch /etc/elasticsearch/elastic-certificates.p12</span><br><span class="line"></span><br><span class="line">`注释:`</span><br><span class="line">[root@elk01:1 ~]# /usr/share/elasticsearch/bin/elasticsearch-certutil cert -h 查看帮助</span><br><span class="line">--days   指定证书有效期多久</span><br><span class="line">--out    指定证书存放路径</span><br><span class="line">--pass   指定证书密码（为空即可）</span><br></pre></td></tr></table></figure><p><strong>2. 同步证书文件到其他节点</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@elk01:1 ~]# scp /etc/elasticsearch/elastic-certificates.p12 10.0.0.212:/etc/elasticsearch/</span><br><span class="line">[root@elk01:1 ~]# scp /etc/elasticsearch/elastic-certificates.p12 10.0.0.213:/etc/elasticsearch/</span><br><span class="line"></span><br><span class="line"><span class="comment">#注：注意检查其它节点的证书权限是否是elasticsearch，若不是则修改（见上一步）</span></span><br></pre></td></tr></table></figure><p><strong>4. 修改ES配置文件</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@elk01:1 ~]# vim /etc/elasticsearch/elasticsearch.yml </span><br><span class="line"></span><br><span class="line"><span class="comment">#同步配置文件到其它节点</span></span><br><span class="line">[root@elk01:1 ~]# scp /etc/elasticsearch/elasticsearch.yml 10.0.0.212:/etc/elasticsearch/</span><br><span class="line">[root@elk01:1 ~]# scp /etc/elasticsearch/elasticsearch.yml 10.0.0.213:/etc/elasticsearch/</span><br></pre></td></tr></table></figure><p><strong>5. 所有节点重启elasticsearch</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@elk01:1 ~]#  systemctl restart elasticsearch</span><br><span class="line"></span><br><span class="line"><span class="comment">#注意：生产环境最好滚动重启，当前重启完毕后再重启其它节点（防止所有集群宕机）</span></span><br></pre></td></tr></table></figure><p><strong>6. 测试访问</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@elk01:1 ~]# curl 10.0.0.211:9200/_cat/nodes</span><br><span class="line">&#123;<span class="string">&quot;error&quot;</span>:&#123;<span class="string">&quot;root_cause&quot;</span>:[&#123;<span class="string">&quot;type&quot;</span>:<span class="string">&quot;security_exception&quot;</span>,<span class="string">&quot;reason&quot;</span>:<span class="string">&quot;missing authentication credentials for REST request [/_cat/nodes]&quot;</span>,<span class="string">&quot;header&quot;</span>:&#123;<span class="string">&quot;WWW-Authenticate&quot;</span>:<span class="string">&quot;Basic realm=\&quot;security\&quot; charset=\&quot;UTF-8\&quot;&quot;</span>&#125;&#125;],<span class="string">&quot;type&quot;</span>:<span class="string">&quot;security_exception&quot;</span>,<span class="string">&quot;reason&quot;</span>:<span class="string">&quot;missing authentication credentials for REST request [/_cat/nodes]&quot;</span>,<span class="string">&quot;header&quot;</span>:&#123;<span class="string">&quot;WWW-Authenticate&quot;</span>:<span class="string">&quot;Basic realm=\&quot;security\&quot; charset=\&quot;UTF-8\&quot;&quot;</span>&#125;&#125;,<span class="string">&quot;status&quot;</span>:401&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#没有权限访问即为成功</span></span><br></pre></td></tr></table></figure><h2 id="生成密码">生成密码</h2><p><strong>注意保存密码</strong></p><blockquote><p>auto  非交互式，自动生成随机密码</p><p>interactive 交互式，自己输入密码（有7项）</p><p><code>注意保存密码</code></p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@elk01:1 ~]# /usr/share/elasticsearch/bin/elasticsearch-setup-passwords auto</span><br><span class="line">Initiating the setup of passwords <span class="keyword">for</span> reserved <span class="built_in">users</span> elastic,apm_system,kibana,kibana_system,logstash_system,beats_system,remote_monitoring_user.</span><br><span class="line">The passwords will be randomly generated and printed to the console.</span><br><span class="line">Please confirm that you would like to <span class="built_in">continue</span> [y/N]y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Changed password <span class="keyword">for</span> user apm_system</span><br><span class="line">PASSWORD apm_system = ZY6QTWFDqGv64uVzB2PR</span><br><span class="line"></span><br><span class="line">Changed password <span class="keyword">for</span> user kibana_system</span><br><span class="line">PASSWORD kibana_system = BtaZLprbzzF1tYXSaCld</span><br><span class="line"></span><br><span class="line">Changed password <span class="keyword">for</span> user kibana</span><br><span class="line">PASSWORD kibana = BtaZLprbzzF1tYXSaCld</span><br><span class="line"></span><br><span class="line">Changed password <span class="keyword">for</span> user logstash_system</span><br><span class="line">PASSWORD logstash_system = ykztlETUjj9bu7zDF9Fw</span><br><span class="line"></span><br><span class="line">Changed password <span class="keyword">for</span> user beats_system</span><br><span class="line">PASSWORD beats_system = Fe075On7ZgmleYNkS9in</span><br><span class="line"></span><br><span class="line">Changed password <span class="keyword">for</span> user remote_monitoring_user</span><br><span class="line">PASSWORD remote_monitoring_user = J7bkmxKsrhUKhLJyksMD</span><br><span class="line"></span><br><span class="line">Changed password <span class="keyword">for</span> user elastic</span><br><span class="line">PASSWORD elastic = pNcoJpSv0j1Qp9ZZ4N5G</span><br></pre></td></tr></table></figure><p><strong>测试连接</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#加上用户和密码测试</span></span><br><span class="line">[root@elk01:1 ~]# curl -u elastic:pNcoJpSv0j1Qp9ZZ4N5G 10.0.0.211:9200/_cat/nodes</span><br><span class="line">10.0.0.212 19 97 3 0.23 0.50 0.71 cdfhilmrstw * elk02</span><br><span class="line">10.0.0.211 12 91 3 0.31 0.46 0.53 cdfhilmrstw - elk01</span><br><span class="line">10.0.0.213 43 90 3 0.27 0.61 0.89 cdfhilmrstw - elk03</span><br></pre></td></tr></table></figure><h2 id="kibana集成ES加密集群">kibana集成ES加密集群</h2><p><strong>1. 修改配置文件</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@elk01:2 ~]# vim /etc/kibana/kibana.yml </span><br><span class="line">···</span><br><span class="line">elasticsearch.username: <span class="string">&quot;kibana_system&quot;</span></span><br><span class="line">elasticsearch.password: <span class="string">&quot;BtaZLprbzzF1tYXSaCld&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#密码见上面生成的</span></span><br></pre></td></tr></table></figure><p>**2. 重启kibana服务 **</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@elk01:2 ~]#  systemctl restart kibana</span><br></pre></td></tr></table></figure><p><strong>3. 访问kibana的webUI登录</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">10.0.0.211:5601</span><br><span class="line"></span><br><span class="line">使用elastic用户登录</span><br></pre></td></tr></table></figure><p><img src="https://cos.lukme.top/Pic/image-20241027222304410.png" alt="image-20241027222304410"></p><p><img src="https://cos.lukme.top/Pic/image-20241027222417898.png" alt="image-20241027222417898"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 登录后如果没有出现右上角e标志，尝试清除缓存，或者使用无痕模式登录</span></span><br><span class="line">这里修改密码为   123456</span><br></pre></td></tr></table></figure><h2 id="filebeat写入ES加密集群">filebeat写入ES加密集群</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@elk01:2 ~]# <span class="built_in">cat</span> /etc/filebeat/19-tcp_es_secret.yaml </span><br><span class="line"><span class="comment"># 数据从监听的指定tcp端口来</span></span><br><span class="line">filebeat.inputs:</span><br><span class="line">- <span class="built_in">type</span>: tcp</span><br><span class="line">  host: <span class="string">&quot;0.0.0.0:9000&quot;</span></span><br><span class="line">  </span><br><span class="line"><span class="comment">#数据到终点</span></span><br><span class="line">output:</span><br><span class="line">  elasticsearch:</span><br><span class="line">    hosts:</span><br><span class="line">    - <span class="string">&quot;http://10.0.0.211:9200&quot;</span></span><br><span class="line">    - <span class="string">&quot;http://10.0.0.212:9200&quot;</span></span><br><span class="line">    - <span class="string">&quot;http://10.0.0.213:9200&quot;</span></span><br><span class="line">    index: <span class="string">&quot;linux-tcp-secret-%&#123;+yyyy.MM.dd&#125;&quot;</span></span><br><span class="line">    username: elastic</span><br><span class="line">    password: <span class="string">&quot;123456&quot;</span></span><br><span class="line"></span><br><span class="line">setup.ilm.enabled: <span class="literal">false</span></span><br><span class="line">setup.template.name: <span class="string">&quot;linux-tcp-secret&quot;</span></span><br><span class="line">setup.template.pattern: <span class="string">&quot;linux-tcp-secret*&quot;</span></span><br><span class="line">setup.template.overwrite: <span class="literal">false</span></span><br><span class="line">setup.template.settings:</span><br><span class="line">  index.number_of_shards: 5</span><br><span class="line">  index.number_of_replicas: 0</span><br><span class="line">  </span><br><span class="line"><span class="comment">#启动实例</span></span><br><span class="line">[root@elk01:2 ~]# filebeat -e -c /etc/filebeat/19-tcp_es_secret.yaml </span><br><span class="line"></span><br><span class="line"><span class="comment">#测试实例</span></span><br><span class="line">[root@elk01:2 ~]#  <span class="built_in">echo</span> 7890 |nc 10.0.0.211 9000</span><br></pre></td></tr></table></figure><p><img src="https://cos.lukme.top/Pic/image-20241027224350997.png" alt="image-20241027224350997"></p><p><strong>使用开发工具简单查看数据</strong></p><p><img src="https://cos.lukme.top/Pic/image-20241027224929276.png" alt="image-20241027224929276"></p><h2 id="logstash写入ES加密集群">logstash写入ES加密集群</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@elk01:1 ~]# <span class="built_in">cat</span> /etc/logstash/conf.d/16-tcp-es-secret.conf</span><br><span class="line">input &#123;</span><br><span class="line">  tcp &#123;</span><br><span class="line">    port =&gt; 8888</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">   elasticsearch&#123;</span><br><span class="line">      hosts =&gt; [<span class="string">&quot;10.0.0.211:9200&quot;</span>,<span class="string">&quot;10.0.0.212:9200&quot;</span>,<span class="string">&quot;10.0.0.213:9200&quot;</span>]</span><br><span class="line">      index =&gt; <span class="string">&quot;logstach-tcp-secret-%&#123;+yyyy.MM.dd&#125;&quot;</span></span><br><span class="line">      user =&gt; <span class="string">&quot;elastic&quot;</span></span><br><span class="line">      password =&gt; <span class="string">&quot;123456&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#启动实例</span></span><br><span class="line">[root@elk01:0 ~]# logstash -rf /etc/logstash/conf.d/16-tcp-es-secret.conf </span><br><span class="line"></span><br><span class="line"><span class="comment">#写入数据测试</span></span><br><span class="line">[root@elk02:0 ~]# <span class="built_in">echo</span> 666666 |nc 10.0.0.211 8888</span><br></pre></td></tr></table></figure><p><img src="https://cos.lukme.top/Pic/image-20241027225729785.png" alt="image-20241027225729785"></p><h2 id="角色访问">角色访问</h2><p><strong>创建角色，给开发或者运维不同权限</strong></p><p><img src="https://cos.lukme.top/Pic/image-20241027231430903.png" alt="image-20241027231430903"></p><p><img src="https://cos.lukme.top/Pic/image-20241027232332394.png" alt="image-20241027232332394"></p><p><img src="https://cos.lukme.top/Pic/image-20241027232500498.png" alt="image-20241027232500498"></p><p><strong>创建运维角色</strong></p><p><img src="https://cos.lukme.top/Pic/image-20241027232645991.png" alt="image-20241027232645991"></p><p><strong>还有kibana的权限选择all完事</strong>  <em><strong>图略</strong></em></p><p><strong>创建用户</strong></p><p><img src="https://cos.lukme.top/Pic/image-20241027232837646.png" alt="image-20241027232837646"></p><p><strong>登录李星星用户   权限确实少</strong></p><p><img src="https://cos.lukme.top/Pic/image-20241027233121133.png" alt="image-20241027233121133"></p>]]></content>
    
    
    <summary type="html">针对ES集群加密，设置权限访问</summary>
    
    
    
    <category term="ELK日志收集" scheme="https://lukme.top/categories/ELK%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86/"/>
    
    
    <category term="ELK" scheme="https://lukme.top/tags/ELK/"/>
    
  </entry>
  
</feed>
